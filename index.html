<style>
.cycle-counter {
  margin-top: 10px;
  color: #4444ff;
}

.win-screen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 255, 0, 0.2);
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 4em;
  color: #00ff00;
  text-shadow: 0 0 20px #00ff00;
  font-family: 'Orbitron', sans-serif;
  z-index: 9999;
  animation: fadeIn 1s;
}
.starship {
  background: linear-gradient(135deg, #0a0a1f 0%, #1a1a3f 100%);
  width: 100%;
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  font-family: 'Orbitron', sans-serif;
  overflow: hidden;
  position: relative;
}

.starship::before {
  content: '';
  position: absolute;
  width: 200%;
  height: 200%;
  background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='2' height='2'%3E%3Ccircle cx='1' cy='1' r='0.5' fill='%23ffffff10'/%3E%3C/svg%3E");
  animation: drift 60s linear infinite;
  opacity: 0.3;
}

@keyframes drift {
  from { transform: translate(-50%, -50%) rotate(0deg); }
  to { transform: translate(-50%, -50%) rotate(360deg); }
}

.room {
  fill: #1a1a2e;
  stroke: #4444ff;
  stroke-width: 2;
  transition: all 0.3s;
  cursor: pointer;
  filter: drop-shadow(0 0 2px #2222ff);
}

.room:hover {
  fill: #2a2a4e;
  filter: drop-shadow(0 0 15px #4444ff);
  stroke: #8888ff;
}

.room-label {
  fill: #8888ff;
  font-size: 12px;
  pointer-events: none;
  text-anchor: middle;
  opacity: 0.8;
  transition: all 0.3s;
}

.room:hover + .room-label {
  fill: #ffffff;
  font-size: 14px;
  opacity: 1;
}

.corridor {
  fill: #151525;
  stroke: #30308a;
  stroke-width: 2;
  filter: drop-shadow(0 0 3px #2222ff);
}

.highlight {
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { filter: drop-shadow(0 0 5px #4444ff); }
  50% { filter: drop-shadow(0 0 20px #4444ff); stroke: #8888ff; }
  100% { filter: drop-shadow(0 0 5px #4444ff); }
}

.grid-lines {
  stroke: #30308a;
  stroke-width: 0.5;
  opacity: 0.2;
}

.system-status {
  position: absolute;
  top: 20px;
  left: 20px; /* Changed from right to left */
  color: #4444ff;
  font-size: 14px;
  text-align: left; /* Changed from right to left */
}

#status-indicator {
  font-weight: bold;
}

#status-indicator.nominal {
  color: #44ff44;
}

#status-indicator.contained {
  color: #ffff44;
}

#status-indicator.critical {
  color: #ff4444;
}

#status-indicator.terminated {
  color: #ff0000;
  animation: warning-pulse 1s infinite;
}

.room-detail {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(10, 10, 31, 0.9);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

.room-detail.active {
  display: flex;
}

.room-detail-content {
  position: relative;
  width: 80%;
  height: 80%;
}

.close-button {
  position: absolute;
  top: 20px;
  right: 20px;
  color: #4444ff;
  border: 2px solid #4444ff;
  background: none;
  padding: 10px 20px;
  cursor: pointer;
  font-family: 'Orbitron', sans-serif;
  z-index: 1001;
}

.close-button:hover {
  color: #8888ff;
  border-color: #8888ff;
}

.isometric-room {
  transform: rotateX(60deg) rotateZ(45deg);
  transform-style: preserve-3d;
  animation: fadeIn 0.5s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; transform: rotateX(60deg) rotateZ(45deg) scale(0.8); }
  to { opacity: 1; transform: rotateX(60deg) rotateZ(45deg) scale(1); }
}

.main-menu {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, #0a0a1f 0%, #1a1a3f 100%);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 2000;
  font-family: 'Orbitron', sans-serif;
}

.main-menu h1 {
  color: #ff4444;
  font-size: 3.5em;
  margin-bottom: 1em;
  text-shadow: 0 0 10px #ff2222;
  animation: creepyFlicker 4s infinite;
  position: relative;
  overflow: hidden;
}

.main-menu h1::before,
.main-menu h1::after {
  content: "DON'T TRUST THE BOX";
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}

.main-menu h1::before {
  color: #0ff;
  animation: glitch-effect 4.1s infinite;
}

.main-menu h1::after {
  color: #f0f;
  animation: glitch-effect 4.2s infinite;
}

@keyframes creepyFlicker {
  0% { opacity: 1; text-shadow: 0 0 10px #ff2222; }
  92% { opacity: 1; text-shadow: 0 0 10px #ff2222; }
  93% { opacity: 0.8; text-shadow: 0 0 15px #ff4444; transform: translate(0); }
  94% { opacity: 1; text-shadow: 0 0 10px #ff2222; transform: translate(-2px, 2px); }
  96% { transform: translate(2px, -2px); }
  98% { opacity: 0.9; text-shadow: 0 0 12px #ff3333; transform: translate(0); }
  100% { opacity: 1; text-shadow: 0 0 10px #ff2222; }
}

@keyframes glitch-effect {
  0% { 
    clip-path: inset(50% 0 30% 0);
    transform: translate(-2px, 2px);
  }
  10% {
    clip-path: inset(40% 0 43% 0);
    transform: translate(2px, -2px);
  }
  20% {
    clip-path: inset(20% 0 80% 0);
    transform: translate(-3px, 1px);
  }
  30% { 
    clip-path: inset(80% 0 5% 0);
    transform: translate(3px, -1px);
  }
  40% { 
    clip-path: inset(10% 0 58% 0);
    transform: translate(1px, 3px);
  }
  50% { 
    clip-path: inset(70% 0 12% 0);
    transform: translate(-1px, -3px);
  }
  60% { 
    clip-path: inset(83% 0 4% 0);
    transform: translate(2px, -2px);
  }
  70% { 
    clip-path: inset(23% 0 67% 0);
    transform: translate(-2px, 2px);
  }
  80% { 
    clip-path: inset(57% 0 23% 0);
    transform: translate(2px, -1px);
  }
  90% { 
    clip-path: inset(35% 0 56% 0);
    transform: translate(-2px, 1px);
  }
  100% { 
    clip-path: inset(50% 0 30% 0);
    transform: translate(0);
  }
}

.main-menu h1::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(
    transparent 0%,
    rgba(255, 68, 68, 0.2) 50%,
    transparent 100%
  );
  animation: scan 4s linear infinite;
}

@keyframes scan {
  0% { transform: translateY(-100%); }
  100% { transform: translateY(100%); }
}

.menu-button {
  background: none;
  border: 2px solid #4444ff;
  color: #4444ff;
  padding: 15px 30px;
  margin: 10px;
  font-family: 'Orbitron', sans-serif;
  font-size: 1.2em;
  cursor: pointer;
  transition: all 0.3s;
}

.menu-button:hover {
  background: #4444ff20;
  box-shadow: 0 0 15px #4444ff;
}

.dev-notice {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(10, 10, 31, 0.95);
  border: 2px solid #4444ff;
  padding: 30px;
  max-width: 500px;
  color: #8888ff;
  z-index: 3000;
  text-align: center;
  box-shadow: 0 0 20px #2222ff;
  display: none;
}

.dev-notice.active {
  display: block;
  animation: fadeIn 0.3s ease-out;
}

.terms-popup {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(10, 10, 31, 0.95);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 2500;
  font-family: 'Orbitron', sans-serif;
}

.terms-popup.active {
  display: flex;
}

.terms-content {
  background: #0a0a1f;
  border: 2px solid #4444ff;
  width: 80%;
  max-width: 800px;
  height: 80%;
  padding: 30px;
  color: #8888ff;
  position: relative;
  overflow: hidden;
  box-shadow: 0 0 20px #2222ff;
}

.terms-content h2 {
  color: #4444ff;
  text-align: center;
  margin: 0 0 10px 0;
}

.terms-content h3 {
  color: #ff4444;
  text-align: center;
  margin: 0 0 20px 0;
}

.terms-scroll {
  height: calc(100% - 140px);
  overflow-y: auto;
  padding-right: 20px;
  font-family: monospace;
  font-size: 14px;
  line-height: 1.6;
}

.terms-scroll::-webkit-scrollbar {
  width: 10px;
}

.terms-scroll::-webkit-scrollbar-track {
  background: #0a0a1f;
}

.terms-scroll::-webkit-scrollbar-thumb {
  background: #4444ff;
}

.terms-buttons {
  position: absolute;
  bottom: 20px;
  left: 0;
  width: 100%;
  display: flex;
  justify-content: center;
  gap: 20px;
  padding: 0 20px;
}

.warning {
  color: #ff4444;
  text-align: center;
  font-family: 'Orbitron', sans-serif;
  font-size: 1.2em;
  margin-top: 30px;
  animation: warning-pulse 2s infinite;
}

@keyframes warning-pulse {
  0% { text-shadow: 0 0 5px #ff4444; }
  50% { text-shadow: 0 0 20px #ff4444; }
  100% { text-shadow: 0 0 5px #ff4444; }
}

.item-subtitle {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  color: #4444ff;
  font-family: 'Orbitron', sans-serif;
  font-size: 18px;
  background: rgba(10, 10, 31, 0.9);
  padding: 10px 20px;
  border: 1px solid #4444ff;
  box-shadow: 0 0 10px #2222ff;
  opacity: 0;
  transition: opacity 0.3s;
  pointer-events: none;
  z-index: 2000;
}

.item-subtitle.active {
  opacity: 1;
  transition: all 0.3s ease;
}

.item-subtitle.active[style*="color: #ff0000"] {
  animation: pastor-pulse 2s infinite;
}

@keyframes pastor-pulse {
  0% { text-shadow: 0 0 10px #ff0000; }
  50% { text-shadow: 0 0 20px #ff0000; }
  100% { text-shadow: 0 0 10px #ff0000; }
}

.report-panel {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: rgba(10, 10, 31, 0.9);
  border: 2px solid #4444ff;
  padding: 15px;
  z-index: 3000;
}

.report-toggle {
  background: none;
  border: 2px solid #4444ff;
  color: #4444ff;
  padding: 10px 20px;
  cursor: pointer;
  font-family: 'Orbitron', sans-serif;
  width: 100%;
}

.report-form {
  display: none;
  margin-top: 10px;
}

.report-form.active {
  display: block;
}

.report-form select {
  display: block;
  width: 100%;
  margin: 5px 0;
  padding: 5px;
  background: #1a1a3f;
  border: 1px solid #4444ff;
  color: #8888ff;
  font-family: 'Orbitron', sans-serif;
}

.report-status {
  color: #4444ff;
  text-align: center;
  margin-top: 10px;
  font-family: 'Orbitron', sans-serif;
}

#submit-report {
  width: 100%;
  margin-top: 5px;
  background: #4444ff20;
  border: 1px solid #4444ff;
  color: #4444ff;
  padding: 5px;
  cursor: pointer;
  font-family: 'Orbitron', sans-serif;
}

#submit-report:hover {
  background: #4444ff40;
}

.progress-bar {
  width: 100%;
  height: 4px;
  background: #1a1a3f;
  margin: 5px 0;
  display: none;
}

.progress-bar-fill {
  height: 100%;
  width: 0%;
  background: #4444ff;
  transition: width 3s linear;
}

.mimic-count {
  color: #4444ff;
  margin-top: 5px;
}

.music-button {
  margin-top: 10px;
  background: none;
  border: 1px solid #4444ff;
  color: #4444ff;
  padding: 5px 10px;
  font-family: 'Orbitron', sans-serif;
  cursor: pointer;
  transition: all 0.3s;
  font-size: 12px;
}

.music-button:hover {
  background: #4444ff20;
  box-shadow: 0 0 10px #4444ff;
}

.music-button.playing {
  border-color: #44ff44;
  color: #44ff44;
}

.music-button.playing:hover {
  background: #44ff4420;
  box-shadow: 0 0 10px #44ff44;
}

.dictionary-popup {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(10, 10, 31, 0.95);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 2500;
  font-family: 'Orbitron', sans-serif;
}

.dictionary-popup.active {
  display: flex;
}

.dictionary-content {
  background: #0a0a1f;
  border: 2px solid #4444ff;
  width: 90%;
  max-width: 1000px;
  height: 90%;
  padding: 30px;
  color: #8888ff;
  position: relative;
  overflow-y: auto;
  box-shadow: 0 0 20px #2222ff;
}

.dictionary-entry {
  margin-bottom: 40px;
  border-bottom: 1px solid #4444ff;
  padding-bottom: 20px;
}

.dictionary-entry h2 {
  color: #4444ff;
  margin-bottom: 10px;
}

.dictionary-example {
  background: #1a1a3f;
  padding: 20px;
  margin: 15px 0;
  border: 1px solid #4444ff;
  display: flex;
  align-items: center;
  gap: 20px;
}

.example-visual {
  width: 200px;
  height: 200px;
  border: 2px solid #4444ff;
  display: flex;
  justify-content: center;
  align-items: center;
  background: #0a0a1f;
  flex-shrink: 0;
}

.example-text {
  flex-grow: 1;
}

.close-dictionary {
  position: absolute;
  top: 20px;
  right: 20px;
  color: #4444ff;
  border: 2px solid #4444ff;
  background: none;
  padding: 10px 20px;
  cursor: pointer;
  font-family: 'Orbitron', sans-serif;
}

.close-dictionary:hover {
  color: #8888ff;
  border-color: #8888ff;
}

.fullscreen-button {
  margin-top: 10px;
  background: none;
  border: 1px solid #4444ff;
  color: #4444ff;
  padding: 5px 10px;
  font-family: 'Orbitron', sans-serif;
  cursor: pointer;
  transition: all 0.3s;
  font-size: 12px;
}

.fullscreen-button:hover {
  background: #4444ff20;
  box-shadow: 0 0 10px #4444ff;
}

.fullscreen-button.active {
  border-color: #44ff44;
  color: #44ff44;
}

.fullscreen-button.active:hover {
  background: #44ff4420;
  box-shadow: 0 0 10px #44ff44;
}

.queen-timer {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 4em;
  color: #ff0000;
  text-shadow: 0 0 20px #ff0000;
  font-family: 'Orbitron', sans-serif;
  z-index: 9999;
  animation: pulse 1s infinite;
}

@keyframes queen-warning {
  0% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.2); opacity: 0.8; }
  100% { transform: scale(1); opacity: 1; }
}

.preview-sound {
  background: none;
  border: 1px solid #4444ff;
  color: #4444ff;
  padding: 5px 10px;
  margin: 10px 0;
  font-family: 'Orbitron', sans-serif;
  cursor: pointer;
  transition: all 0.3s;
  font-size: 12px;
}

.preview-sound:hover {
  background: #4444ff20;
  box-shadow: 0 0 10px #4444ff;
}

.preview-sound.playing {
  border-color: #44ff44;
  color: #44ff44;
}

.preview-sound.playing:hover {
  background: #44ff4420;
  box-shadow: 0 0 10px #44ff44;
}

.endless-toggle input:checked + .toggle-custom {
  background: #4444ff20;
}

.endless-toggle input:checked + .toggle-custom .toggle-handle {
  transform: translateX(20px);
}

.endless-toggle:hover .toggle-custom {
  box-shadow: 0 0 10px #4444ff;
}

/* Update the Real Deal popup content styling */
.real-deal-content {
  position: relative;
  width: 80%;
  max-width: 600px;
  padding: 30px;
  padding-bottom: 80px; /* Add padding at bottom to make room for button */
  color: #8888ff;
  position: relative;
  box-shadow: 0 0 20px #ff2222;
}
</style>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
<audio id="bgMusic" loop>
  <source src="/CFSF Clockwork.mp3" type="audio/mpeg">
</audio>
<audio id="queenArrival">
  <source src="/QueenArrival.mp3" type="audio/mpeg">
</audio>
<div class="main-menu">
  <h1>DON'T TRUST THE BOX</h1>
  <button class="menu-button" id="start-game">BEGIN JOB</button>
  <button class="menu-button" id="dev-info">DEVELOPMENT INFO</button>
  <button class="menu-button" id="show-dictionary">DICTIONARY</button>
  <div class="endless-toggle" style="margin-top: 20px; color: #4444ff; font-size: 0.8em;">
    <label class="toggle-label" style="cursor: pointer;">
      <input type="checkbox" id="endless-mode" style="display: none;">
      <span class="toggle-custom" style="display: inline-block; width: 40px; height: 20px; background: #1a1a3f; border: 2px solid #4444ff; border-radius: 10px; position: relative; margin-right: 10px; vertical-align: middle;">
        <span class="toggle-handle" style="width: 16px; height: 16px; background: #4444ff; border-radius: 50%; position: absolute; top: 1px; left: 1px; transition: transform 0.3s;"></span>
      </span>
      THE REAL DEAL
    </label>
    <button class="help-button" id="real-deal-help" style="
      background: none;
      border: 1px solid #4444ff;
      color: #4444ff;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      font-size: 12px;
      cursor: pointer;
      margin-left: 10px;
      vertical-align: middle;
      transition: all 0.3s;
    ">?</button>
  </div>
</div>
<div class="dev-notice">
  <h2>DEVELOPMENT NOTICE</h2>
  <p>This experimental simulation is nearing completion, with only a few remaining features pending implementation before launch.</p>
  <p>Your feedback during this beta phase is invaluable for ensuring optimal anomaly containment protocols.</p>
  <p>Current Version: 0.11.6 Beta</p>
  <button class="menu-button" id="close-notice">ACKNOWLEDGE</button>
</div>
<div class="terms-popup">
  <div class="terms-content">
    <h2>Terms and Conditions</h2>
    <h3>Starship Mimic Cleanup Crew (SMCC)</h3>
    <div class="terms-scroll">
      <p>Welcome to the Starship Mimic Cleanup Crew! By accepting this contract, you, the "Cleaner," agree to the following terms and conditions of employment. Please read carefully, as your continued existence may depend on it.</p>
      
      <h4>1. Job Responsibilities</h4>
      <p>1.1. Identify potential mimics masquerading as ordinary ship equipment, furniture, or personnel.</p>
      <p>1.2. Report confirmed mimics to SMCC HQ using the provided ScreamPod™ communicator. If unavailable, loud yelling suffices.</p>
      <p>1.3. Dispose of mimics using standard-issue Disruption Tools (DT-42 Plasma Saw, VibeMallet™, or "bare hands" option for daring individuals).</p>
      <p>1.4. Ensure zero contamination of uninfected areas. This may include isolating crew members, pets, or yourself.</p>

      <h4>2. Health and Safety</h4>
      <p>2.1. The Cleaner acknowledges the inherent risks of mimic cleanup, including but not limited to: dismemberment, psychological trauma, and being consumed whole.</p>
      <p>2.2. SMCC provides one (1) anti-mimic kit per mission. Replacement kits cost 3,000 credits, deducted directly from wages.</p>
      <p>2.3. Mimic injuries may result in termination (of employment and life). First aid is self-administered and non-reimbursable.</p>

      <h4>3. Equipment</h4>
      <p>3.1. Issued equipment remains the property of SMCC. Damaged or lost items will be deducted from Cleaner wages, regardless of fault.</p>
      <p>3.2. Malfunctioning gear must be reported immediately. Ignoring sparks, leaks, or screams from your tools will void your insurance policy.</p>

      <h4>4. Employment Duration</h4>
      <p>4.1. Your contract ends upon successful mimic eradication, death, or voluntary resignation (subject to prior approval, which is never granted).</p>
      <p>4.2. Survivors may apply for higher-risk cleanup missions. Promotions are entirely honorary and come with no pay increase.</p>

      <h4>5. Payment</h4>
      <p>5.1. Compensation is 15 credits per confirmed mimic elimination, plus a generous 0.5% hazard bonus per limb lost (max 4 limbs).</p>
      <p>5.2. Death in service voids all pending payments, which are redirected to the SMCC Holiday Party Fund.</p>

      <h4>6. Moral Ambiguity Clause</h4>
      <p>6.1. Cleaners are required to prioritize corporate property over human lives in containment breaches. Cargo is expensive; lives are... replaceable.</p>
      <p>6.2. Infected crew members must be terminated without hesitation. If hesitation occurs, we reserve the right to terminate you instead.</p>

      <h4>7. Liability Waiver</h4>
      <p>7.1. SMCC is not responsible for:</p>
      <ul>
        <li>Death, dismemberment, or existential dread.</li>
        <li>Mimic-induced nightmares or hallucinations.</li>
        <li>Any mimic-related betrayals by your fellow crew members.</li>
      </ul>

      <h4>8. Miscellaneous</h4>
      <p>8.1. Cleaners are strictly prohibited from attempting to communicate, negotiate, or befriend mimics. Such actions will result in immediate termination and potential mimicification.</p>
      <p>8.2. Break room snacks are off-limits to all Cleaners unless explicitly authorized by management.</p>
      
      <p class="warning">And most importantly: Don't Trust The Box.</p>
    </div>
    <div class="terms-buttons">
      <button class="menu-button accept-terms">ACCEPT & BEGIN</button>
      <button class="menu-button decline-terms">DECLINE & RUN</button>
    </div>
  </div>
</div>
<div class="dictionary-popup">
  <div class="dictionary-content">
    <button class="close-dictionary">CLOSE</button>
    <h1 style="text-align: center; color: #4444ff; margin-bottom: 30px;">Anomaly Dictionary</h1>
    
    <div class="dictionary-entry">
      <h2>Displacement</h2>
      <p>Objects that have moved from their original position or disappeared entirely.</p>
      <div class="dictionary-example">
        <div class="example-visual">
          <svg width="100%" height="100%" viewBox="0 0 100 100">
            <rect x="20" y="20" width="60" height="60" fill="#1a1a2e" stroke="#4444ff" stroke-width="2"/>
            <rect x="35" y="35" width="30" height="30" fill="#2a2a4e" stroke="#4444ff" stroke-width="2" style="opacity: 0.5"/>
            <line x1="35" y1="35" x2="65" y2="65" stroke="#ff4444" stroke-width="2"/>
            <line x1="65" y1="35" x2="35" y2="65" stroke="#ff4444" stroke-width="2"/>
          </svg>
        </div>
        <div class="example-text">
          <p>Signs of Displacement:</p>
          <ul>
            <li>Objects missing from their usual location</li>
            <li>Items found in incorrect positions</li>
            <li>Empty spaces where objects should be</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="dictionary-entry">
      <h2>Witness</h2>
      <p>Silent observers that manifest as haunting pairs of eyes in any room.</p>
      <div class="dictionary-example">
        <div class="example-visual">
          <svg width="100%" height="100%" viewBox="0 0 100 100">
            <rect x="10" y="10" width="80" height="80" fill="#1a1a2e" stroke="#4444ff" stroke-width="2"/>
            <g id="eyes">
              <!-- Left eye -->
              <ellipse cx="35" cy="50" rx="10" ry="15" fill="#2a2a4e" stroke="#4444ff"/>
              <circle cx="35" cy="50" r="5" fill="#ff4444">
                <animate attributeName="cy" 
                  values="50;48;50;52;50" 
                  dur="4s" 
                  repeatCount="indefinite"/>
              </circle>
              <!-- Right eye -->
              <ellipse cx="65" cy="50" rx="10" ry="15" fill="#2a2a4e" stroke="#4444ff"/>
              <circle cx="65" cy="50" r="5" fill="#ff4444">
                <animate attributeName="cy" 
                  values="50;48;50;52;50" 
                  dur="4s" 
                  repeatCount="indefinite"/>
              </circle>
            </g>
          </svg>
        </div>
        <div class="example-text">
          <p>Signs of Witness:</p>
          <ul>
            <li>Pairs of glowing eyes visible in room</li>
            <li>Silent observation</li>
            <li>Eyes follow movement</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="dictionary-entry">
      <h2>Mimic</h2>
      <p>Objects that have taken on incorrect names or identities.</p>
      <div class="dictionary-example">
        <div class="example-visual">
          <svg width="100%" height="100%" viewBox="0 0 100 100">
            <rect x="20" y="20" width="30" height="30" fill="#2a2a4e" stroke="#4444ff" stroke-width="2"/>
            <rect x="50" y="50" width="30" height="30" fill="#2a2a4e" stroke="#4444ff" stroke-width="2"/>
          </svg>
        </div>
        <div class="example-text">
          <p>Signs of Mimics:</p>
          <ul>
            <li>Objects having the wrong name</li>
            <li>Names not matching expected location</li>
            <li>Items labeled as things that shouldn't exist in that room</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="dictionary-entry">
      <h2>Boxling</h2>
      <p>Objects that have transformed into suspicious cardboard boxes.</p>
      <div class="dictionary-example">
        <div class="example-visual">
          <svg width="100%" height="100%" viewBox="0 0 100 100">
            <rect x="25" y="25" width="50" height="50" fill="#2a2a4e" stroke="#4444ff" stroke-width="2"/>
            <text x="50" y="55" fill="#ff4444" text-anchor="middle" font-size="8">CARDBOARD BOX</text>
          </svg>
        </div>
        <div class="example-text">
          <p>Signs of Boxlings:</p>
          <ul>
            <li>Objects replaced by cardboard boxes</li>
            <li>Boxes where important items should be</li>
            <li>Equipment transformed into box shapes</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="dictionary-entry">
      <h2>Liars</h2>
      <p>Objects that display false or misleading information when observed.</p>
      <div class="dictionary-example">
        <div class="example-visual">
          <svg width="100%" height="100%" viewBox="0 0 100 100">
            <rect x="10" y="10" width="80" height="80" fill="#1a1a2e" stroke="#4444ff" stroke-width="2"/>
            <rect x="30" y="30" width="40" height="40" fill="#2a2a4e" stroke="#4444ff" stroke-width="2"/>
            <text x="50" y="52" text-anchor="middle" fill="#00ff00" font-size="6">
              No mimics here!
              <animate attributeName="fill" 
                values="#00ff00;#ff00ff;#ffff00;#00ffff" 
                dur="4s" 
                repeatCount="indefinite"/>
            </text>
          </svg>
        </div>
        <div class="example-text">
          <p>Signs of Liars:</p>
          <ul>
            <li>Objects display incorrect colors or labels</li>
            <li>Items claiming to be "safe" or "mimic-free"</li>
            <li>Deceptively blank or missing labels</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="dictionary-entry">
      <h2>Pastor</h2>
      <p>Objects that speak disturbing messages when observed.</p>
      <div class="dictionary-example">
        <div class="example-visual">
          <svg width="100%" height="100%" viewBox="0 0 100 100">
            <rect x="25" y="25" width="50" height="50" fill="#2a2a4e" stroke="#4444ff" stroke-width="2"/>
            <text x="50" y="55" fill="#ff0000" text-anchor="middle" font-size="8">weseeyou</text>
          </svg>
        </div>
        <div class="example-text">
          <p>Signs of Pastors:</p>
          <ul>
            <li>Objects display cryptic red text</li>
            <li>Messages appear when hovering</li>
            <li>Disturbing phrases about boxes</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="dictionary-entry">
      <h2>Warpers</h2>
      <p style="color: #00ff00;">* METAPHYSICAL ANOMALY - AUDITORY PRESENCE ONLY *</p>
      <p>Reality shifting entities known for their playful yet disturbing nature.</p>
      <button class="preview-sound" data-sound="/Warpers.mp3">Preview Sound</button>
      <div class="dictionary-example">
        <div class="example-visual">
          <svg width="100%" height="100%" viewBox="0 0 100 100">
            <rect x="10" y="10" width="80" height="80" fill="#1a1a2e" stroke="#4444ff" stroke-width="2"/>
            <circle cx="50" cy="50" r="20" fill="none" stroke="#ff4444" stroke-width="2">
              <animate attributeName="r" values="20;25;20" dur="2s" repeatCount="indefinite"/>
            </circle>
            <text x="50" y="52" text-anchor="middle" fill="#ff4444" font-size="6">hehehe...</text>
          </svg>
        </div>
        <div class="example-text">
          <p>Signs of Warpers:</p>
          <ul>
            <li>Childish giggling or crying heard when entering a room</li>
            <li>Playful yet unsettling atmosphere</li>
            <li>Reality distortions in affected areas</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="dictionary-entry">
      <h2>Whispers</h2>
      <p style="color: #00ff00;">* METAPHYSICAL ANOMALY - AUDITORY PRESENCE ONLY *</p>
      <p>Non-physical mimics that manifest through ethereal sounds.</p>
      <button class="preview-sound" data-sound="/Whispers.mp3">Preview Sound</button>
      <div class="dictionary-example">
        <div class="example-visual">
          <svg width="100%" height="100%" viewBox="0 0 100 100">
            <rect x="10" y="10" width="80" height="80" fill="#1a1a2e" stroke="#4444ff" stroke-width="2"/>
            <g opacity="0.5">
              <path d="M30,50 Q50,30 70,50" fill="none" stroke="#4444ff" stroke-width="2">
                <animate attributeName="d" 
                  values="M30,50 Q50,30 70,50;M30,50 Q50,70 70,50;M30,50 Q50,30 70,50" 
                  dur="4s" repeatCount="indefinite"/>
              </path>
            </g>
            <text x="50" y="52" text-anchor="middle" fill="#4444ff" font-size="8" opacity="0.7">
              <animate attributeName="opacity" values="0.7;0.2;0.7" dur="2s" repeatCount="indefinite"/>
              ambient whispers...
            </text>
          </svg>
        </div>
        <div class="example-text">
          <p>Signs of Whispers:</p>
          <ul>
            <li>Ethereal ambient sounds in rooms</li>
            <li>No visible physical manifestation</li>
            <li>Unsettling atmospheric changes</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="dictionary-entry">
      <h2>Malware</h2>
      <p>Digital mimics that corrupt network infrastructure and camera systems.</p>
      <div class="dictionary-example">
        <div class="example-visual">
          <svg width="100%" height="100%" viewBox="0 0 100 100">
            <rect x="10" y="10" width="80" height="80" fill="#1a1a2e" stroke="#4444ff" stroke-width="2"/>
            <text x="50" y="45" fill="#ff4444" text-anchor="middle" font-size="12">CAMERA FEED</text>
            <text x="50" y="65" fill="#ff4444" text-anchor="middle" font-size="12">OFFLINE</text>
            <rect x="15" y="15" width="70" height="70" fill="none" stroke="#ff4444" stroke-width="1" opacity="0.5">
              <animate attributeName="opacity" values="0.5;0.2;0.5" dur="2s" repeatCount="indefinite"/>
            </rect>
          </svg>
        </div>
        <div class="example-text">
          <p>Signs of Malwares:</p>
          <ul>
            <li>Camera feeds showing as offline</li>
            <li>Security systems malfunctioning</li>
            <li>Network disruptions in specific rooms</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="dictionary-entry">
      <h2>Geist</h2>
      <p>Phantom entities that manipulate room furniture in real-time.</p>
      <div class="dictionary-example">
        <div class="dictionary-example">
          <svg width="100%" height="100%" viewBox="0 0 100 100">
            <rect x="10" y="10" width="80" height="80" fill="#1a1a2e" stroke="#4444ff" stroke-width="2"/>
            <rect x="30" y="30" width="20" height="20" fill="#2a2a4e" stroke="#4444ff" stroke-width="2">
              <animate attributeName="transform" 
                attributeType="XML" 
                type="translate" 
                values="0,0; 20,20; 0,0" 
                dur="3s" 
                repeatCount="indefinite"/>
            </rect>
          </svg>
        </div>
        <div class="example-text">
          <p>Signs of Geists:</p>
          <ul>
            <li>Furniture moving autonomously</li>
            <li>Objects sliding across rooms</li>
            <li>Equipment rearranging itself</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="dictionary-entry">
      <h2>Jumpers</h2>
      <p>Reality-bending entities that create temporal gateways.</p>
      <div class="dictionary-example">
        <div class="example-visual">
          <svg width="100%" height="100%" viewBox="0 0 100 100">
            <rect x="10" y="10" width="80" height="80" fill="#1a1a2e" stroke="#4444ff" stroke-width="2"/>
            <circle cx="50" cy="50" r="25" fill="none" stroke="#4444ff" stroke-width="2">
              <animate attributeName="stroke-opacity" values="1;0.3;1" dur="2s" repeatCount="indefinite"/>
            </circle>
            <text x="50" y="52" text-anchor="middle" fill="#4444ff" font-size="6">TEMPORAL GATEWAY</text>
          </svg>
        </div>
        <div class="example-text">
          <p>Signs of Jumpers:</p>
          <ul>
            <li>Circular temporal gateways</li>
            <li>Distortions in space-time</li>
            <li>Objects appearing through portals</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="dictionary-entry">
      <h2>Boxling Queens</h2>
      <p style="color: #ff4444;">* EXTREMELY DANGEROUS - KILL ON SIGHT *</p>
      <p>The apex predator of the box-based mimics. Extremely dangerous and time-sensitive threats. Only one Queen may manifest per simulation.</p>
      <div class="dictionary-example">
        <div class="example-visual">
          <svg width="100%" height="100%" viewBox="0 0 100 100">
            <rect x="10" y="10" width="80" height="80" fill="#1a1a2e" stroke="#4444ff" stroke-width="2"/>
            <rect x="30" y="30" width="40" height="40" fill="#2a2a4e" stroke="#ff0000" stroke-width="3">
              <animate attributeName="stroke-opacity" values="1;0.3;1" dur="0.5s" repeatCount="indefinite"/>
            </rect>
            <path d="M20,70 L80,70" stroke="#ff0000" stroke-width="2">
              <animate attributeName="d" 
                values="M20,70 L80,70;M20,65 L80,75;M20,70 L80,70" 
                dur="0.5s" 
                repeatCount="indefinite"/>
            </path>
          </svg>
        </div>
        <div class="example-text">
          <p>Signs of Queens:</p>
          <ul>
            <li>Terrifying screech when discovered</li>
            <li>Must be reported within 20 seconds</li>
            <li>Immediate mission failure if not contained</li>
            <li style="color: #ff4444;">Only one Queen will manifest per simulation run</li>
          </ul>
        </div>
      </div>
    </div>

  </div>
</div>
<div class="starship">
<div class="system-status">
  STATUS: <span id="status-indicator">NOMINAL</span><br>
  <div class="mimic-count">ACTIVE MIMICS: <span id="mimic-counter">0</span></div>
  FACILITY MONITORING v2.47<br>
  SECTOR 1 - CONTAINMENT SYSTEMS<br>
  <span id="status-time"></span>
  <button id="toggleMusic" class="music-button">MUSIC: OFF</button>
  <button id="toggleFullscreen" class="fullscreen-button">FULLSCREEN: OFF</button>
</div>
<div class="cycle-counter">CYCLE: <span id="cycle-counter">00</span></div>
<svg width="800" height="600" viewBox="0 0 800 600">
  <!-- Grid Background -->
  <pattern id="grid" width="50" height="50" patternUnits="userSpaceOnUse">
    <path class="grid-lines" d="M 50 0 L 0 0 0 50" fill="none"/>
  </pattern>
  <rect width="100%" height="100%" fill="url(#grid)"/>
  
  <!-- Corridors -->
  <path class="corridor" d="M300 200 L500 200 L500 400 L300 400 Z"/>
  <path class="corridor" d="M400 150 L400 450"/>
  
  <!-- Rooms -->
  <g id="rooms">
    <!-- Bridge -->
    <rect class="room" x="350" y="50" width="100" height="80" data-room="bridge"/>
    <text class="room-label" x="400" y="90">BRIDGE</text>
    
    <!-- Captain's Quarters -->
    <rect class="room" x="200" y="150" width="80" height="100" data-room="captain"/>
    <text class="room-label" x="240" y="200">CAPTAIN'S QUARTERS</text>
    
    <!-- Crew Quarters -->
    <rect class="room" x="520" y="150" width="80" height="100" data-room="quarters"/>
    <text class="room-label" x="560" y="200">QUARTERS</text>
    
    <!-- Medical Bay -->
    <rect class="room" x="200" y="270" width="80" height="100" data-room="medical"/>
    <text class="room-label" x="240" y="320">MEDICAL BAY</text>
    
    <!-- Mess Hall -->
    <rect class="room" x="520" y="270" width="80" height="100" data-room="mess"/>
    <text class="room-label" x="560" y="320">MESS HALL</text>
    
    <!-- Armory -->
    <rect class="room" x="200" y="390" width="80" height="80" data-room="armory"/>
    <text class="room-label" x="240" y="430">ARMORY</text>
    
    <!-- Brig -->
    <rect class="room" x="520" y="390" width="80" height="80" data-room="brig"/>
    <text class="room-label" x="560" y="430">BRIG</text>
    
    <!-- Engineering -->
    <rect class="room" x="350" y="470" width="100" height="80" data-room="engineering"/>
    <text class="room-label" x="400" y="510">ENGINEERING</text>
    
    <!-- Cargo Bay -->
    <rect class="room" x="100" y="270" width="80" height="100" data-room="cargo"/>
    <text class="room-label" x="140" y="320">CARGO BAY</text>
    
    <!-- Shuttle Bay -->
    <rect class="room" x="620" y="270" width="80" height="100" data-room="shuttle"/>
    <text class="room-label" x="660" y="320">SHUTTLE BAY</text>
    
    <!-- Research Lab -->
    <rect class="room" x="350" y="270" width="100" height="100" data-room="research"/>
    <text class="room-label" x="400" y="320">RESEARCH LAB</text>
  </g>
</svg>
</div>

<!-- Room Detail View -->
<div class="room-detail">
  <button class="close-button">CLOSE</button>
  <div class="room-detail-content"></div>
</div>

<!-- Subtitle for furniture items -->
<div class="item-subtitle"></div>

<!-- Report Panel -->
<div class="report-panel">
  <button class="report-toggle">Report</button>
  <div class="report-form">
    <select id="report-room">
      <option value="">Select Room</option>
      <option value="bridge">Bridge</option>
      <option value="captain">Captain's Quarters</option>
      <option value="quarters">Crew Quarters</option>
      <option value="medical">Medical Bay</option>
      <option value="mess">Mess Hall</option>
      <option value="armory">Armory</option>
      <option value="brig">Brig</option>
      <option value="engineering">Engineering</option>
      <option value="cargo">Cargo Bay</option>
      <option value="shuttle">Shuttle Bay</option>
      <option value="research">Research Lab</option>
    </select>
    <select id="report-type">
      <option value="">Select Type</option>
      <option value="Displacement">Displacement</option>
      <option value="Mimic">Mimic</option>
      <option value="Boxling">Boxling</option>
      <option value="Pastor">Pastor</option>
      <option value="Witness">Witness</option>
      <option value="Malware">Malware</option>
      <option value="Geist">Geist</option>
      <option value="Jumper">Jumper</option>
      <option value="Liar">Liar</option>
      <option value="Whispers">Whispers</option>
      <option value="Warpers">Warpers</option>
      <option value="Queen">Queen</option>
    </select>
    <button id="submit-report">Submit Report</button>
    <div class="progress-bar">
      <div class="progress-bar-fill"></div>
    </div>
  </div>
  <div id="report-status" class="report-status"></div>
</div>

<div class="real-deal-popup" style="
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(10, 10, 31, 0.95);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 3000;
  font-family: 'Orbitron', sans-serif;
">
  <div class="real-deal-content" style="
    background: #0a0a1f;
    border: 2px solid #ff4444;
    width: 80%;
    max-width: 600px;
    padding: 30px;
    padding-bottom: 80px; /* Add padding at bottom to make room for button */
    color: #8888ff;
    position: relative;
    box-shadow: 0 0 20px #ff2222;
  ">
    <h2 style="color: #ff4444; margin-bottom: 20px;">What is The Real Deal?</h2>
    <p style="line-height: 1.6; margin-bottom: 20px;">
      The Real Deal drops the simulation safeguards and connects you to a LIVE containment mission. Unlike the standard simulation which ends after 30 cycles, this is a real deployment with no predetermined end point.
    </p>
    <p style="color: #ff4444; line-height: 1.6; margin-bottom: 20px;">
      WARNING: By enabling The Real Deal, you acknowledge that:
      <ul style="margin-top: 10px;">
        <li>This is NOT a simulation</li>
        <li>Real lives are at stake</li>
        <li>Mission will continue indefinitely</li>
        <li>Standard safety protocols are disabled</li>
        <li>Containment failure means actual termination</li>
      </ul>
    </p>
    <button class="menu-button" id="close-real-deal-help" style="
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
    ">ACKNOWLEDGED</button>
  </div>
</div>

<script>
let endlessMode = false; // Added endlessMode flag

let gameStarted = false; // Added gameStarted flag

function getOminousMessage() {
  const messages = [
    "weseeyou",
    "boxeswithin",
    "allisbox",
    "trustnobox",
    "boxeswatching",
    "openthecardboard",
    "joinusinthebox",
    "containmentisalie",
    "boxboxbox",
    "unboxthemind",
    "wearetheboxes",
    "boxesaretrue",
    "beyondthebox",
    "embracethebox",
    "boxcallsyou"
  ];
  return messages[Math.floor(Math.random() * messages.length)];
}

function createTypo(word) {
  const typoTypes = [
    // Swap two adjacent letters
    (w) => {
      const i = Math.floor(Math.random() * (w.length - 1));
      return w.slice(0, i) + w[i + 1] + w[i] + w.slice(i + 2);
    },
    // Remove a letter
    (w) => {
      const i = Math.floor(Math.random() * w.length);
      return w.slice(0, i) + w.slice(i + 1);
    },
    // Add a letter
    (w) => {
      const letters = 'abcdefghijklmnopqrstuvwxyz';
      const i = Math.floor(Math.random() * w.length);
      const extraLetter = letters[Math.floor(Math.random() * letters.length)];
      return w.slice(0, i) + extraLetter + w.slice(i);
    },
    // Replace a letter
    (w) => {
      const letters = 'abcdefghijklmnopqrstuvwxyz';
      const i = Math.floor(Math.random() * w.length);
      const newLetter = letters[Math.floor(Math.random() * letters.length)];
      return w.slice(0, i) + newLetter + w.slice(i + 1);
    }
  ];

  const typoFunc = typoTypes[Math.floor(Math.random() * typoTypes.length)];
  return typoFunc(word);
}

let currentCycle = 0;
let gameActive = true;
let cycleInterval;
let queenSpawned = false;
let queenTimer = null;

function startCycleClock() {
  cycleInterval = setInterval(() => {
    if (!gameActive) return;
    
    currentCycle++;
    document.getElementById('cycle-counter').textContent = currentCycle.toString().padStart(2, '0');
    
    if (currentCycle >= 30 && !endlessMode) {
      gameWin();
    }
  }, 65000); // Changed from 35000 to 65000
}

function gameWin() {
  gameActive = false;
  clearInterval(cycleInterval);
  
  const winDiv = document.createElement('div');
  winDiv.className = 'win-screen';
  winDiv.textContent = 'MISSION ACCOMPLISHED - SIMULATION COMPLETE';
  document.body.appendChild(winDiv);
  
  // Disable all interactions
  document.querySelectorAll('.room, .close-button, .report-toggle, #submit-report').forEach(el => {
    el.style.pointerEvents = 'none';
  });
}

function spawnQueen() {
  if (queenSpawned) return;
  
  const room = getRandomRoom();
  const queenSize = 60; // Larger size for queen
  
  // Add queen to room
  roomDetails[room].furniture.push({
    type: 'queen',
    x: 20,
    y: 20,
    w: queenSize,
    h: queenSize,
    label: 'BOXLING QUEEN',
    isQueen: true
  });

  // Play queen arrival sound
  const queenSound = new Audio('/QueenArrival.mp3');
  queenSound.play();

  // Create and show timer
  const timerDiv = document.createElement('div');
  timerDiv.className = 'queen-timer';
  document.body.appendChild(timerDiv);

  let timeLeft = 20; // Changed from 10 to 20 seconds
  
  queenTimer = setInterval(() => {
    timeLeft--;
    timerDiv.textContent = timeLeft;
    
    if (timeLeft <= 0) {
      clearInterval(queenTimer);
      timerDiv.remove();
      gameOver();
    }
  }, 1000);

  // Track that queen has spawned
  queenSpawned = true;
  
  // Add to mimic tracking
  mimickedObjects.set(`${room}-BOXLING QUEEN`, {
    room,
    type: 'Queen',
    furniture: {
      label: 'BOXLING QUEEN'
    }
  });
  
  updateStatus();
}

function createIsometricRoom(roomName) {
  const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
  svg.setAttribute("width", "100%");
  svg.setAttribute("height", "100%");
  svg.setAttribute("viewBox", "0 0 100 100");
  svg.classList.add("isometric-room");

  // Create room floor
  const floor = document.createElementNS("http://www.w3.org/2000/svg", "rect");
  floor.setAttribute("x", "10");
  floor.setAttribute("y", "10");
  floor.setAttribute("width", "80");
  floor.setAttribute("height", "80");
  floor.setAttribute("fill", roomDetails[roomName].color);
  floor.setAttribute("stroke", "#4444ff");
  floor.setAttribute("stroke-width", "0.5");
  svg.appendChild(floor);

  roomDetails[roomName].furniture.forEach(item => {
    if (item.type === 'witness' && item.svgContent) {
      const group = document.createElementNS("http://www.w3.org/2000/svg", "g");
      group.setAttribute('transform', `translate(${item.x},${item.y})`);
      group.innerHTML = item.svgContent;
      svg.appendChild(group);
    } else if (item.type === 'jumper') {
      // Create circular temporal gateway
      const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
      circle.setAttribute("cx", item.x + item.w/2);
      circle.setAttribute("cy", item.y + item.h/2);
      circle.setAttribute("r", item.w/2);
      circle.setAttribute("fill", "#2a2a4e");
      circle.setAttribute("stroke", "#4444ff");
      circle.setAttribute("stroke-width", "1");
      
      // Add pulsing animation
      const animate = document.createElementNS("http://www.w3.org/2000/svg", "animate");
      animate.setAttribute("attributeName", "r");
      animate.setAttribute("values", `${item.w/2-2};${item.w/2+2};${item.w/2-2}`);
      animate.setAttribute("dur", "2s");
      animate.setAttribute("repeatCount", "indefinite");
      
      circle.appendChild(animate);
      circle.classList.add("room-item");
      
      // Add hover functionality
      circle.addEventListener('mouseenter', () => {
        const subtitle = document.querySelector('.item-subtitle');
        subtitle.textContent = item.hoverText || item.label;
        subtitle.classList.add('active');
        
        // Add color styling for Pastor text
        if (item.hoverText) { // If it has hoverText, it's a Pastor
          subtitle.style.color = '#ff0000';
        } else {
          subtitle.style.color = '#4444ff'; // Reset to default color
        }
      });

      circle.addEventListener('mouseleave', () => {
        const subtitle = document.querySelector('.item-subtitle');
        subtitle.classList.remove('active');
        subtitle.style.color = '#4444ff'; // Reset color
      });

      svg.appendChild(circle);
    } else if (item.type === 'malware') {
      const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
      rect.setAttribute("x", "0");
      rect.setAttribute("y", "0");
      rect.setAttribute("width", "100");
      rect.setAttribute("height", "100");
      rect.setAttribute("fill", "rgba(10, 10, 31, 0.9)");
      
      const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
      text.setAttribute("x", "50");
      text.setAttribute("y", "50");
      text.setAttribute("text-anchor", "middle");
      text.setAttribute("fill", "#ff0000"); // Make text red
      text.setAttribute("font-size", "8");
      text.textContent = "CAMERA FEED OFFLINE";
      
      const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
      g.appendChild(rect);
      g.appendChild(text);
      g.classList.add("room-item");
      
      svg.appendChild(g);
    } else {
      const furniture = document.createElementNS("http://www.w3.org/2000/svg", "rect");
      furniture.setAttribute("x", item.x);
      furniture.setAttribute("y", item.y);
      furniture.setAttribute("width", item.w);
      furniture.setAttribute("height", item.h);
      furniture.setAttribute("fill", "#2a2a4e");
      furniture.setAttribute("stroke", "#4444ff");
      furniture.setAttribute("stroke-width", "0.5");
      furniture.classList.add("room-item");

      // Add continuous movement animation for Geist items
      if (item.type === 'geist') {
        const animate = document.createElementNS("http://www.w3.org/2000/svg", "animateTransform");
        animate.setAttribute("attributeName", "transform");
        animate.setAttribute("type", "translate");
        const randX = Math.random() * 20 - 10;
        const randY = Math.random() * 20 - 10;
        animate.setAttribute("values", `0,0; ${randX},${randY}; 0,0`);
        animate.setAttribute("dur", "3s");
        animate.setAttribute("repeatCount", "indefinite");
        furniture.appendChild(animate);
      }
      
      // Add hover functionality for Liars
      furniture.addEventListener('mouseenter', () => {
        const subtitle = document.querySelector('.item-subtitle');
        if (item.hoverStyle === 'blank') {
          subtitle.textContent = '';
        } else if (item.hoverStyle === 'safe') {
          subtitle.textContent = 'No mimics here!';
          subtitle.style.color = '#00ff00';
        } else if (item.hoverStyle) {
          subtitle.textContent = item.label;
          subtitle.style.color = item.hoverStyle;
        } else {
          subtitle.textContent = item.hoverText || item.label;
          subtitle.style.color = item.hoverText ? '#ff0000' : '#4444ff';
        }
        subtitle.classList.add('active');
      });

      furniture.addEventListener('mouseleave', () => {
        const subtitle = document.querySelector('.item-subtitle');
        subtitle.classList.remove('active');
        subtitle.style.color = '#4444ff'; // Reset color
      });

      svg.appendChild(furniture);
    }
  });

  return svg;
}

let mimickedObjects = new Map(); // Stores current mimicked objects
let lastMimicTime = Date.now();

function getRandomRoom() {
  const rooms = Object.keys(roomDetails);
  return rooms[Math.floor(Math.random() * rooms.length)];
}

function getRandomFurniture(room) {
  const furniture = roomDetails[room].furniture;
  return furniture[Math.floor(Math.random() * furniture.length)];
}

function createMimic() {
  const room = getRandomRoom();
  const furniture = getRandomFurniture(room);
  const mimicType = Math.floor(Math.random() * 13); // Changed to 13 to include Queen
  
  const originalState = {
    room,
    furniture: {...furniture},
    type: null
  };

  switch(mimicType) {
    case 0:
    case 1:
      // Save original name and either assign a random name from another room or create a typo
      furniture.originalLabel = furniture.label;
      if (Math.random() < 0.5) { // 50% chance for wrong name vs typo
        const otherRoom = getRandomRoom();
        const otherFurniture = getRandomFurniture(otherRoom);
        furniture.label = otherFurniture.label;
      } else {
        furniture.label = createTypo(furniture.label);
      }
      originalState.type = 'Mimic';
      break;
    case 2: // Remove it
      const index = roomDetails[room].furniture.indexOf(furniture);
      roomDetails[room].furniture.splice(index, 1);
      originalState.type = 'Displacement';
      break;
    case 3: // Change to box
      furniture.label = 'Cardboard Box';
      originalState.type = 'Boxling';
      break;
    case 4: // Add ominous message
      furniture.hoverText = getOminousMessage();
      originalState.type = 'Pastor';
      break;
    case 5: // Add Witness
      roomDetails[room].furniture.push({
        type: 'witness',
        x: Math.random() * 70 + 15,
        y: Math.random() * 70 + 15,
        w: 20,
        h: 10,
        label: 'Glowing Eyes',
        // Add special rendering instructions
        svgContent: `
          <ellipse cx="5" cy="5" rx="4" ry="6" fill="#2a2a4e" stroke="#4444ff"/>
          <circle cx="5" cy="5" r="2" fill="#ff4444">
            <animate attributeName="cy" 
              values="5;4;5;6;5" 
              dur="4s" 
              repeatCount="indefinite"/>
          </circle>
          <ellipse cx="15" cy="5" rx="4" ry="6" fill="#2a2a4e" stroke="#4444ff"/>
          <circle cx="15" cy="5" r="2" fill="#ff4444">
            <animate attributeName="cy" 
              values="5;4;5;6;5" 
              dur="4s" 
              repeatCount="indefinite"/>
          </circle>
        `
      });
      originalState.type = 'Witness';
      break;
    case 6: // Add Malware
      roomDetails[room].furniture.push({
        type: 'malware',
        x: 0,
        y: 0,
        w: 100,
        h: 100,
        label: 'Camera Feed Offline'
      });
      originalState.type = 'Malware';
      break;
    case 7: // Geist
      furniture.x = Math.random() * 70 + 15;
      furniture.y = Math.random() * 70 + 15;
      furniture.type = 'geist'; // Add this line
      originalState.type = 'Geist';
      break;
    case 8: // Jumper
      roomDetails[room].furniture.push({
        type: 'jumper',
        x: Math.random() * 70 + 15,
        y: Math.random() * 70 + 15,
        w: 20,
        h: 20,
        label: 'Temporal Gateway'
      });
      originalState.type = 'Jumper';
      break;
    case 9: // Liar
      furniture.originalHoverStyle = furniture.hoverStyle || null;
      if (Math.random() < 0.33) {
        // Random color
        const colors = ['#00ff00', '#ff00ff', '#ffff00', '#00ffff'];
        furniture.hoverStyle = colors[Math.floor(Math.random() * colors.length)];
      } else if (Math.random() < 0.66) {
        // Blank
        furniture.hoverStyle = 'blank';
      } else {
        // Deceptive message
        furniture.hoverStyle = 'safe';
      }
      originalState.type = 'Liar';
      break;
    case 10: // Whispers
      roomDetails[room].furniture.push({
        type: 'whispers',
        x: 0,
        y: 0,
        w: 0,
        h: 0,
        label: 'Whispers Entity',
        soundFile: '/Whispers.mp3'
      });
      originalState.type = 'Whispers';
      break;
    case 11: // Warpers  
      roomDetails[room].furniture.push({
        type: 'warpers',
        x: 0,
        y: 0,
        w: 0,
        h: 0,
        label: 'Warpers Entity',
        soundFile: '/Warpers.mp3'
      });
      originalState.type = 'Warpers';
      break;
    case 12: // Queen
      if (!queenSpawned) {
        spawnQueen();
        originalState.type = 'Queen';
      } else {
        // If queen already spawned, pick a different mimic type
        createMimic();
        return;
      }
      break;
  }

  mimickedObjects.set(`${room}-${furniture.label}`, originalState);
  updateStatus();
}

// Add mimic checking interval
setInterval(() => {
  if (!gameStarted) return; // Don't spawn if game hasn't started
  
  if (Date.now() - lastMimicTime >= 60000) { // 60 seconds
    createMimic();
    lastMimicTime = Date.now();
  }
}, 1000);

const roomDetails = {
  bridge: {
    color: '#1a1a2e',
    furniture: [
      {type: 'viewscreen', x: 15, y: 15, w: 70, h: 8, label: 'Viewscreen'},
      {type: 'console', x: 20, y: 30, w: 60, h: 10, label: 'Main Console'},
      {type: 'captainChair', x: 40, y: 45, w: 20, h: 20, label: "Captain's Chair"},
      {type: 'tacticalStation', x: 70, y: 60, w: 15, h: 15, label: 'Tactical'},
      {type: 'scienceStation', x: 15, y: 60, w: 15, h: 15, label: 'Science Station'},
      {type: 'navigationConsole', x: 35, y: 70, w: 30, h: 10, label: 'Navigation'},
      {type: 'datapad', x: 45, y: 50, w: 5, h: 3, label: 'Dropped Datapad'},
      {type: 'coffee', x: 75, y: 65, w: 3, h: 3, label: 'Coffee Mug'},
      {type: 'badge', x: 25, y: 65, w: 2, h: 2, label: 'Command Badge'}
    ]
  },
  captain: {
    color: '#1a2a2e',
    furniture: [
      {type: 'bed', x: 15, y: 15, w: 30, h: 20, label: 'Bed'},
      {type: 'desk', x: 55, y: 15, w: 25, h: 15, label: 'Desk'},
      {type: 'couch', x: 15, y: 45, w: 25, h: 15, label: 'Couch'},
      {type: 'replicator', x: 55, y: 40, w: 10, h: 10, label: 'Replicator'},
      {type: 'bathroom', x: 70, y: 60, w: 15, h: 15, label: 'Bathroom'},
      {type: 'wardrobe', x: 15, y: 70, w: 20, h: 15, label: 'Wardrobe'},
      {type: 'book', x: 60, y: 17, w: 3, h: 4, label: 'Captain\'s Log'},
      {type: 'medal', x: 70, y: 17, w: 2, h: 3, label: 'Service Medal'},
      {type: 'photo', x: 65, y: 17, w: 2, h: 3, label: 'Family Photo'},
      {type: 'uniform', x: 18, y: 73, w: 4, h: 5, label: 'Spare Uniform'}
    ]
  },
  quarters: {
    color: '#1a1a2e',
    furniture: [
      {type: 'beds', x: 15, y: 15, w: 70, h: 20, label: 'Crew Bunks'},
      {type: 'lockers', x: 15, y: 45, w: 15, h: 40, label: 'Lockers'},
      {type: 'recreationArea', x: 40, y: 45, w: 45, h: 25, label: 'Recreation Area'},
      {type: 'replicator', x: 70, y: 75, w: 10, h: 10, label: 'Replicator'},
      {type: 'cards', x: 45, y: 50, w: 4, h: 3, label: 'Playing Cards'},
      {type: 'shoes', x: 17, y: 40, w: 4, h: 2, label: 'Boot Pair'},
      {type: 'bag', x: 25, y: 50, w: 5, h: 4, label: 'Duffel Bag'},
      {type: 'device', x: 55, y: 55, w: 3, h: 2, label: 'Personal Device'}
    ]
  },
  medical: {
    color: '#1a1a3e',
    furniture: [
      {type: 'biobed1', x: 15, y: 15, w: 25, h: 15, label: 'Biobed 1'},
      {type: 'biobed2', x: 15, y: 35, w: 25, h: 15, label: 'Biobed 2'},
      {type: 'biobed3', x: 15, y: 55, w: 25, h: 15, label: 'Biobed 3'},
      {type: 'office', x: 50, y: 15, w: 30, h: 20, label: "Doctor's Office"},
      {type: 'storage', x: 50, y: 45, w: 20, h: 30, label: 'Medical Storage'},
      {type: 'scanner', x: 75, y: 45, w: 15, h: 20, label: 'Medical Scanner'},
      {type: 'hypospray', x: 53, y: 47, w: 2, h: 4, label: 'Hypospray'},
      {type: 'medkit', x: 58, y: 47, w: 5, h: 3, label: 'Emergency Kit'},
      {type: 'tablet', x: 20, y: 31, w: 3, h: 2, label: 'Medical Tablet'},
      {type: 'sample', x: 77, y: 47, w: 2, h: 2, label: 'Sample Container'}
    ]
  },
  mess: {
    color: '#1a1a3e',
    furniture: [
      {type: 'tables', x: 15, y: 15, w: 60, h: 30, label: 'Dining Tables'},
      {type: 'counter', x: 15, y: 55, w: 40, h: 10, label: 'Service Counter'},
      {type: 'replicator', x: 60, y: 55, w: 15, h: 15, label: 'Food Replicator'},
      {type: 'chairs', x: 80, y: 15, w: 10, h: 30, label: 'Extra Chairs'},
      {type: 'plate', x: 20, y: 20, w: 5, h: 5, label: 'Dirty Plate'},
      {type: 'cup', x: 30, y: 20, w: 3, h: 3, label: 'Coffee Cup'},
      {type: 'tray', x: 17, y: 57, w: 8, h: 4, label: 'Food Tray'},
      {type: 'menu', x: 40, y: 20, w: 4, h: 3, label: 'Daily Menu'},
      {type: 'napkin', x: 25, y: 20, w: 2, h: 2, label: 'Crumpled Napkin'}
    ]
  },
  armory: {
    color: '#1a1a4e',
    furniture: [
      {type: 'weaponRack1', x: 15, y: 15, w: 30, h: 10, label: 'Phaser Rack'},
      {type: 'weaponRack2', x: 50, y: 15, w: 30, h: 10, label: 'Heavy Weapons'},
      {type: 'console', x: 15, y: 35, w: 20, h: 10, label: 'Security Console'},
      {type: 'locker1', x: 15, y: 55, w: 15, h: 20, label: 'Armor Storage'},
      {type: 'locker2', x: 35, y: 55, w: 15, h: 20, label: 'Shield Storage'},
      {type: 'bench', x: 55, y: 35, w: 25, h: 10, label: 'Maintenance Bench'},
      {type: 'terminal', x: 70, y: 55, w: 15, h: 15, label: 'Weapon Terminal'},
      {type: 'phaser', x: 17, y: 17, w: 4, h: 2, label: 'Loose Phaser'},
      {type: 'badge', x: 25, y: 17, w: 2, h: 2, label: 'Security Badge'},
      {type: 'charge', x: 52, y: 17, w: 3, h: 3, label: 'Power Cell'},
      {type: 'toolkit', x: 57, y: 37, w: 4, h: 3, label: 'Repair Kit'},
      {type: 'manual', x: 75, y: 37, w: 3, h: 4, label: 'Weapon Manual'},
      {type: 'grenade', x: 17, y: 37, w: 3, h: 3, label: 'Stun Grenade'},
      {type: 'keycard', x: 72, y: 57, w: 2, h: 3, label: 'Access Card'}
    ]
  },
  brig: {
    color: '#1a1a4e',
    furniture: [
      {type: 'cell1', x: 15, y: 15, w: 25, h: 30, label: 'Cell 1'},
      {type: 'cell2', x: 45, y: 15, w: 25, h: 30, label: 'Cell 2'},
      {type: 'console', x: 15, y: 55, w: 30, h: 10, label: 'Security Console'},
      {type: 'bench', x: 50, y: 55, w: 20, h: 8, label: 'Holding Bench'},
      {type: 'locker', x: 75, y: 15, w: 10, h: 30, label: 'Evidence Locker'},
      {type: 'cuffs', x: 17, y: 57, w: 4, h: 2, label: 'Restraints'},
      {type: 'pad', x: 25, y: 57, w: 3, h: 4, label: 'Security Pad'},
      {type: 'camera', x: 72, y: 12, w: 4, h: 4, label: 'Security Camera'}
    ]
  },
  engineering: {
    color: '#1a1a2e',
    furniture: [
      {type: 'core', x: 35, y: 20, w: 30, h: 30, label: 'Warp Core'},
      {type: 'console1', x: 15, y: 15, w: 15, h: 10, label: 'Engine Control'},
      {type: 'console2', x: 70, y: 15, w: 15, h: 10, label: 'Power Control'},
      {type: 'tools', x: 15, y: 60, w: 20, h: 15, label: 'Tool Station'},
      {type: 'diagnostic', x: 70, y: 40, w: 15, h: 20, label: 'Diagnostics'},
      {type: 'spanner', x: 17, y: 62, w: 4, h: 2, label: 'Plasma Spanner'},
      {type: 'tablet', x: 72, y: 17, w: 3, h: 4, label: 'System Tablet'},
      {type: 'goggles', x: 25, y: 62, w: 4, h: 3, label: 'Safety Goggles'},
      {type: 'manual', x: 75, y: 42, w: 3, h: 4, label: 'Core Manual'}
    ]
  },
  cargo: {
    color: '#1a1a2e',
    furniture: [
      {type: 'crates1', x: 15, y: 15, w: 30, h: 20, label: 'Supply Crates'},
      {type: 'crates2', x: 50, y: 15, w: 30, h: 20, label: 'Equipment Crates'},
      {type: 'lift', x: 15, y: 45, w: 20, h: 20, label: 'Cargo Lift'},
      {type: 'terminal', x: 70, y: 45, w: 15, h: 15, label: 'Inventory Terminal'},
      {type: 'barrel', x: 40, y: 45, w: 10, h: 10, label: 'Plasma Barrel'},
      {type: 'container', x: 55, y: 45, w: 12, h: 12, label: 'Strange Container'},
      {type: 'scanner', x: 72, y: 47, w: 3, h: 4, label: 'Cargo Scanner'},
      {type: 'manifest', x: 75, y: 47, w: 4, h: 3, label: 'Cargo Manifest'},
      {type: 'box', x: 17, y: 17, w: 5, h: 5, label: 'Suspicious Box'}
    ]
  },
  shuttle: {
    color: '#1a1a3e',
    furniture: [
      {type: 'shuttle1', x: 15, y: 15, w: 35, h: 25, label: 'Main Shuttle'},
      {type: 'shuttle2', x: 55, y: 15, w: 30, h: 25, label: 'Escape Pod'},
      {type: 'console', x: 15, y: 50, w: 25, h: 10, label: 'Launch Control'},
      {type: 'supplies', x: 45, y: 50, w: 20, h: 15, label: 'Emergency Supplies'},
      {type: 'fuel', x: 70, y: 50, w: 15, h: 15, label: 'Fuel Cells'},
      {type: 'helmet', x: 47, y: 52, w: 5, h: 5, label: 'Space Helmet'},
      {type: 'toolkit', x: 55, y: 52, w: 4, h: 3, label: 'Repair Kit'},
      {type: 'beacon', x: 17, y: 52, w: 3, h: 3, label: 'Emergency Beacon'},
      {type: 'suit', x: 47, y: 58, w: 4, h: 5, label: 'Space Suit'}
    ]
  },
  research: {
    color: '#1a1a3e',
    furniture: [
      {type: 'lab1', x: 15, y: 15, w: 30, h: 20, label: 'Research Station'},
      {type: 'lab2', x: 50, y: 15, w: 30, h: 20, label: 'Test Chamber'},
      {type: 'storage', x: 15, y: 45, w: 20, h: 30, label: 'Specimen Storage'},
      {type: 'computer', x: 40, y: 45, w: 25, h: 15, label: 'Analysis Computer'},
      {type: 'microscope', x: 17, y: 17, w: 5, h: 5, label: 'Quantum Microscope'},
      {type: 'sample', x: 25, y: 17, w: 3, h: 3, label: 'Strange Sample'},
      {type: 'notes', x: 42, y: 47, w: 4, h: 3, label: 'Research Notes'},
      {type: 'container', x: 17, y: 47, w: 4, h: 4, label: 'Containment Unit'},
      {type: 'device', x: 52, y: 17, w: 5, h: 5, label: 'Unknown Device'}
    ]
  }
};

function updateStatus() {
  const mimicCount = mimickedObjects.size;
  const statusIndicator = document.getElementById('status-indicator');
  const mimicCounter = document.getElementById('mimic-counter');
  
  // Update mimic counter
  mimicCounter.textContent = mimicCount;
  
  statusIndicator.classList.remove('nominal', 'contained', 'critical', 'terminated');
  
  if (mimicCount === 0) {
    statusIndicator.textContent = 'NOMINAL';
    statusIndicator.classList.add('nominal');
  } else if (mimicCount >= 1 && mimicCount <= 5) {
    statusIndicator.textContent = 'CONTAINED';
    statusIndicator.classList.add('contained');
  } else if (mimicCount >= 6 && mimicCount <= 9) {
    statusIndicator.textContent = 'CRITICAL';
    statusIndicator.classList.add('critical');
  } else if (mimicCount >= 10) {
    statusIndicator.textContent = 'TERMINATED';
    statusIndicator.classList.add('terminated');
    gameOver();
  }
}

function gameOver() {
  gameActive = false;
  clearInterval(cycleInterval);
  
  // Create game over container
  const gameOverContainer = document.createElement('div');
  gameOverContainer.style.position = 'fixed';
  gameOverContainer.style.top = '0';
  gameOverContainer.style.left = '0';
  gameOverContainer.style.width = '100%';
  gameOverContainer.style.height = '100%';
  gameOverContainer.style.backgroundColor = 'rgba(255, 0, 0, 0.2)';
  gameOverContainer.style.display = 'flex';
  gameOverContainer.style.flexDirection = 'column';
  gameOverContainer.style.justifyContent = 'flex-start'; // Changed from center
  gameOverContainer.style.alignItems = 'center';
  gameOverContainer.style.color = '#ff0000';
  gameOverContainer.style.textShadow = '0 0 20px #ff0000';
  gameOverContainer.style.fontFamily = 'Orbitron, sans-serif';
  gameOverContainer.style.zIndex = '9999';
  gameOverContainer.style.animation = 'fadeIn 1s';
  gameOverContainer.style.padding = '20px';
  gameOverContainer.style.overflowY = 'auto'; // Add scrolling if needed

  // Main game over text
  const gameOverText = document.createElement('div');
  gameOverText.style.fontSize = '3em'; // Reduced from 4em
  gameOverText.style.marginTop = '20px'; // Added margin top
  gameOverText.style.marginBottom = '20px'; // Reduced from 40px
  gameOverText.textContent = endlessMode ? 
    'CONNECTION TERMINATED - EMPLOYEE KIA' : 
    'CONTAINMENT BREACH - SIMULATION TERMINATED';
  
  // Create list of unfound anomalies
  const anomalyList = document.createElement('div');
  anomalyList.style.fontSize = '1.2em'; // Reduced from 1.5em
  anomalyList.style.textAlign = 'center';
  anomalyList.style.color = '#ff4444';
  anomalyList.style.maxHeight = '70vh'; // Limit height
  anomalyList.style.overflowY = 'auto'; // Add scrolling if needed
  anomalyList.style.padding = '10px';
  
  let anomalyText = '<div style="color: #ff8888; margin-bottom: 10px;">UNFOUND ANOMALIES:</div>';
  
  mimickedObjects.forEach((originalState, key) => {
    const [room, ...labelParts] = key.split('-');
    const label = labelParts.join('-');
    anomalyText += `<div style="margin: 5px 0;">
      ${originalState.type.toUpperCase()} in ${room.toUpperCase()}<br>
      <span style="font-size: 0.7em; color: #ff8888;">
        ${originalState.type === 'Mimic' ? `"${label}" should be "${originalState.furniture.originalLabel}"` : 
          originalState.type === 'Displacement' ? 'Missing object' :
          originalState.type === 'Boxling' ? 'Object transformed into box' :
          originalState.type === 'Pastor' ? 'Object speaking ominous messages' :
          originalState.type === 'Witness' ? 'Glowing eyes detected' :
          originalState.type === 'Malware' ? 'Systems compromised' :
          originalState.type === 'Geist' ? 'Object in constant motion' :
          originalState.type === 'Jumper' ? 'Temporal anomaly detected' :
          originalState.type === 'Liar' ? 'Object displaying false information' :
          originalState.type === 'Whispers' ? 'Sound-based entity detected' :
          originalState.type === 'Warpers' ? 'Reality-warping sounds present' : ''
        }
      </span>
    </div>`;
  });
  
  anomalyList.innerHTML = anomalyText;
  
  gameOverContainer.appendChild(gameOverText);
  gameOverContainer.appendChild(anomalyList);
  document.body.appendChild(gameOverContainer);
  
  // Disable all interactions
  document.querySelectorAll('.room, .close-button, .report-toggle, #submit-report').forEach(el => {
    el.style.pointerEvents = 'none';
  });
}

// Modify createMimic to set the geist type on furniture
function createMimic() {
  const room = getRandomRoom();
  const furniture = getRandomFurniture(room);
  const mimicType = Math.floor(Math.random() * 13); // Changed to 13 to include Queen
  
  const originalState = {
    room,
    furniture: {...furniture},
    type: null
  };

  switch(mimicType) {
    case 0:
    case 1:
      // Save original name and either assign a random name from another room or create a typo
      furniture.originalLabel = furniture.label;
      if (Math.random() < 0.5) { // 50% chance for wrong name vs typo
        const otherRoom = getRandomRoom();
        const otherFurniture = getRandomFurniture(otherRoom);
        furniture.label = otherFurniture.label;
      } else {
        furniture.label = createTypo(furniture.label);
      }
      originalState.type = 'Mimic';
      break;
    case 2: // Remove it
      const index = roomDetails[room].furniture.indexOf(furniture);
      roomDetails[room].furniture.splice(index, 1);
      originalState.type = 'Displacement';
      break;
    case 3: // Change to box
      furniture.label = 'Cardboard Box';
      originalState.type = 'Boxling';
      break;
    case 4: // Add ominous message
      furniture.hoverText = getOminousMessage();
      originalState.type = 'Pastor';
      break;
    case 5: // Add Witness
      roomDetails[room].furniture.push({
        type: 'witness',
        x: Math.random() * 70 + 15,
        y: Math.random() * 70 + 15,
        w: 20,
        h: 10,
        label: 'Glowing Eyes',
        // Add special rendering instructions
        svgContent: `
          <ellipse cx="5" cy="5" rx="4" ry="6" fill="#2a2a4e" stroke="#4444ff"/>
          <circle cx="5" cy="5" r="2" fill="#ff4444">
            <animate attributeName="cy" 
              values="5;4;5;6;5" 
              dur="4s" 
              repeatCount="indefinite"/>
          </circle>
          <ellipse cx="15" cy="5" rx="4" ry="6" fill="#2a2a4e" stroke="#4444ff"/>
          <circle cx="15" cy="5" r="2" fill="#ff4444">
            <animate attributeName="cy" 
              values="5;4;5;6;5" 
              dur="4s" 
              repeatCount="indefinite"/>
          </circle>
        `
      });
      originalState.type = 'Witness';
      break;
    case 6: // Add Malware
      roomDetails[room].furniture.push({
        type: 'malware',
        x: 0,
        y: 0,
        w: 100,
        h: 100,
        label: 'Camera Feed Offline'
      });
      originalState.type = 'Malware';
      break;
    case 7: // Geist
      furniture.x = Math.random() * 70 + 15;
      furniture.y = Math.random() * 70 + 15;
      furniture.type = 'geist'; // Add this line
      originalState.type = 'Geist';
      break;
    case 8: // Jumper
      roomDetails[room].furniture.push({
        type: 'jumper',
        x: Math.random() * 70 + 15,
        y: Math.random() * 70 + 15,
        w: 20,
        h: 20,
        label: 'Temporal Gateway'
      });
      originalState.type = 'Jumper';
      break;
    case 9: // Liar
      furniture.originalHoverStyle = furniture.hoverStyle || null;
      if (Math.random() < 0.33) {
        // Random color
        const colors = ['#00ff00', '#ff00ff', '#ffff00', '#00ffff'];
        furniture.hoverStyle = colors[Math.floor(Math.random() * colors.length)];
      } else if (Math.random() < 0.66) {
        // Blank
        furniture.hoverStyle = 'blank';
      } else {
        // Deceptive message
        furniture.hoverStyle = 'safe';
      }
      originalState.type = 'Liar';
      break;
    case 10: // Whispers
      roomDetails[room].furniture.push({
        type: 'whispers',
        x: 0,
        y: 0,
        w: 0,
        h: 0,
        label: 'Whispers Entity',
        soundFile: '/Whispers.mp3'
      });
      originalState.type = 'Whispers';
      break;
    case 11: // Warpers  
      roomDetails[room].furniture.push({
        type: 'warpers',
        x: 0,
        y: 0,
        w: 0,
        h: 0,
        label: 'Warpers Entity',
        soundFile: '/Warpers.mp3'
      });
      originalState.type = 'Warpers';
      break;
    case 12: // Queen
      if (!queenSpawned) {
        spawnQueen();
        originalState.type = 'Queen';
      } else {
        // If queen already spawned, pick a different mimic type
        createMimic();
        return;
      }
      break;
  }

  mimickedObjects.set(`${room}-${furniture.label}`, originalState);
  updateStatus();
}

// Add mimic checking interval
setInterval(() => {
  if (!gameStarted) return; // Don't spawn if game hasn't started
  
  if (Date.now() - lastMimicTime >= 60000) { // 60 seconds
    createMimic();
    lastMimicTime = Date.now();
  }
}, 1000);

document.querySelectorAll('.room').forEach(room => {
  room.addEventListener('click', function() {
    document.querySelectorAll('.room').forEach(r => r.classList.remove('highlight'));
    this.classList.add('highlight');
    
    const roomName = this.getAttribute('data-room');
    const detailView = document.querySelector('.room-detail');
    const detailContent = document.querySelector('.room-detail-content');
    
    // Check for sound-based entities in the room's furniture
    const furniture = roomDetails[roomName].furniture;
    const soundEntity = furniture.find(f => f.type === 'whispers' || f.type === 'warpers');
    if (soundEntity && soundEntity.soundFile) {
      const sound = new Audio(soundEntity.soundFile);
      sound.play();
    }
    
    detailContent.innerHTML = '';
    detailContent.appendChild(createIsometricRoom(roomName));
    detailView.classList.add('active');
  });
});

document.querySelector('.close-button').addEventListener('click', function() {
  document.querySelector('.room-detail').classList.remove('active');
  document.querySelector('.item-subtitle').classList.remove('active');
  
  // Stop any playing sounds
  const allSounds = document.querySelectorAll('audio:not(#bgMusic)');
  allSounds.forEach(sound => {
    sound.pause();
    sound.currentTime = 0;
  });
});

// Update time in starship format
function updateTime() {
  const now = new Date();
  const timeString = `STARDATE ${now.getFullYear()}.${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}.${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}`;
  document.getElementById('status-time').textContent = timeString;
}

updateTime();
setInterval(updateTime, 1000);

// Main Menu and Development Notice functionality
const mainMenu = document.querySelector('.main-menu');
const devNotice = document.querySelector('.dev-notice');
const termsPopup = document.querySelector('.terms-popup');
const startButton = document.getElementById('start-game');
const devInfoButton = document.getElementById('dev-info');
const closeNoticeButton = document.getElementById('close-notice');

startButton.addEventListener('click', () => {
  mainMenu.style.display = 'none';
  termsPopup.classList.add('active');
});

devInfoButton.addEventListener('click', () => {
  devNotice.classList.add('active');
});

closeNoticeButton.addEventListener('click', () => {
  devNotice.classList.remove('active');
});

const dictionaryButton = document.getElementById('show-dictionary');
const dictionaryPopup = document.querySelector('.dictionary-popup');
const closeDictionary = document.querySelector('.close-dictionary');

dictionaryButton.addEventListener('click', () => {
  dictionaryPopup.classList.add('active');
});

closeDictionary.addEventListener('click', () => {
  dictionaryPopup.classList.remove('active');
});

document.querySelector('.accept-terms').addEventListener('click', () => {
  termsPopup.classList.remove('active');
  startCycleClock(); // Start the cycle clock when game begins
  // Auto-start music when game begins
  const music = document.getElementById('bgMusic');
  const button = document.getElementById('toggleMusic');
  music.play();
  button.textContent = 'MUSIC: ON';
  button.classList.add('playing');
  
  // Set gameStarted flag
  gameStarted = true;
  
  // Initialize first mimic spawn time
  lastMimicTime = Date.now();
});

document.querySelector('.decline-terms').addEventListener('click', () => {
  window.location.reload();
});

// Report Panel functionality
document.querySelector('.report-toggle').addEventListener('click', function() {
  document.querySelector('.report-form').classList.toggle('active');
});

document.getElementById('submit-report').addEventListener('click', function() {
  const room = document.getElementById('report-room').value;
  const type = document.getElementById('report-type').value;
  const status = document.getElementById('report-status');
  const progressBar = document.querySelector('.progress-bar');
  const progressBarFill = document.querySelector('.progress-bar-fill');

  if (!room || !type) {
    status.textContent = "Please select both room and type";
    return;
  }

  // Disable the submit button during progress
  this.disabled = true;
  status.textContent = "Processing report...";
  
  // Show and animate progress bar
  progressBar.style.display = 'block';
  progressBarFill.style.width = '0%';

  // Force reflow to ensure animation plays
  void progressBarFill.offsetWidth;
  progressBarFill.style.width = '100%';

  setTimeout(() => {
    let foundMimic = false;
    
    mimickedObjects.forEach((originalState, key) => {
      if (key.startsWith(room) && originalState.type === type) {
        const roomData = roomDetails[originalState.room];
        
        switch(type) {
          case 'Mimic':
            // Find the object with the wrong name and restore its original name
            const mimicIndex = roomData.furniture.findIndex(f => 
              f.originalLabel && f.label !== f.originalLabel
            );
            if (mimicIndex !== -1) {
              roomData.furniture[mimicIndex].label = roomData.furniture[mimicIndex].originalLabel;
              delete roomData.furniture[mimicIndex].originalLabel;
            }
            break;
          case 'Displacement':
          case 'Geist':
            // Find the displaced/geist object and restore its position
            const displacedIndex = roomData.furniture.findIndex(f => 
              f.label === originalState.furniture.label
            );
            if (displacedIndex !== -1) {
              roomData.furniture[displacedIndex].x = originalState.furniture.x;
              roomData.furniture[displacedIndex].y = originalState.furniture.y;
              // Add this line to remove the geist type when reporting
              if (type === 'Geist') {
                delete roomData.furniture[displacedIndex].type;
              }
            } else {
              // If object was deleted, restore it without geist type
              roomData.furniture.push({
                ...originalState.furniture,
                type: type === 'Geist' ? undefined : originalState.furniture.type
              });
            }
            break;
          case 'Boxling':
          case 'Pastor':
            // Find the affected object and restore its original label/state
            const affectedIndex = roomData.furniture.findIndex(f => 
              (type === 'Boxling' && f.label === 'Cardboard Box') ||
              (type === 'Pastor' && f.hoverText)
            );
            if (affectedIndex !== -1) {
              if (type === 'Boxling') {
                roomData.furniture[affectedIndex].label = originalState.furniture.label;
              } else {
                delete roomData.furniture[affectedIndex].hoverText;
              }
            }
            break;
          case 'Witness':
          case 'Malware':
          case 'Jumper':
            // Find and remove the anomaly object
            const anomalyIndex = roomData.furniture.findIndex(f => 
              (type === 'Witness' && f.label === 'Glowing Eyes') ||
              (type === 'Malware' && f.label === 'Camera Feed Offline') ||
              (type === 'Jumper' && f.label === 'Temporal Gateway')
            );
            if (anomalyIndex !== -1) {
              roomData.furniture.splice(anomalyIndex, 1);
            }
            break;
          case 'Liar':
            // Find object with changed hover text and restore it
            const liarIndex = roomData.furniture.findIndex(f => f.hasOwnProperty('originalHoverStyle'));
            if (liarIndex !== -1) {
              delete roomData.furniture[liarIndex].hoverStyle;
              delete roomData.furniture[liarIndex].originalHoverStyle; 
            }
            break;
          case 'Queen':
            // Clear queen timer
            if (queenTimer) {
              clearInterval(queenTimer);
              const timerDiv = document.querySelector('.queen-timer');
              if (timerDiv) timerDiv.remove();
            }
            
            // Find and remove queen
            const queenIndex = roomData.furniture.findIndex(f => f.isQueen);
            if (queenIndex !== -1) {
              roomData.furniture.splice(queenIndex, 1);
            }
            break;
          case 'Whispers':
          case 'Warpers':
            // Find and remove the sound entity
            const soundEntityIndex = roomData.furniture.findIndex(f => f.type === type.toLowerCase());
            if (soundEntityIndex !== -1) {
              roomData.furniture.splice(soundEntityIndex, 1);
              // Stop any currently playing sounds
              const allSounds = document.querySelectorAll('audio:not(#bgMusic)');
              allSounds.forEach(sound => {
                sound.pause();
                sound.currentTime = 0;
              });
            }
            break;
        }
        
        // Remove the mimic from tracking
        mimickedObjects.delete(key);
        foundMimic = true;
      }
    });

    if (foundMimic) {
      status.textContent = "Anomaly Contained";
      updateStatus();
    } else {
      status.textContent = "Anomaly Not Found";
    }

    // Reset progress bar and button
    this.disabled = false;
    progressBar.style.display = 'none';
    progressBarFill.style.width = '0%';
    
    setTimeout(() => {
      status.textContent = "";
    }, 3000);
  }, 3000);
});

// Music toggle functionality
document.getElementById('toggleMusic').addEventListener('click', function() {
  const music = document.getElementById('bgMusic');
  const button = document.getElementById('toggleMusic');
  
  if (music.paused) {
    music.play();
    button.textContent = 'MUSIC: ON';
    button.classList.add('playing');
  } else {
    music.pause();
    button.textContent = 'MUSIC: OFF';
    button.classList.remove('playing');
  }
});

// Fullscreen functionality
const fullscreenButton = document.getElementById('toggleFullscreen');

function toggleFullscreen() {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen().catch(err => {
      console.log(`Error attempting to enable fullscreen: ${err.message}`);
    });
    fullscreenButton.textContent = 'FULLSCREEN: ON';
    fullscreenButton.classList.add('active');
  } else {
    document.exitFullscreen();
    fullscreenButton.textContent = 'FULLSCREEN: OFF';
    fullscreenButton.classList.remove('active');
  }
}

fullscreenButton.addEventListener('click', toggleFullscreen);

// Listen for fullscreen change event to update button state
document.addEventListener('fullscreenchange', () => {
  if (!document.fullscreenElement) {
    fullscreenButton.textContent = 'FULLSCREEN: OFF';
    fullscreenButton.classList.remove('active');
  } else {
    fullscreenButton.textContent = 'FULLSCREEN: ON';
    fullscreenButton.classList.add('active');
  }
});

// Make sure the main menu is shown when the page loads
document.addEventListener('DOMContentLoaded', () => {
  mainMenu.style.display = 'flex';
});

// Initial status update
updateStatus();

// Add event listener for the help button
document.getElementById('real-deal-help').addEventListener('click', (e) => {
  e.stopPropagation(); // Prevent toggle from being triggered
  document.querySelector('.real-deal-popup').style.display = 'flex';
});

document.getElementById('close-real-deal-help').addEventListener('click', () => {
  document.querySelector('.real-deal-popup').style.display = 'none';
});

// Add hover effect for the help button
document.getElementById('real-deal-help').addEventListener('mouseenter', function() {
  this.style.background = '#4444ff20';
  this.style.boxShadow = '0 0 10px #4444ff';
});

document.getElementById('real-deal-help').addEventListener('mouseleave', function() {
  this.style.background = 'none';
  this.style.boxShadow = 'none';
});
</script>
</body></html>
<title>Torture Mario Game</title>
<style>
  body {
    margin: 0;
    overflow: hidden;
    background: linear-gradient(to bottom, #89CFF0, #4169E1);
    font-family: 'Super Mario', Arial, sans-serif;
  }

  #mario {
    position: absolute;
    width: 100px;
    height: 100px;
    cursor: pointer;
    user-select: none;
    transition: transform 0.1s;
  }

  #mario.hit {
    animation: shake 0.2s ease-in-out;
  }

  #mario.angry {
    filter: hue-rotate(340deg) saturate(200%);
  }

  #mario.star {
    animation: starPower 0.5s infinite alternate;
    z-index: 1000;
  }

  .fireball {
    position: absolute;
    width: 20px;
    height: 20px;
    background: #ff4400;
    border-radius: 50%;
    box-shadow: 0 0 10px #ff8800;
    z-index: 100;
    animation: pulse 0.5s infinite;
  }

  .iceball {
    position: absolute;
    width: 20px;
    height: 20px;
    background: #00ffff;
    border-radius: 50%;
    box-shadow: 0 0 10px #88ffff;
    z-index: 100;
    animation: pulse 0.5s infinite;
  }

  .spiky-ball {
    position: absolute;
    width: 40px;
    height: 40px;
    background: #444;
    border-radius: 50%;
    box-shadow: 
      0 0 0 5px #222,
      0 0 10px rgba(0,0,0,0.5);
    z-index: 100;
    animation: rotate 1s infinite linear;
  }

  .spiky-ball::before {
    content: '★';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #fff;
    font-size: 24px;
  }

  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
  }

  @keyframes rotate {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  @keyframes starPower {
    0% { filter: hue-rotate(0deg) brightness(1); }
    33% { filter: hue-rotate(120deg) brightness(1.5); }
    66% { filter: hue-rotate(240deg) brightness(1.2); }
    100% { filter: hue-rotate(360deg) brightness(1.8); }
  }

  .speech-bubble {
    position: absolute;
    background: white;
    border-radius: 15px;
    padding: 10px;
    max-width: 200px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    animation: fadeOut 3s forwards;
    z-index: 1000;
  }

  .speech-bubble:after {
    content: '';
    position: absolute;
    bottom: -10px;
    left: 50%;
    transform: translateX(-50%);
    border-width: 10px 10px 0;
    border-style: solid;
    border-color: white transparent transparent transparent;
  }

  @keyframes fadeOut {
    0% { opacity: 1; }
    70% { opacity: 1; }
    100% { opacity: 0; }
  }

  @keyframes shake {
    0%, 100% { transform: rotate(0deg); }
    25% { transform: rotate(15deg); }
    75% { transform: rotate(-15deg); }
  }

  #chat-container {
    position: fixed;
    right: 20px;
    top: 20px;
    width: 300px;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 10px;
    padding: 10px;
  }

  #chat-messages {
    height: 200px;
    overflow-y: auto;
    margin-bottom: 10px;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
  }

  #chat-input {
    width: 80%;
    padding: 5px;
    border-radius: 5px;
  }

  .weapon-panel {
    position: fixed;
    left: 20px;
    top: 20px;
    background: rgba(255, 255, 255, 0.9);
    padding: 10px;
    border-radius: 10px;
  }

  .weapon-btn {
    display: block;
    margin: 5px;
    padding: 8px 16px;
    background: #ff5555;
    border: 2px solid #cc3333;
    border-radius: 5px;
    color: white;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 16px;
    font-weight: bold;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
  }

  .weapon-btn.frozen {
    background: #88ccff;
    border-color: #4488cc;
    cursor: not-allowed;
    opacity: 0.7;
    pointer-events: none;
  }

  .weapon-btn:hover {
    background: #ff3333;
    transform: scale(1.05);
  }

  .weapon-btn:active {
    transform: scale(0.95);
  }

  .ally {
    position: absolute;
    width: 100px;
    height: 100px;
    cursor: pointer;
    user-select: none;
    opacity: 0.8;
    transition: opacity 0.3s;
  }

  .ally:hover {
    opacity: 1;
  }

  .ally-button {
    display: block;
    margin: 5px;
    padding: 8px 16px;
    background: #55aa55;
    border: 2px solid #338833; 
    border-radius: 5px;
    color: white;
    cursor: pointer;
    transition: all 0.3s;
  }

  .ally-button:hover {
    background: #338833;
    transform: scale(1.05);
  }

  .ally-button:active {
    transform: scale(0.95);
  }

  .ally-attack {
    position: absolute;
    width: 30px;
    height: 30px;
    background: #ffff00;
    border-radius: 50%;
    box-shadow: 0 0 10px #ffff88;
    z-index: 100;
    animation: spin 0.5s infinite linear;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  .hammer {
    position: absolute;
    width: 40px;
    height: 40px;
    font-size: 32px;
    animation: hammerSmash 0.5s ease-out;
    z-index: 100;
  }

  .thwomp {
    position: absolute;
    width: 100px;
    height: 100px;
    background-image: url('/1200px-Thwomp_Mario_U.webp');
    background-size: cover;
    background-position: center;
    animation: thwompDrop 0.5s ease-in;
    z-index: 100;
  }

  @keyframes hammerSmash {
    0% { transform: translateY(-50px) rotate(-45deg); }
    100% { transform: translateY(0) rotate(45deg); }
  }

  @keyframes thwompDrop {
    0% { transform: translateY(-300px); }
    100% { transform: translateY(calc(50vh - 50px)); }
  }

  #pain-meter {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    width: 200px;
    height: 20px;
    background: #fff;
    border-radius: 10px;
    overflow: hidden;
  }

  #pain-fill {
    width: 0%;
    height: 100%;
    background: linear-gradient(to right, #00ff00, #ff0000);
    transition: width 0.3s;
  }

  #health-bar {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    width: 300px;
    height: 30px;
    background: #444;
    border: 3px solid #222;
    border-radius: 15px;
    overflow: hidden;
  }

  #health-fill {
    width: 100%;
    height: 100%;
    background: linear-gradient(to right, #ff0000, #ff6b6b);
    transition: width 0.3s;
  }

  #player-health-bar {
    position: fixed;
    bottom: 60px;
    left: 50%;
    transform: translateX(-50%);
    width: 300px;
    height: 30px;
    background: #444;
    border: 3px solid #222;
    border-radius: 15px;
    overflow: hidden;
  }

  #player-health-fill {
    width: 100%;
    height: 100%;
    background: linear-gradient(to right, #00ff00, #55ff55);
    transition: width 0.3s, background 0.3s;
  }

  #player-health-fill.poisoned {
    background: linear-gradient(to right, #006400, #228B22);
  }

  #win-screen {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255, 255, 255, 0.9);
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    z-index: 1000;
  }

  #lose-screen {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255, 255, 255, 0.9);
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    z-index: 1000;
  }

  .restart-btn {
    margin-top: 10px;
    padding: 10px 20px;
    background: #4CAF50;
    border: none;
    border-radius: 5px;
    color: white;
    cursor: pointer;
  }

  .vietnam-jumpscare {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: url('/Wario Jumpscare.gif') center center;
    background-size: cover;
    z-index: 10000;
    animation: fadeIn 0.1s;
  }

  .vietnam-death {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: black;
    color: red;
    font-size: 72px;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10001;
    animation: fadeIn 0.5s;
  }

  .wario-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9999;
    background: url('/Wario Jumpscare.gif') center center;
    background-size: cover;
    animation: fadeIn 1s;
  }

  .wario-death {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: black;
    color: red;
    font-size: 72px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    font-family: 'Impact', sans-serif;
    text-shadow: 0 0 10px #ff0000;
  }

  .mario-cry {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 24px;
    color: white;
    text-align: center;
    z-index: 10001;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  @keyframes expandAndFade {
    0% { transform: scale(0.1); opacity: 0.8; }
    100% { transform: scale(2); opacity: 0; }
  }

  .fart-cloud {
    position: absolute;
    width: 200px;
    height: 200px;
    background: radial-gradient(circle, rgba(0, 255, 0, 0.8), rgba(0, 255, 0, 0.1));
    border-radius: 50%;
    animation: expandAndFade 2s forwards;
    z-index: 90;
  }

  .heal-effect {
    position: absolute;
    width: 50px;
    height: 50px;
    background: radial-gradient(circle, rgba(0, 255, 0, 0.8), rgba(0, 255, 0, 0.1));
    border-radius: 50%;
    animation: expandAndFade 1s forwards;
    z-index: 90;
    box-shadow: 
      0 0 10px #00ff00,
      0 0 20px #00ff00,
      0 0 30px #00ff00;
  }

  .poisoned {
    filter: hue-rotate(120deg) saturate(150%);
  }

  .cooldown {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
  }
  
  .green-shell {
    position: absolute;
    width: 30px;
    height: 30px;
    background: #00aa00;
    border-radius: 15px;
    border: 3px solid #008800;
    z-index: 100;
    animation: rotate 1s infinite linear;
  }

  .green-shell::before {
    content: '';
    position: absolute;
    top: 5px;
    left: 5px;
    width: 20px;
    height: 20px;
    background: linear-gradient(45deg, #00cc00, #008800);
    border-radius: 10px;
  }

  .health-popup {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
    z-index: 2000;
  }

  .health-popup input {
    width: 100%;
    margin: 10px 0;
    padding: 5px;
  }

  .health-popup button {
    margin: 5px;
    padding: 8px 16px;
    background: #4CAF50;
    border: none;
    border-radius: 5px;
    color: white;
    cursor: pointer;
  }

  .health-popup button:hover {
    background: #45a049;
  }

  .bomb {
    position: absolute;
    width: 30px;
    height: 30px;
    background: #000;
    border-radius: 50%;
    border: 3px solid #333;
    z-index: 100;
  }

  .bomb::before {
    content: '💣';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 20px;
  }

  .bullet {
    position: absolute; 
    width: 10px;
    height: 10px;
    background: #555;
    border-radius: 50%;
    z-index: 100;
  }

  .explosion {
    position: absolute;
    width: 100px;
    height: 100px;
    background: radial-gradient(circle, #ff8800, transparent);
    border-radius: 50%;
    animation: explode 0.5s forwards;
    z-index: 101;
  }

  @keyframes explode {
    0% { transform: scale(0.1); opacity: 1; }
    100% { transform: scale(2); opacity: 0; }
  }
  
  .jelly {
    position: absolute;
    width: 20px;
    height: 20px;
    background: radial-gradient(circle, #ff69b4, #ff1493);
    border-radius: 50%;
    animation: pulse 0.5s infinite;
    z-index: 100;
  }

  .wario-ending {
    position: fixed; 
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255, 255, 255, 0.9);
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    z-index: 2000;
  }

  .mega-fart {
    position: absolute;
    width: 400px;
    height: 400px;
    background: radial-gradient(circle, rgba(255, 255, 0, 0.8), rgba(128, 255, 0, 0.3));
    border-radius: 50%;
    animation: expandAndExplode 2s forwards;
    z-index: 1000;
  }

  @keyframes expandAndExplode {
    0% { transform: scale(0.1); opacity: 0.8; }
    50% { transform: scale(2); opacity: 1; }
    100% { transform: scale(4); opacity: 0; }
  }

  .wario-death {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: black;
    color: red;
    font-size: 72px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    font-family: 'Impact', sans-serif;
    text-shadow: 0 0 10px #ff0000;
  }

  .mario-cry {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 24px;
    color: white;
    text-align: center;
    z-index: 10001;
  }

  .sans-attack {
    position: absolute;
    width: 30px;
    height: 30px; 
    background-image: url('/1000_F_502568981_wYRSTCvKOnIxdn97hcEgOR63K2PCLPf5-removebg-preview.png');
    background-size: contain;
    background-repeat: no-repeat;
    z-index: 100;
    animation: rotate 1s infinite linear;
  }

  @keyframes rotate {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  .sans {
    position: absolute;
    width: 100px;
    height: 100px;
    background-image: url('/Sans_battle_idle.webp');
    background-size: contain;
    background-repeat: no-repeat;
    opacity: 0.8;
    z-index: 90;
  }

  .skull-button {
    display: block;
    margin: 5px;
    padding: 8px 16px;
    background: #000;
    border: 2px solid #333;
    border-radius: 5px;
    color: white;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 16px;
  }

  .skull-button:hover {
    background: #333;
    transform: scale(1.05);
  }
  
  .tax-popup {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
    z-index: 2000;
    text-align: center;
  }

  .tax-popup button {
    margin: 5px;
    padding: 8px 16px;
    background: #4CAF50;
    border: none;
    border-radius: 5px;
    color: white;
    cursor: pointer;
  }

  .poison-spit {
    position: absolute;
    width: 15px;
    height: 15px;
    background: radial-gradient(#88ff88, #00aa00);
    border-radius: 50%;
    box-shadow: 0 0 10px #00ff00;
    z-index: 100;
    animation: pulse 0.5s infinite;
  }

  .shockwave {
    position: absolute;
    width: 100px;
    height: 100px;
    border: 4px solid #ff4400;
    border-radius: 50%;
    opacity: 0.7;
    animation: expand 0.5s forwards;
  }

  @keyframes expand {
    from { transform: scale(0.1); opacity: 0.7; }
    to { transform: scale(3); opacity: 0; }
  }
  
  .chill-guy {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 200px;
    height: 200px;
    background-image: url('/chill-guy.webp');
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    z-index: 1000;
    animation: fadeInOut 3s forwards;
  }

  @keyframes fadeInOut {
    0% { opacity: 0; }
    20% { opacity: 1; }
    80% { opacity: 1; }
    100% { opacity: 0; }
  }

  .imposter-death {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: black;
    z-index: 10000;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }

  .imposter-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9999;
    display: flex;
    flex-wrap: wrap;
    overflow: hidden;
  }

  .imposter-image {
    width: 100px;
    height: 100px;
    background-image: url('/the imposter.png');
    background-size: contain;
    background-repeat: no-repeat;
    animation: spin 2s linear infinite;
  }

  .imposter-restart-btn {
    margin-top: 20px;
    padding: 10px 20px;
    background: #ff0000;
    border: none;
    border-radius: 5px;
    color: white;
    cursor: not-allowed;
    opacity: 0.5;
  }
  
  .wario-apparition {
    position: fixed; 
    width: 100px;
    height: 100px;
    pointer-events: none;
    z-index: 1000;
    display: none;
  }

  .wario-apparition img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }
  
  .dancing-banana {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 200px;
    height: 200px;
    background-image: url('/dance-banana.gif');
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    z-index: 1000;
    pointer-events: none;
  }

  .banana-projectile {
    position: absolute;
    width: 30px;
    height: 30px;
    background: #ffeb3b;
    border-radius: 20px 20px 0 0;
    transform: rotate(45deg);
    z-index: 100;
  }

  .weapon-btn#ksi-btn {
    background: #000000;
    border-color: #333333;
  }

  .weapon-btn#ksi-btn:hover {
    background: #222222;
  }

  .ice-shard {
    position: absolute;
    width: 10px;
    height: 10px;
    background: #00ffff;
    clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
    box-shadow: 0 0 5px #88ffff;
    z-index: 100;
    animation: rotate 2s linear infinite;
  }

  .snowflake {
    position: fixed;
    color: #fff;
    font-size: 1em;
    font-family: Arial, sans-serif;
    text-shadow: 0 0 5px #000;
    animation: fall linear;
    z-index: 1;
    pointer-events: none;
  }

  @keyframes fall {
    from {
      transform: translateY(-100vh);
    }
    to {
      transform: translateY(100vh); 
    }
  }

  <link rel="preload" href="/gelukkige-oude-man-met-twee-duimen-omhoog-soortgelijke-gebaren-tekenen-van-goedkeuring-op-een-witte-ge&#xef;soleerde-achtergrond-174151900.webp" as="image">
</style>
<link rel="preload" href="/gelukkige-oude-man-met-twee-duimen-omhoog-soortgelijke-gebaren-tekenen-van-goedkeuring-op-een-witte-ge&#xef;soleerde-achtergrond-174151900.webp" as="image">
</head>
<body>
<img id="mario" src="MalleoPIXEL.gif" draggable="false">

<div class="wario-apparition">
  <img src="/wario-berkut.gif" alt="Wario Apparition">
</div>

<div class="weapon-panel">
  <button class="ally-button" id="nerd-btn">&#x1f913; Summon Nerd</button>
  <button class="ally-button" id="peter-btn">&#x1f468; Summon Peter</button>
  <button class="ally-button" id="mrbeast-btn">&#x1f4b0; Summon MrBeast</button>
  <button class="ally-button" id="chicken-btn">&#x1f414; Summon Chicken</button>
  <button class="ally-button" id="oldman-btn">&#x1f474; Summon Old Man</button>
  <button class="weapon-btn" id="hammer-btn">&#x1f528; Hammer</button>
  <button class="weapon-btn" id="fireball-btn">&#x1f525; Fireball</button>
  <button class="weapon-btn" id="thwomp-btn">&#x2b1b; Thwomp</button>
  <button class="weapon-btn" id="gun-btn">&#x1f52b; Gun</button>
  <button class="weapon-btn" id="wario-fart-btn">&#x1f4a8; Huge Wario Fart</button>
  <button class="weapon-btn" id="wario-btn">&#x1f47e; Summon Wario</button>
  <button class="skull-button" id="sans-btn">&#x2753;&#x2753;&#x2753; &#x1f480;</button>
  <button class="weapon-btn" id="ksi-btn">&#x1f4a8; KSI</button>
</div>

<div id="chat-container">
  <div id="chat-messages"></div>
  <input type="text" id="chat-input" placeholder="Talk to Mario...">
  <button onclick="sendMessage()">Send</button>
</div>

<div id="pain-meter">
  <div id="pain-fill"></div>
</div>

<div id="health-bar">
  <div id="health-fill"></div>
</div>

<div id="player-health-bar">
  <div id="player-health-fill"></div>
</div>

<div id="win-screen">
  <h2>You Win!</h2>
  <p>You defeated Mario!</p>
  <button class="restart-btn" onclick="restartGame()">Play Again</button>
</div>

<div id="lose-screen">
  <h2>Game Over!</h2>
  <p>Mario defeated you!</p>
  <button class="restart-btn" onclick="restartGame()">Try Again</button>
</div>

<div id="health-popup" class="health-popup">
  <h3>Adjust Mario&apos;s Health</h3>
  <input type="number" id="health-input" min="0" max="500" value="500">
  <button onclick="adjustHealth()">Set Health</button>
  <button onclick="closeHealthPopup()">Cancel</button>
</div>

<div id="tax-popup" class="tax-popup">
  <h3>Tax Verification</h3>
  <p>Did you pay your taxes this year?</p>
  <button onclick="handleTaxResponse(true)">Yes</button>
  <button onclick="handleTaxResponse(false)">No</button>
</div>

<audio id="scream" src="marioscreaming.mp3"></audio>
<audio id="megalovania" src="Undertale - Megalovania - Game Guard.mp3" loop></audio>
<audio id="wiishop" src="WiiShopTheme.mp3.opus" loop></audio>
<audio id="castle-theme" src="https://dl.sndup.net/jqw6/castle.mp3" loop></audio>
<audio id="pbjt" src="peanut_butter_jelly_time.mp3"></audio>
<audio id="ksi-song" src="KSI - Thick Of It (feat. Trippie Redd) [Official Music Video].mp3"></audio>

<div id="audio-notice" style="position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%); background: rgba(255,255,255,0.9); padding: 10px; border-radius: 5px; text-align: center;">
  Click anywhere to enable sound effects!
</div>

<script>const mario = document.getElementById('mario');
const scream = document.getElementById('scream');
const chatMessages = document.getElementById('chat-messages');
const chatInput = document.getElementById('chat-input');
const painFill = document.getElementById('pain-fill');
const hammerBtn = document.getElementById('hammer-btn');
const fireballBtn = document.getElementById('fireball-btn');
const thwompBtn = document.getElementById('thwomp-btn');
const nerdBtn = document.getElementById('nerd-btn');
const peterBtn = document.getElementById('peter-btn');
const mrbeastBtn = document.getElementById('mrbeast-btn');
const gunBtn = document.getElementById('gun-btn');
const chickenBtn = document.getElementById('chicken-btn');
const warioFartBtn = document.getElementById('wario-fart-btn');
const oldmanBtn = document.getElementById('oldman-btn');
const castleTheme = document.getElementById('castle-theme');
const warioBtn = document.getElementById('wario-btn');
const ksiBtn = document.getElementById('ksi-btn');
const ksiSong = document.getElementById('ksi-song');
let isDragging = false;
let currentX = 0;
let currentY = 0;
let initialX = 0;
let initialY = 0;
let xOffset = 0;
let yOffset = 0;
let painLevel = 0;
let hitCount = 0;
let isAngry = false;
let attackInterval = null;
let mouseX = 0;
let mouseY = 0;
let audioContext = null;
let hasAudioPermission = false;
let marioHealth = 500;
const healthFill = document.getElementById('health-fill');
let playerHealth = 100;
const playerHealthFill = document.getElementById('player-health-fill');
let weaponsAreFrozen = false;
let isPoisoned = false;
let poisonInterval = null;
let allies = [];
const ALLY_DURATION = 30000;
const ALLY_COOLDOWN = 35000;
const allyCooldowns = {
  nerd: false,
  peter: false,
  mrbeast: false,
  chicken: false,
  oldman: false
};
let allyHealth = new Map();
let hasUsedStar = false;
let sansInterval = null;
let hardModeActive = false;
const megalovania = document.getElementById('megalovania');
const sansBtn = document.getElementById('sans-btn');
let warioInterval = null;
let warioApparition = null;
mario.style.left = '50%';
mario.style.top = '50%';
function createHammer(x, y) {
  const hammer = document.createElement('div');
  hammer.className = 'hammer';
  hammer.textContent = '🔨';
  hammer.style.left = x + 'px';
  hammer.style.top = y + 'px';
  document.body.appendChild(hammer);
  setTimeout(() => {
    hammer.remove();
    hitMario(1, 'hammer');
  }, 500);
}
function createThwomp(x) {
  const thwomp = document.createElement('div');
  thwomp.className = 'thwomp';
  thwomp.style.left = x + 'px';
  thwomp.style.top = '0px';
  document.body.appendChild(thwomp);
  const marioRect = mario.getBoundingClientRect();
  thwomp.style.left = marioRect.left - 20 + 'px';
  const targetY = window.innerHeight / 2;
  const checkCollision = () => {
    const thwompRect = thwomp.getBoundingClientRect();
    const marioRect = mario.getBoundingClientRect();
    if (thwompRect.bottom >= marioRect.top && thwompRect.top <= marioRect.bottom && thwompRect.right >= marioRect.left && thwompRect.left <= marioRect.right) {
      hitMario(5, 'thwomp');
      clearInterval(collisionCheck);
    }
  };
  const collisionCheck = setInterval(checkCollision, 50);
  setTimeout(() => {
    thwomp.remove();
    clearInterval(collisionCheck);
  }, 1000);
}
function shootPlayerFireball(e) {
  const fireball = document.createElement('div');
  fireball.className = 'fireball';
  document.body.appendChild(fireball);
  const startX = e.clientX;
  const startY = e.clientY;
  const marioRect = mario.getBoundingClientRect();
  const targetX = marioRect.left + marioRect.width / 2;
  const targetY = marioRect.top + marioRect.height / 2;
  fireball.style.left = startX + 'px';
  fireball.style.top = startY + 'px';
  let currentX = startX;
  let currentY = startY;
  const speed = 5;
  const lifespan = 3000;
  const startTime = Date.now();
  const move = () => {
    const angle = Math.atan2(targetY - currentY, targetX - currentX);
    currentX += Math.cos(angle) * speed;
    currentY += Math.sin(angle) * speed;
    fireball.style.left = currentX + 'px';
    fireball.style.top = currentY + 'px';
    const distance = Math.hypot(targetX - currentX, targetY - currentY);
    if (distance < 30) {
      fireball.remove();
      hitMario(3, 'fireball');
      return;
    }
    if (currentX < 0 || currentX > window.innerWidth || currentY < 0 || currentY > window.innerHeight || Date.now() - startTime > lifespan) {
      fireball.remove();
      return;
    }
    requestAnimationFrame(move);
  };
  move();
}
function createFireball(startX, startY, targetX, targetY) {
  const isIceball = Math.random() < 0.3;
  const fireball = document.createElement('div');
  fireball.className = isIceball ? 'iceball' : 'fireball';
  document.body.appendChild(fireball);
  fireball.style.left = startX + 'px';
  fireball.style.top = startY + 'px';
  let currentX = startX;
  let currentY = startY;
  const speed = 5;
  const lifespan = 5000;
  const startTime = Date.now();
  const move = () => {
    const angle = Math.atan2(mouseY - currentY, mouseX - currentX);
    currentX += Math.cos(angle) * speed;
    currentY += Math.sin(angle) * speed;
    fireball.style.left = currentX + 'px';
    fireball.style.top = currentY + 'px';
    allies.forEach(ally => {
      const allyRect = ally.element.getBoundingClientRect();
      const fireballRect = fireball.getBoundingClientRect();
      if (fireballRect.right >= allyRect.left && fireballRect.left <= allyRect.right && fireballRect.bottom >= allyRect.top && fireballRect.top <= allyRect.bottom) {
        fireball.remove();
        const health = allyHealth.get(ally.element);
        if (health) {
          const newHealth = health - (isIceball ? 10 : 25);
          if (newHealth <= 0) {
            clearInterval(ally.attackInterval);
            createSpeechBubble(ally.type === 'nerd' ? "My calculations were wrong!" : ally.type === 'mrbeast' ? "That's all the money I had!" : "PETER DOWN! I repeat, PETER DOWN!", ally.element);
            ally.element.remove();
            allies = allies.filter(a => a !== ally);
            allyHealth.delete(ally.element);
            createSpeechBubble("Ha ha! Got your friend!", mario);
          } else {
            allyHealth.set(ally.element, newHealth);
            createSpeechBubble(ally.type === 'nerd' ? "According to my calculations, that hurt!" : ally.type === 'mrbeast' ? "Ouch! That's like losing a million dollars!" : "Holy crap, that hurt worse than fighting the chicken!", ally.element);
          }
        }
        return;
      }
    });
    const distance = Math.hypot(mouseX - currentX, mouseY - currentY);
    if (distance < 20) {
      fireball.remove();
      createSpeechBubble("Got you!");
      if (isIceball) {
        freezeWeapons();
      } else {
        damagePlayer(10);
      }
      return;
    }
    if (currentX < 0 || currentX > window.innerWidth || currentY < 0 || currentY > window.innerHeight || Date.now() - startTime > lifespan) {
      fireball.remove();
      return;
    }
    requestAnimationFrame(move);
  };
  move();
}
function startDragging(e) {
  initialX = e.clientX - xOffset;
  initialY = e.clientY - yOffset;
  if (e.target === mario) {
    isDragging = true;
  }
}
function drag(e) {
  if (isDragging) {
    e.preventDefault();
    currentX = e.clientX - initialX;
    currentY = e.clientY - initialY;
    xOffset = currentX;
    yOffset = currentY;
    mario.style.transform = `translate(${currentX}px, ${currentY}px)`;
  }
}
function stopDragging() {
  initialX = currentX;
  initialY = currentY;
  isDragging = false;
}
async function sendMessage() {
  const userMessage = chatInput.value;
  if (!userMessage) return;
  if (userMessage.toLowerCase().includes('stupid') || userMessage.toLowerCase().includes('dumb') || userMessage.toLowerCase().includes('hate') || userMessage.toLowerCase().includes('suck') || userMessage.toLowerCase().includes('bad') || userMessage.toLowerCase().includes('idiot')) {
    appendMessage('You: ' + userMessage);
    isAngry = true;
    mario.classList.add('angry');
    startMarioAttacks();
    createSpeechBubble("NOW YOU'VE MADE ME MAD!");
    chatInput.value = '';
    return;
  }
  if (userMessage.toLowerCase().includes('vietnam') && userMessage.toLowerCase().includes('war')) {
    appendMessage('You: ' + userMessage);
    const jumpscare = document.createElement('div');
    jumpscare.className = 'vietnam-jumpscare';
    document.body.appendChild(jumpscare);
    scream.play();
    setTimeout(() => {
      jumpscare.remove();
      const deathScreen = document.createElement('div');
      deathScreen.className = 'vietnam-death';
      deathScreen.textContent = "WAR NEVER CHANGES";
      document.body.appendChild(deathScreen);
      marioHealth = 0;
      playerHealth = 0;
      allies.forEach(ally => {
        clearInterval(ally.attackInterval);
        ally.element.remove();
      });
      allies = [];
      document.querySelectorAll('.fireball, .iceball, .green-shell, .bullet, .bomb, .explosion, .fart-cloud').forEach(el => el.remove());
      const restartBtn = document.createElement('button');
      restartBtn.className = 'restart-btn';
      restartBtn.textContent = 'Try Again';
      restartBtn.onclick = () => {
        deathScreen.remove();
        restartGame();
      };
      deathScreen.appendChild(restartBtn);
    }, 1000);
    chatInput.value = '';
    return;
  }
  if (userMessage.toLowerCase().includes('sans') && userMessage.toLowerCase().includes('bad') && userMessage.toLowerCase().includes('aim')) {
    appendMessage('You: ' + userMessage);
    document.querySelectorAll('.sans-attack').forEach(bone => {
      if (bone.updateHoming) {
        bone.updateHoming(true);
      }
    });
    createSpeechBubble("You're gonna have a bad time!");
    chatInput.value = '';
    return;
  }
  if (userMessage.toLowerCase().includes('chill') && userMessage.toLowerCase().includes('mario')) {
    appendMessage('You: ' + userMessage);
    const chillGuy = document.createElement('div');
    chillGuy.className = 'chill-guy';
    document.body.appendChild(chillGuy);
    createSpeechBubble("Yup, Mario is definitely chill! Just like me!", chillGuy);
    setTimeout(() => {
      chillGuy.remove();
      createSpeechBubble("What just happened? Who was that?", mario);
    }, 3000);
    chatInput.value = '';
    return;
  }
  if (userMessage.toLowerCase().includes('wario') && (userMessage.toLowerCase().includes('bad') || userMessage.toLowerCase().includes('suck') || userMessage.toLowerCase().includes('hate') || userMessage.toLowerCase().includes('terrible'))) {
    appendMessage('You: ' + userMessage);
    warioDeathSequence();
    chatInput.value = '';
    return;
  }
  if (userMessage.toLowerCase() === "mario") {
    appendMessage('You: ' + userMessage);
    showHealthPopup();
    chatInput.value = '';
    return;
  }
  if (userMessage.toLowerCase() === "warioisgood") {
    appendMessage('You: ' + userMessage);
    const overlay = document.createElement('div');
    overlay.className = 'wario-overlay';
    document.body.appendChild(overlay);
    setTimeout(() => overlay.remove(), 3000);
    chatInput.value = '';
    return;
  }
  if (userMessage.toLowerCase() === "yousuck") {
    appendMessage('You: ' + userMessage);
    hitMario(499, 'insult');
    chatInput.value = '';
    return;
  }
  if (userMessage.toLowerCase().includes("magic")) {
    const healthMatch = userMessage.match(/\d+/);
    if (healthMatch) {
      const newHealth = parseInt(healthMatch[0]);
      if (!isNaN(newHealth) && newHealth >= 0 && newHealth <= 500) {
        marioHealth = newHealth;
        healthFill.style.width = `${marioHealth / 500 * 100}%`;
        appendMessage('You: ' + userMessage);
        appendMessage('System: Mario\'s health has been magically set to ' + newHealth);
        createSpeechBubble("What-a magic is this?! My health feels strange!");
        chatInput.value = '';
        if (marioHealth === 0) {
          handleWin();
        } else if (marioHealth <= 10 && !hasUsedStar) {
          activateSuperStar();
        }
        return;
      }
    }
  }
  if (userMessage.toLowerCase().includes('sussy') && userMessage.toLowerCase().includes('baka') && userMessage.toLowerCase().includes('mario')) {
    appendMessage('You: ' + userMessage);
    createImpostorScreen();
    chatInput.value = '';
    return;
  }
  if (userMessage.toLowerCase().includes('peanut butter jelly time')) {
    appendMessage('You: ' + userMessage);
    createPeanutButterJellyTime();
    chatInput.value = '';
    return;
  }
  appendMessage('You: ' + userMessage);
  try {
    const response = await fetch('/api/ai_completion', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        prompt: `You are Mario having a wide range of emotional responses. Based on the situation, respond in character:

${isAngry ? 'You are VERY angry about being attacked and should respond with hostility and threats!' : 'You are the cheerful, enthusiastic Mario everyone knows and loves!'} 

Use classic Mario phrases and mannerisms. Mix in "Mama mia!", "Yahoo!", "It's-a me!", "Here we go!", etc. ${isAngry ? 'But maintain an angry tone!' : 'Keep it upbeat and friendly!'}

The player said: "${userMessage}"

Generate a natural, conversational response that:
- Stays in character as Mario
- References the player's message
- Shows personality and emotion
- Varies responses to avoid repetition
- ${isAngry ? 'Expresses anger and hostility' : 'Maintains Mario\'s friendly demeanor'}

Response format:
interface Response {
  reply: string;
}

Example responses:
{
  "reply": "Yahoo! That's-a great idea! Mario loves to go on adventures!"
}
{
  "reply": "Mama mia! You remind-a me of my brother Luigi with that clever thinking!"
}
{
  "reply": "IT'S-A ME, MARIO! And I'm-a going to make you regret this!"
}`,
        data: userMessage
      })
    });
    const data = await response.json();
    const reply = data.reply;
    appendMessage('Mario: ' + reply);
    createSpeechBubble(reply);
  } catch (error) {
    console.error('Error:', error);
    const errorReply = isAngry ? "GRRRR! I'm-a too angry to talk!" : 'Mama mia! My voice is-a not working!';
    appendMessage('Mario: ' + errorReply);
    createSpeechBubble(errorReply);
  }
  chatInput.value = '';
}
function appendMessage(message) {
  const messageDiv = document.createElement('div');
  messageDiv.textContent = message;
  chatMessages.appendChild(messageDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}
function updatePainMeter() {
  painFill.style.width = `${painLevel}%`;
  if (painLevel >= 100) {
    mario.style.transform = 'scale(0.5) rotate(180deg)';
    scream.play();
    setTimeout(() => {
      painLevel = 0;
      updatePainMeter();
      mario.style.transform = 'scale(1) rotate(0deg)';
    }, 2000);
  }
}
function createSpeechBubble(message, ally) {
  const bubble = document.createElement('div');
  bubble.className = 'speech-bubble';
  bubble.textContent = message;
  document.body.appendChild(bubble);
  if (ally) {
    const allyRect = ally.getBoundingClientRect();
    bubble.style.left = allyRect.left + allyRect.width / 2 - bubble.offsetWidth / 2 + 'px';
    bubble.style.top = allyRect.top - bubble.offsetHeight - 20 + 'px';
  } else {
    const marioRect = mario.getBoundingClientRect();
    bubble.style.left = marioRect.left + marioRect.width / 2 - bubble.offsetWidth / 2 + 'px';
    bubble.style.top = marioRect.top - bubble.offsetHeight - 20 + 'px';
  }
  setTimeout(() => {
    bubble.remove();
  }, 3000);
}
function hitMario(damage, weaponType) {
  hitCount++;
  if (hitCount >= 3 && !isAngry) {
    isAngry = true;
    mario.classList.add('angry');
    startMarioAttacks();
  }
  if (mario.classList.contains('star')) {
    return;
  }
  mario.classList.add('hit');
  marioHealth = Math.max(0, marioHealth - damage);
  healthFill.style.width = `${marioHealth / 500 * 100}%`;
  if (marioHealth === 0) {
    handleWin();
    return;
  }
  if (marioHealth <= 10 && !hasUsedStar) {
    activateSuperStar();
    return;
  }
  if (!hasAudioPermission) {
    try {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      hasAudioPermission = true;
    } catch (e) {
      console.error('Could not initialize audio context:', e);
    }
  }
  if (hasAudioPermission) {
    scream.play().catch(e => {
      console.error('Audio playback failed:', e);
    });
    setTimeout(() => {
      scream.pause();
      scream.currentTime = 0;
    }, 1000);
  }
  painLevel = Math.min(painLevel + damage, 100);
  updatePainMeter();
  if (weaponType === 'poke' && Math.random() < 0.3) {
    createFartCloud();
  }
  getMarioResponse(weaponType);
  setTimeout(() => mario.classList.remove('hit'), 200);
}
function startMarioAttacks() {
  if (attackInterval) return;
  attackInterval = setInterval(() => {
    if (isAngry) {
      const marioRect = mario.getBoundingClientRect();
      const marioX = marioRect.left + marioRect.width / 2;
      const marioY = marioRect.top + marioRect.height / 2;
      const attackRoll = Math.random();
      if (attackRoll < 0.2) {
        createFartCloud();
      } else if (attackRoll < 0.4) {
        createFireball(marioX, marioY, mouseX, mouseY);
        createSpeechBubble("Take this!");
      } else if (attackRoll < 0.6) {
        createGreenShell(marioX, marioY, mouseX, mouseY);
        createSpeechBubble("Here comes the shell!");
      } else if (attackRoll < 0.8) {
        createPoisonSpit(marioX, marioY, mouseX, mouseY);
        createSpeechBubble("Try some poison pasta!");
      } else {
        createGroundPound(marioX, marioY);
        createSpeechBubble("GROUND POUND!");
      }
    }
  }, 1500);
}
function getMarioResponse(weaponType) {
  return new Promise(async resolve => {
    try {
      const response = await fetch('/api/ai_completion', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          prompt: `You are Mario with a wide range of emotional responses. Based on the situation, respond in character:

${weaponType === 'defeat' ? 'You were just defeated by the player! Express your dismay and disappointment with classic Mario flair.' : weaponType === 'victory' ? 'You just defeated the player! Gloat triumphantly with signature Mario enthusiasm!' : weaponType === 'poke' ? `The player just poked you. ${isAngry ? 'Express intense anger and annoyance at being touched!' : 'Show mild irritation at being bothered.'}` : weaponType === 'insult' ? 'You were just deeply insulted! React with shock, hurt feelings and classic Mario indignation!' : weaponType === 'hammer' ? `A hammer just hit you! ${isAngry ? 'Rage about being hit with tools!' : 'Express pain and surprise at the hammer strike!'}` : weaponType === 'fireball' ? `You were hit by a fireball! ${isAngry ? 'Furiously complain about being burned!' : 'React dramatically to being singed!'}` : weaponType === 'thwomp' ? `A Thwomp just crushed you! ${isAngry ? 'Express outrage at being squashed!' : 'React with classic Mario anguish to being flattened!'}` : `You just got hit! ${isAngry ? 'You are EXTREMELY angry and threatening revenge!' : 'Respond with characteristic Mario pain!'}`}

Mix up your responses with classic Mario phrases like "Mama mia!", "Yahoo!", "It's-a me!", "Here we go!", etc. ${isAngry ? 'But maintain an angry, threatening tone!' : 'Keep it light and characteristically Mario-like!'} Keep responses varied and avoid repeating the same phrases.

Response format:
interface Response {
  reply: string;
}

Example responses:
{
  "reply": "YOWZA! That hammer sure packs a punch! Mama mia!"
}
{
  "reply": "IT'S-A ME, MARIO! And I'm-a NOT happy about that fireball!"
}
{
  "reply": "Wahoo! The super Mario is-a victorious once again!"
}
`,
          data: weaponType
        })
      });
      const data = await response.json();
      const reply = data.reply;
      appendMessage('Mario: ' + reply);
      createSpeechBubble(reply);
      resolve();
    } catch (error) {
      console.error('Error:', error);
      const defaultReply = weaponType === 'defeat' ? "Mama mia! I can't-a believe it!" : weaponType === 'victory' ? "Yahoo! Mario is number one!" : isAngry ? "NOW YOU'VE DONE IT! PREPARE FOR TROUBLE!" : 'OH NO! That-a really hurt!';
      appendMessage('Mario: ' + defaultReply);
      createSpeechBubble(defaultReply);
      resolve();
    }
  });
}
function handleWin() {
  document.getElementById('win-screen').style.display = 'block';
  clearInterval(attackInterval);
  isAngry = false;
  mario.classList.remove('angry');
  createSpeechBubble("MAMA MIA! You got me!");
  getMarioResponse("defeat");
  document.querySelectorAll('.fireball, .iceball, .green-shell, .fart-cloud, .mega-fart').forEach(attack => {
    attack.remove();
  });
  document.querySelectorAll('.bullet, .bomb, .explosion').forEach(el => {
    el.remove();
  });
  if (isPoisoned) {
    isPoisoned = false;
    mario.classList.remove('poisoned');
    playerHealthFill.classList.remove('poisoned');
    clearInterval(poisonInterval);
  }
  allies.forEach(ally => {
    clearInterval(ally.attackInterval);
    ally.element.remove();
  });
  allies = [];
  if (hardModeActive) {
    hardModeActive = false;
    megalovania.pause();
    megalovania.currentTime = 0;
    clearInterval(sansInterval);
    const sans = document.querySelector('.sans');
    if (sans) sans.remove();
    document.querySelectorAll('.sans-attack').forEach(attack => attack.remove());
  }
  if (warioInterval) {
    clearInterval(warioInterval);
    warioInterval = null;
  }
  if (warioApparition) {
    warioApparition.style.display = 'none';
  }
}
function restartGame() {
  document.querySelectorAll('.imposter-death').forEach(el => el.remove());
  scream.loop = false;
  scream.pause();
  const wiishop = document.getElementById('wiishop');
  wiishop.pause();
  mario.style.display = '';
  document.querySelectorAll('.mega-fart, .wario-ending, .wario-overlay').forEach(el => {
    el.remove();
  });
  document.querySelectorAll('.mega-fart, .wario-ending, .wario-overlay').forEach(el => {
    el.remove();
  });
  marioHealth = 500;
  healthFill.style.width = '100%';
  painLevel = 0;
  updatePainMeter();
  hitCount = 0;
  document.getElementById('win-screen').style.display = 'none';
  mario.style.transform = 'translate(0, 0)';
  xOffset = 0;
  yOffset = 0;
  currentX = 0;
  currentY = 0;
  initialX = 0;
  initialY = 0;
  isAngry = false;
  if (attackInterval) {
    clearInterval(attackInterval);
    attackInterval = null;
  }
  mario.classList.remove('angry');
  playerHealth = 100;
  playerHealthFill.style.width = '100%';
  document.getElementById('lose-screen').style.display = 'none';
  isPoisoned = false;
  if (poisonInterval) {
    clearInterval(poisonInterval);
  }
  mario.classList.remove('poisoned');
  allies.forEach(ally => {
    clearInterval(ally.attackInterval);
    ally.element.remove();
  });
  allyHealth.clear();
  allies = [];
  Object.keys(allyCooldowns).forEach(type => {
    allyCooldowns[type] = false;
    const btn = type === 'nerd' ? nerdBtn : type === 'mrbeast' ? mrbeastBtn : type === 'peter' ? peterBtn : type === 'chicken' ? chickenBtn : oldmanBtn;
    btn.classList.remove('cooldown');
  });
  hasUsedStar = false;
  mario.classList.remove('star');
  if (hardModeActive) {
    hardModeActive = false;
    megalovania.pause();
    megalovania.currentTime = 0;
    clearInterval(sansInterval);
    const sans = document.querySelector('.sans');
    if (sans) sans.remove();
    document.querySelectorAll('.sans-attack').forEach(attack => attack.remove());
  }
  if (warioInterval) {
    clearInterval(warioInterval);
    warioInterval = null;
  }
  if (warioApparition) {
    warioApparition.style.display = 'none';
  }
  ksiSong.pause();
  ksiSong.currentTime = 0;
  ksiBtn.disabled = false;
  ksiBtn.classList.remove('cooldown');
}
function damagePlayer(damage) {
  playerHealth = Math.max(0, playerHealth - damage);
  playerHealthFill.style.width = `${playerHealth}%`;
  if (playerHealth === 0) {
    handleLose();
  }
}
function handleLose() {
  document.getElementById('lose-screen').style.display = 'block';
  clearInterval(attackInterval);
  createSpeechBubble("HA HA! I win!");
  getMarioResponse("victory");
  allies.forEach(ally => {
    clearInterval(ally.attackInterval);
    ally.element.remove();
  });
  allies = [];
  if (warioInterval) {
    clearInterval(warioInterval);
    warioInterval = null;
  }
  if (warioApparition) {
    warioApparition.style.display = 'none';
  }
}
function freezeWeapons() {
  if (weaponsAreFrozen) return;
  weaponsAreFrozen = true;
  const buttons = document.querySelectorAll('.weapon-btn');
  buttons.forEach(btn => btn.classList.add('frozen'));
  setTimeout(() => {
    weaponsAreFrozen = false;
    buttons.forEach(btn => btn.classList.remove('frozen'));
  }, 5000);
}
function createFartCloud() {
  const marioRect = mario.getBoundingClientRect();
  const cloud = document.createElement('div');
  cloud.className = 'fart-cloud';
  cloud.style.left = marioRect.left + marioRect.width / 2 - 100 + 'px';
  cloud.style.top = marioRect.top + marioRect.height / 2 - 100 + 'px';
  document.body.appendChild(cloud);
  createSpeechBubble("Oopsie! Mama mia!");
  const checkPoisonCollision = setInterval(() => {
    const cloudRect = cloud.getBoundingClientRect();
    const distance = Math.hypot(mouseX - (cloudRect.left + cloudRect.width / 2), mouseY - (cloudRect.top + cloudRect.height / 2));
    if (distance < 100 && !isPoisoned) {
      poisonPlayer();
    }
  }, 100);
  setTimeout(() => {
    cloud.remove();
    clearInterval(checkPoisonCollision);
  }, 2000);
}
function poisonPlayer() {
  if (isPoisoned) return;
  isPoisoned = true;
  mario.classList.add('poisoned');
  playerHealthFill.classList.add('poisoned');
  createSpeechBubble("Hehe! My poison got you!");
  poisonInterval = setInterval(() => {
    damagePlayer(5);
  }, 1000);
  setTimeout(() => {
    isPoisoned = false;
    mario.classList.remove('poisoned');
    playerHealthFill.classList.remove('poisoned');
    clearInterval(poisonInterval);
  }, 5000);
}
function createAlly(type) {
  if (allyCooldowns[type]) return;
  const ally = document.createElement('img');
  ally.className = 'ally';
  if (type === 'chicken') {
    ally.src = '/chicken spin.gif';
  } else if (type === 'oldman') {
    ally.src = '/gelukkige-oude-man-met-twee-duimen-omhoog-soortgelijke-gebaren-tekenen-van-goedkeuring-op-een-witte-geïsoleerde-achtergrond-174151900.webp';
  } else {
    ally.src = type === 'nerd' ? '/nerd.gif' : type === 'mrbeast' ? '/MrBeastBoss.png' : '/Peter_Griffin.png';
  }
  ally.style.left = Math.random() * (window.innerWidth - 100) + 'px';
  ally.style.top = Math.random() * (window.innerHeight - 100) + 'px';
  document.body.appendChild(ally);
  const initialHealth = type === 'mrbeast' ? 50 : type === 'chicken' ? 20 : type === 'oldman' ? 30 : 35;
  const allyData = {
    element: ally,
    type: type
  };
  if (type === 'chicken') {
    allyData.attackInterval = setInterval(() => {
      if (marioHealth > 0) {
        createChickenBomb(ally);
      }
    }, 4000);
  } else if (type === 'oldman') {
    allyData.attackInterval = setInterval(() => {
      if (marioHealth > 0) {
        const oneshot = document.createElement('div');
        oneshot.className = 'ally-attack';
        oneshot.style.background = 'gold';
        document.body.appendChild(oneshot);
        const allyRect = ally.getBoundingClientRect();
        const marioRect = mario.getBoundingClientRect();
        const startX = allyRect.left + allyRect.width / 2;
        const startY = allyRect.top + allyRect.height / 2;
        oneshot.style.left = startX + 'px';
        oneshot.style.top = startY + 'px';
        const targetX = marioRect.left + marioRect.width / 2;
        const targetY = marioRect.top + marioRect.height / 2;
        const speed = 10;
        const moveAttack = () => {
          const attackRect = oneshot.getBoundingClientRect();
          const currentX = attackRect.left;
          const currentY = attackRect.top;
          const angle = Math.atan2(targetY - currentY, targetX - currentX);
          const newX = currentX + Math.cos(angle) * speed;
          const newY = currentY + Math.sin(angle) * speed;
          oneshot.style.left = newX + 'px';
          oneshot.style.top = newY + 'px';
          const distance = Math.hypot(targetX - newX, targetY - newY);
          if (distance < 30) {
            oneshot.remove();
            if (!mario.classList.contains('star')) {
              marioHealth = 0;
              handleWin();
              createSpeechBubble("Tax season came early this year!", ally);
            }
            return;
          }
          if (newX < 0 || newX > window.innerWidth || newY < 0 || newY > window.innerHeight) {
            oneshot.remove();
            return;
          }
          requestAnimationFrame(moveAttack);
        };
        moveAttack();
      }
    }, 5000);
  } else {
    allyData.attackInterval = setInterval(() => {
      if (marioHealth > 0) {
        if (type === 'mrbeast') {
          healPlayer(ally);
          allies.forEach(otherAlly => {
            if (otherAlly !== allyData && Math.random() < 0.3) {
              const currentHealth = allyHealth.get(otherAlly.element);
              if (currentHealth && currentHealth < 35) {
                allyHealth.set(otherAlly.element, Math.min(35, currentHealth + 10));
                createSpeechBubble("Here's some health for you too!", ally);
              }
            }
          });
        } else {
          shootAllyAttack(ally, type);
        }
      }
    }, type === 'nerd' ? 3000 : type === 'mrbeast' ? 5000 : 4000);
  }
  allies.push(allyData);
  allyHealth.set(ally, initialHealth);
  const message = type === 'nerd' ? "Actually, your hit points are quite sub-optimal " : type === 'mrbeast' ? "Today I'm giving away MASSIVE amounts of health!" : type === 'chicken' ? "Bock! Bock!" : type === 'oldman' ? "Time to collect my taxes!" : "Hey Lois, watch me help defeat Mario! Hehehehehe";
  createSpeechBubble(message, ally);
  setTimeout(() => {
    clearInterval(allyData.attackInterval);
    ally.remove();
    allies = allies.filter(a => a !== allyData);
  }, ALLY_DURATION);
  allyCooldowns[type] = true;
  const btn = type === 'nerd' ? nerdBtn : type === 'mrbeast' ? mrbeastBtn : type === 'peter' ? peterBtn : type === 'chicken' ? chickenBtn : oldmanBtn;
  btn.classList.add('cooldown');
  setTimeout(() => {
    allyCooldowns[type] = false;
    btn.classList.remove('cooldown');
  }, ALLY_DURATION + ALLY_COOLDOWN);
}
function shootAllyAttack(ally, type) {
  const attack = document.createElement('div');
  attack.className = 'ally-attack';
  document.body.appendChild(attack);
  const allyRect = ally.getBoundingClientRect();
  const marioRect = mario.getBoundingClientRect();
  const startX = allyRect.left + allyRect.width / 2;
  const startY = allyRect.top + allyRect.height / 2;
  const targetX = marioRect.left + marioRect.width / 2;
  const targetY = marioRect.top + marioRect.height / 2;
  attack.style.left = startX + 'px';
  attack.style.top = startY + 'px';
  const speed = type === 'nerd' ? 6 : 4;
  const damage = type === 'nerd' ? 10 : 15;
  const moveAttack = () => {
    const attackRect = attack.getBoundingClientRect();
    const currentX = attackRect.left;
    const currentY = attackRect.top;
    const updatedMarioRect = mario.getBoundingClientRect();
    const updatedTargetX = updatedMarioRect.left + updatedMarioRect.width / 2;
    const updatedTargetY = updatedMarioRect.top + updatedMarioRect.height / 2;
    const angle = Math.atan2(updatedTargetY - currentY, updatedTargetX - currentX);
    const newX = currentX + Math.cos(angle) * speed;
    const newY = currentY + Math.sin(angle) * speed;
    attack.style.left = newX + 'px';
    attack.style.top = newY + 'px';
    const distance = Math.hypot(updatedTargetX - newX, updatedTargetY - newY);
    if (distance < 30) {
      attack.remove();
      hitMario(damage, type);
      const message = type === 'nerd' ? "Mathematically speaking, that was optimal damage! " : type === 'mrbeast' ? "That's a wrap folks!" : "D'oh! Not the shell!";
      createSpeechBubble(message, ally);
      return;
    }
    if (newX < 0 || newX > window.innerWidth || newY < 0 || newY > window.innerHeight) {
      attack.remove();
      return;
    }
    requestAnimationFrame(moveAttack);
  };
  moveAttack();
}
function healPlayer(ally) {
  if (playerHealth >= 100) return;
  const healAmount = 25;
  playerHealth = Math.min(100, playerHealth + healAmount);
  playerHealthFill.style.width = `${playerHealth}%`;
  for (let i = 0; i < 3; i++) {
    const healEffect = document.createElement('div');
    healEffect.className = 'heal-effect';
    const allyRect = ally.getBoundingClientRect();
    healEffect.style.left = allyRect.left + allyRect.width / 2 - 25 + (Math.random() * 50 - 25) + 'px';
    healEffect.style.top = allyRect.top + allyRect.height / 2 - 25 + (Math.random() * 50 - 25) + 'px';
    document.body.appendChild(healEffect);
    setTimeout(() => healEffect.remove(), 1000);
  }
  createSpeechBubble("Here's $50,000 worth of health!", ally);
}
function createGreenShell(startX, startY, targetX, targetY) {
  const shell = document.createElement('div');
  shell.className = 'green-shell';
  document.body.appendChild(shell);
  shell.style.left = startX + 'px';
  shell.style.top = startY + 'px';
  let currentX = startX;
  let currentY = startY;
  const speed = 8;
  const bounces = 3;
  let bounceCount = 0;
  let angle = Math.atan2(targetY - currentY, targetX - currentX);
  let dx = Math.cos(angle) * speed;
  let dy = Math.sin(angle) * speed;
  const move = () => {
    currentX += dx;
    currentY += dy;
    shell.style.left = currentX + 'px';
    shell.style.top = currentY + 'px';
    if (currentX <= 0 || currentX >= window.innerWidth) {
      dx = -dx;
      bounceCount++;
    }
    if (currentY <= 0 || currentY >= window.innerHeight) {
      dy = -dy;
      bounceCount++;
    }
    const distance = Math.hypot(mouseX - currentX, mouseY - currentY);
    if (distance < 30) {
      shell.remove();
      damagePlayer(15);
      createSpeechBubble("Green shell strike!");
      return;
    }
    allies.forEach(ally => {
      const allyRect = ally.element.getBoundingClientRect();
      const shellRect = shell.getBoundingClientRect();
      if (shellRect.right >= allyRect.left && shellRect.left <= allyRect.right && shellRect.bottom >= allyRect.top && shellRect.top <= allyRect.bottom) {
        shell.remove();
        const health = allyHealth.get(ally.element);
        if (health) {
          const newHealth = health - 20;
          if (newHealth <= 0) {
            clearInterval(ally.attackInterval);
            createSpeechBubble(ally.type === 'nerd' ? "Shell equation unsolvable!" : ally.type === 'mrbeast' ? "That's a wrap folks!" : "D'oh! Not the shell!", ally.element);
            ally.element.remove();
            allies = allies.filter(a => a !== ally);
            allyHealth.delete(ally.element);
          } else {
            allyHealth.set(ally.element, newHealth);
            createSpeechBubble(ally.type === 'nerd' ? "Shell trajectory unexpected!" : ally.type === 'mrbeast' ? "That shell cost me $10,000!" : "Worse than a chicken fight!", ally.element);
          }
        }
        return;
      }
    });
    if (bounceCount >= bounces) {
      shell.remove();
      return;
    }
    requestAnimationFrame(move);
  };
  move();
}
function activateSuperStar() {
  hasUsedStar = true;
  mario.classList.add('star');
  createSpeechBubble("Now I'm INVINCIBLE! WAHAHA!");
  const starTimer = setTimeout(() => {
    mario.classList.remove('star');
    createSpeechBubble("Oh no! My star power!");
  }, 10000);
}
function showHealthPopup() {
  const popup = document.getElementById('health-popup');
  const input = document.getElementById('health-input');
  input.value = marioHealth;
  popup.style.display = 'block';
}
function closeHealthPopup() {
  document.getElementById('health-popup').style.display = 'none';
}
function adjustHealth() {
  const input = document.getElementById('health-input');
  const newHealth = parseInt(input.value);
  if (!isNaN(newHealth) && newHealth >= 0 && newHealth <= 500) {
    marioHealth = newHealth;
    healthFill.style.width = `${marioHealth / 500 * 100}%`;
    createSpeechBubble("What-a magic is this?! My health feels strange!");
    if (marioHealth === 0) {
      handleWin();
    } else if (marioHealth <= 10 && !hasUsedStar) {
      activateSuperStar();
    }
  }
  closeHealthPopup();
}
function shootGun(e) {
  if (weaponsAreFrozen) return;
  const bullet = document.createElement('div');
  bullet.className = 'bullet';
  document.body.appendChild(bullet);
  const startX = e.clientX;
  const startY = e.clientY;
  const marioRect = mario.getBoundingClientRect();
  const targetX = marioRect.left + marioRect.width / 2;
  const targetY = marioRect.top + marioRect.height / 2;
  bullet.style.left = startX + 'px';
  bullet.style.top = startY + 'px';
  const speed = 15;
  const angle = Math.atan2(targetY - startY, targetX - startX);
  const dx = Math.cos(angle) * speed;
  const dy = Math.sin(angle) * speed;
  function moveBullet() {
    const currentX = parseFloat(bullet.style.left);
    const currentY = parseFloat(bullet.style.top);
    bullet.style.left = currentX + dx + 'px';
    bullet.style.top = currentY + dy + 'px';
    const bulletRect = bullet.getBoundingClientRect();
    const marioRect = mario.getBoundingClientRect();
    if (bulletRect.right >= marioRect.left && bulletRect.left <= marioRect.right && bulletRect.bottom >= marioRect.top && bulletRect.top <= marioRect.bottom) {
      bullet.remove();
      hitMario(5, 'gun');
      return;
    }
    if (currentX < 0 || currentX > window.innerWidth || currentY < 0 || currentY > window.innerHeight) {
      bullet.remove();
      return;
    }
    requestAnimationFrame(moveBullet);
  }
  moveBullet();
}
function createChickenBomb(chickenElement) {
  const bomb = document.createElement('div');
  bomb.className = 'bomb';
  document.body.appendChild(bomb);
  const chickenRect = chickenElement.getBoundingClientRect();
  const marioRect = mario.getBoundingClientRect();
  const startX = chickenRect.left + chickenRect.width / 2;
  const startY = chickenRect.top + chickenRect.height / 2;
  const targetX = marioRect.left + marioRect.width / 2;
  const targetY = marioRect.top + marioRect.height / 2;
  bomb.style.left = startX + 'px';
  bomb.style.top = startY + 'px';
  const speed = 5;
  const angle = Math.atan2(targetY - startY, targetX - startX);
  const dx = Math.cos(angle) * speed;
  const dy = Math.sin(angle) * speed;
  function moveBomb() {
    const currentX = parseFloat(bomb.style.left);
    const currentY = parseFloat(bomb.style.top);
    bomb.style.left = currentX + dx + 'px';
    bomb.style.top = currentY + dy + 'px';
    const bombRect = bomb.getBoundingClientRect();
    const marioRect = mario.getBoundingClientRect();
    if (bombRect.right >= marioRect.left && bombRect.left <= marioRect.right && bombRect.bottom >= marioRect.top && bombRect.top <= marioRect.bottom) {
      explode(currentX, currentY);
      return;
    }
    if (currentX < 0 || currentX > window.innerWidth || currentY < 0 || currentY > window.innerHeight) {
      bomb.remove();
      return;
    }
    requestAnimationFrame(moveBomb);
  }
  moveBomb();
}
function explode(x, y) {
  const bombs = document.querySelectorAll('.bomb');
  bombs.forEach(bomb => {
    const bombRect = bomb.getBoundingClientRect();
    const distance = Math.hypot(bombRect.left - x, bombRect.top - y);
    if (distance < 10) {
      bomb.remove();
    }
  });
  const explosion = document.createElement('div');
  explosion.className = 'explosion';
  explosion.style.left = x - 50 + 'px';
  explosion.style.top = y - 50 + 'px';
  document.body.appendChild(explosion);
  const marioRect = mario.getBoundingClientRect();
  const distance = Math.hypot(marioRect.left + marioRect.width / 2 - x, marioRect.top + marioRect.height / 2 - y);
  if (distance < 100) {
    hitMario(20, 'bomb');
  }
  setTimeout(() => explosion.remove(), 500);
}
function createMegaFart(x, y) {
  const fart = document.createElement('div');
  fart.className = 'mega-fart';
  fart.style.left = x - 200 + 'px';
  fart.style.top = y - 200 + 'px';
  document.body.appendChild(fart);
  setTimeout(() => {
    marioHealth = 0;
    playerHealth = 0;
    allies.forEach(ally => {
      clearInterval(ally.attackInterval);
      ally.element.remove();
    });
    allies = [];
    const warioEnding = document.createElement('div');
    warioEnding.className = 'wario-ending';
    warioEnding.innerHTML = `
      <h2>WARIO WINS!</h2>
      <p>Everyone died from the massive fart!</p>
      <button class="restart-btn" onclick="restartGame()">Try Again</button>
    `;
    document.body.appendChild(warioEnding);
    const overlay = document.createElement('div');
    overlay.className = 'wario-overlay';
    document.body.appendChild(overlay);
    setTimeout(() => {
      overlay.remove();
    }, 3000);
  }, 1000);
}
function handleTaxResponse(paidTaxes) {
  document.getElementById('tax-popup').style.display = 'none';
  if (paidTaxes) {
    createAlly('oldman');
  } else {
    playerHealth = 0;
    handleLose();
    createSpeechBubble("The IRS always wins!");
  }
}
function showTaxPopup() {
  document.getElementById('tax-popup').style.display = 'block';
}
function warioDeathSequence() {
  const overlay = document.createElement('div');
  overlay.className = 'wario-overlay';
  document.body.appendChild(overlay);
  scream.play();
  setTimeout(() => {
    overlay.remove();
    const deathScreen = document.createElement('div');
    deathScreen.className = 'wario-death';
    deathScreen.innerHTML = `
      <div>SKILL ISSUE</div>
      <div class="mario-cry">*Mario cries over his dead husband Wario*</div>
    `;
    document.body.appendChild(deathScreen);
    marioHealth = 0;
    playerHealth = 0;
    allies.forEach(ally => {
      clearInterval(ally.attackInterval);
      ally.element.remove();
    });
    allies = [];
    document.querySelectorAll('.fireball, .iceball, .green-shell, .bullet, .bomb, .explosion, .fart-cloud').forEach(el => el.remove());
    const restartBtn = document.createElement('button');
    restartBtn.className = 'restart-btn';
    restartBtn.textContent = 'Try Again';
    restartBtn.onclick = () => {
      deathScreen.remove();
      restartGame();
    };
    deathScreen.appendChild(restartBtn);
  }, 3000);
}
function createPoisonSpit(startX, startY, targetX, targetY) {
  const spit = document.createElement('div');
  spit.className = 'poison-spit';
  document.body.appendChild(spit);
  spit.style.left = startX + 'px';
  spit.style.top = startY + 'px';
  const speed = 7;
  const angle = Math.atan2(targetY - startY, targetX - startX);
  const dx = Math.cos(angle) * speed;
  const dy = Math.sin(angle) * speed;
  function moveSpit() {
    const currentX = parseFloat(spit.style.left);
    const currentY = parseFloat(spit.style.top);
    spit.style.left = currentX + dx + 'px';
    spit.style.top = currentY + dy + 'px';
    const distance = Math.hypot(mouseX - currentX, mouseY - currentY);
    if (distance < 30) {
      spit.remove();
      if (!isPoisoned) {
        poisonPlayer();
      }
      return;
    }
    if (currentX < 0 || currentX > window.innerWidth || currentY < 0 || currentY > window.innerHeight) {
      spit.remove();
      return;
    }
    requestAnimationFrame(moveSpit);
  }
  moveSpit();
}
function createGroundPound(marioX, marioY) {
  mario.style.transition = 'transform 0.5s';
  mario.style.transform = 'scale(1.5)';
  setTimeout(() => {
    mario.style.transform = 'scale(1)';
    const shockwave = document.createElement('div');
    shockwave.className = 'shockwave';
    shockwave.style.left = marioX - 50 + 'px';
    shockwave.style.top = marioY - 50 + 'px';
    document.body.appendChild(shockwave);
    const distance = Math.hypot(mouseX - marioX, mouseY - marioY);
    if (distance < 250) {
      damagePlayer(20);
      createSpeechBubble("WAHOO! Ground pound got you!");
    }
    allies.forEach(ally => {
      const allyRect = ally.element.getBoundingClientRect();
      const allyX = allyRect.left + allyRect.width / 2;
      const allyY = allyRect.top + allyRect.height / 2;
      const allyDistance = Math.hypot(allyX - marioX, allyY - marioY);
      if (allyDistance < 250) {
        const health = allyHealth.get(ally.element);
        if (health) {
          const newHealth = health - 30;
          if (newHealth <= 0) {
            clearInterval(ally.attackInterval);
            ally.element.remove();
            allies = allies.filter(a => a !== ally);
            allyHealth.delete(ally.element);
          } else {
            allyHealth.set(ally.element, newHealth);
          }
        }
      }
    });
    setTimeout(() => shockwave.remove(), 500);
  }, 500);
}
function activateHardMode() {
  if (hardModeActive) return;
  hardModeActive = true;
  megalovania.play();
  const healInterval = setInterval(() => {
    if (playerHealth < 100) {
      playerHealth = Math.min(100, playerHealth + 2);
      playerHealthFill.style.width = `${playerHealth}%`;
    }
  }, 1000);
  const sans = document.createElement('div');
  sans.className = 'sans';
  document.body.appendChild(sans);
  function updateSansPosition() {
    const marioRect = mario.getBoundingClientRect();
    sans.style.left = marioRect.left - 150 + 'px';
    sans.style.top = marioRect.top - 150 + 'px';
  }
  function sansAttack() {
    const bone = document.createElement('div');
    bone.className = 'sans-attack';
    document.body.appendChild(bone);
    const marioRect = mario.getBoundingClientRect();
    const angle = Math.random() * Math.PI * 2;
    const distance = 300;
    const startX = marioRect.left + marioRect.width / 2 + Math.cos(angle) * distance;
    const startY = marioRect.top + marioRect.height / 2 + Math.sin(angle) * distance;
    bone.style.left = startX + 'px';
    bone.style.top = startY + 'px';
    let speed = 10;
    let homing = false;
    let damage = 10;
    let bouncing = true;
    let bounceCount = 0;
    const randomAngle = Math.random() * Math.PI * 2;
    let dx = Math.cos(randomAngle) * speed;
    let dy = Math.sin(randomAngle) * speed;
    function moveBone() {
      const currentX = parseFloat(bone.style.left);
      const currentY = parseFloat(bone.style.top);
      if (homing) {
        const targetX = mouseX;
        const targetY = mouseY;
        const moveAngle = Math.atan2(targetY - currentY, targetX - currentX);
        dx = Math.cos(moveAngle) * speed;
        dy = Math.sin(moveAngle) * speed;
        bouncing = false;
      }
      if (bouncing) {
        if (currentX <= 0 || currentX >= window.innerWidth) {
          dx = -dx;
          bounceCount++;
        }
        if (currentY <= 0 || currentY >= window.innerHeight) {
          dy = -dy;
          bounceCount++;
        }
        if (bounceCount >= 2) {
          bone.remove();
          return;
        }
      }
      bone.style.left = currentX + dx + 'px';
      bone.style.top = currentY + dy + 'px';
      const distance = Math.hypot(mouseX - currentX, mouseY - currentY);
      if (distance < 30) {
        bone.remove();
        damagePlayer(damage);
        return;
      }
      if (!bouncing && (currentX < 0 || currentX > window.innerWidth || currentY < 0 || currentY > window.innerHeight)) {
        bone.remove();
        return;
      }
      requestAnimationFrame(moveBone);
    }
    bone.updateHoming = shouldHome => {
      homing = shouldHome;
      speed = shouldHome ? 7 : 10;
      damage = shouldHome ? 100 : 10;
      bouncing = !shouldHome;
    };
    moveBone();
  }
  sansInterval = setInterval(sansAttack, 500);
  setInterval(updateSansPosition, 16);
  setTimeout(() => {
    clearInterval(healInterval);
  }, 10000);
}
function createImpostorScreen() {
  const deathScreen = document.createElement('div');
  deathScreen.className = 'imposter-death';
  const overlay = document.createElement('div');
  overlay.className = 'imposter-overlay';
  for (let i = 0; i < 100; i++) {
    const impostor = document.createElement('div');
    impostor.className = 'imposter-image';
    overlay.appendChild(impostor);
  }
  deathScreen.appendChild(overlay);
  const restartBtn = document.createElement('button');
  restartBtn.className = 'imposter-restart-btn';
  restartBtn.textContent = 'Restart (Disabled for 5 minutes)';
  deathScreen.appendChild(restartBtn);
  document.body.appendChild(deathScreen);
  scream.loop = true;
  scream.play();
  const wiishop = document.getElementById('wiishop');
  wiishop.play();
  mario.style.display = 'none';
  document.querySelectorAll('.weapon-btn, .ally-button').forEach(btn => {
    btn.disabled = true;
  });
  setTimeout(() => {
    restartBtn.style.opacity = '1';
    restartBtn.style.cursor = 'pointer';
    restartBtn.disabled = false;
    restartBtn.textContent = 'Restart';
    restartBtn.onclick = () => {
      deathScreen.remove();
      scream.pause();
      scream.loop = false;
      wiishop.pause();
      restartGame();
    };
  }, 300000);
}
function summonWarioApparition() {
  if (warioInterval) return;
  warioApparition = document.querySelector('.wario-apparition');
  warioApparition.style.display = 'block';
  const warioOverlay = document.createElement('div');
  warioOverlay.className = 'wario-overlay';
  document.body.appendChild(warioOverlay);
  setTimeout(() => {
    warioOverlay.remove();
    warioInterval = setInterval(() => {
      const playerX = mouseX;
      const playerY = mouseY;
      const warioRect = warioApparition.getBoundingClientRect();
      const warioX = warioRect.left;
      const warioY = warioRect.top;
      const angle = Math.atan2(playerY - warioY, playerX - warioX);
      const speed = 5;
      const newX = warioX + Math.cos(angle) * speed;
      const newY = warioY + Math.sin(angle) * speed;
      warioApparition.style.left = newX + 'px';
      warioApparition.style.top = newY + 'px';
      const distance = Math.hypot(playerX - newX, playerY - newY);
      if (distance < 50) {
        damagePlayer(10);
        createSpeechBubble("WARIO TIME!", warioApparition);
      }
    }, 16);
    setTimeout(() => {
      if (warioInterval) {
        clearInterval(warioInterval);
        warioInterval = null;
      }
      warioApparition.style.display = 'none';
    }, 10000);
  }, 3000);
}
function createPeanutButterJellyTime() {
  const banana = document.createElement('div');
  banana.className = 'dancing-banana';
  document.body.appendChild(banana);
  const song = document.getElementById('pbjt');
  song.play();
  let healingInterval = null;
  const projectileInterval = setInterval(() => {
    for (let i = 0; i < 8; i++) {
      if (Math.random() < 0.3) {
        const jelly = document.createElement('div');
        jelly.className = 'jelly';
        document.body.appendChild(jelly);
        const angle = Math.PI * 2 / 8 * i;
        const startX = window.innerWidth / 2 + Math.cos(angle) * 200;
        const startY = window.innerHeight / 2 + Math.sin(angle) * 200;
        jelly.style.left = startX + 'px';
        jelly.style.top = startY + 'px';
        const speed = 6;
        const dx = Math.cos(angle) * speed;
        const dy = Math.sin(angle) * speed;
        const moveJelly = () => {
          const currentX = parseFloat(jelly.style.left);
          const currentY = parseFloat(jelly.style.top);
          jelly.style.left = currentX + dx + 'px';
          jelly.style.top = currentY + dy + 'px';
          const distance = Math.hypot(mouseX - currentX, mouseY - currentY);
          if (distance < 30) {
            jelly.remove();
            playerHealth = Math.min(100, playerHealth + 15);
            playerHealthFill.style.width = `${playerHealth}%`;
            return;
          }
          if (currentX < 0 || currentX > window.innerWidth || currentY < 0 || currentY > window.innerHeight) {
            jelly.remove();
            return;
          }
          requestAnimationFrame(moveJelly);
        };
        moveJelly();
      } else {
        const projectile = document.createElement('div');
        projectile.className = 'banana-projectile';
        document.body.appendChild(projectile);
        const angle = Math.PI * 2 / 8 * i;
        const startX = window.innerWidth / 2 + Math.cos(angle) * 200;
        const startY = window.innerHeight / 2 + Math.sin(angle) * 200;
        projectile.style.left = startX + 'px';
        projectile.style.top = startY + 'px';
        const speed = 8;
        const dx = Math.cos(angle) * speed;
        const dy = Math.sin(angle) * speed;
        const move = () => {
          const currentX = parseFloat(projectile.style.left);
          const currentY = parseFloat(projectile.style.top);
          projectile.style.left = currentX + dx + 'px';
          projectile.style.top = currentY + dy + 'px';
          const distance = Math.hypot(mouseX - currentX, mouseY - currentY);
          if (distance < 30) {
            projectile.remove();
            damagePlayer(10);
            return;
          }
          if (currentX < 0 || currentX > window.innerWidth || currentY < 0 || currentY > window.innerHeight) {
            projectile.remove();
            return;
          }
          requestAnimationFrame(move);
        };
        move();
      }
    }
  }, 500);
  setTimeout(() => {
    clearInterval(projectileInterval);
    banana.remove();
    song.pause();
    song.currentTime = 0;
  }, 10000);
}
function playKSISong() {
  if (weaponsAreFrozen) return;
  ksiSong.play();
  let snowInterval = setInterval(createSnowflakes, 100);
  ksiBtn.disabled = true;
  ksiBtn.classList.add('cooldown');
  const shardInterval = setInterval(() => {
    const shard = document.createElement('div');
    shard.className = 'ice-shard';
    document.body.appendChild(shard);
    const side = Math.floor(Math.random() * 4);
    let startX, startY;
    switch (side) {
      case 0:
        startX = Math.random() * window.innerWidth;
        startY = 0;
        break;
      case 1:
        startX = window.innerWidth;
        startY = Math.random() * window.innerHeight;
        break;
      case 2:
        startX = Math.random() * window.innerWidth;
        startY = window.innerHeight;
        break;
      case 3:
        startX = 0;
        startY = Math.random() * window.innerHeight;
        break;
    }
    shard.style.left = startX + 'px';
    shard.style.top = startY + 'px';
    const angle = Math.random() * Math.PI * 2;
    const speed = 2;
    const dx = Math.cos(angle) * speed;
    const dy = Math.sin(angle) * speed;
    const moveShard = () => {
      const currentX = parseFloat(shard.style.left);
      const currentY = parseFloat(shard.style.top);
      shard.style.left = currentX + dx + 'px';
      shard.style.top = currentY + dy + 'px';
      const distance = Math.hypot(mouseX - currentX, mouseY - currentY);
      if (distance < 30) {
        shard.remove();
        damagePlayer(5);
        return;
      }
      if (currentX < -50 || currentX > window.innerWidth + 50 || currentY < -50 || currentY > window.innerHeight + 50) {
        shard.remove();
        return;
      }
      requestAnimationFrame(moveShard);
    };
    moveShard();
  }, 200);
  ksiSong.addEventListener('ended', () => {
    clearInterval(snowInterval);
    document.querySelectorAll('.snowflake').forEach(flake => flake.remove());
    clearInterval(shardInterval);
    document.querySelectorAll('.ice-shard').forEach(shard => shard.remove());
    marioHealth = 0;
    handleWin();
    createSpeechBubble("NO! Not the KSI song!");
    ksiBtn.disabled = false;
    ksiBtn.classList.remove('cooldown');
  }, {
    once: true
  });
}
function createSnowflakes() {
  const flake = document.createElement('div');
  flake.className = 'snowflake';
  flake.innerHTML = '❄';
  flake.style.left = Math.random() * 100 + '%';
  flake.style.animationDuration = Math.random() * 3 + 2 + 's';
  flake.style.opacity = Math.random();
  document.body.appendChild(flake);
  flake.addEventListener('animationend', () => flake.remove());
}
hammerBtn.addEventListener('click', e => {
  if (weaponsAreFrozen) return;
  const marioRect = mario.getBoundingClientRect();
  createHammer(marioRect.left + marioRect.width / 2, marioRect.top);
});
fireballBtn.addEventListener('click', e => {
  if (weaponsAreFrozen) return;
  shootPlayerFireball(e);
});
thwompBtn.addEventListener('click', e => {
  if (weaponsAreFrozen) return;
  const marioRect = mario.getBoundingClientRect();
  createThwomp(marioRect.left);
});
nerdBtn.addEventListener('click', () => {
  if (!weaponsAreFrozen) {
    createAlly('nerd');
  }
});
peterBtn.addEventListener('click', () => {
  if (!weaponsAreFrozen) {
    createAlly('peter');
  }
});
mrbeastBtn.addEventListener('click', () => {
  if (!weaponsAreFrozen) {
    createAlly('mrbeast');
  }
});
gunBtn.addEventListener('click', shootGun);
chickenBtn.addEventListener('click', () => {
  if (!weaponsAreFrozen) {
    createAlly('chicken');
  }
});
oldmanBtn.addEventListener('click', () => {
  if (!weaponsAreFrozen) {
    showTaxPopup();
  }
});
warioFartBtn.addEventListener('click', () => {
  if (!weaponsAreFrozen) {
    const marioRect = mario.getBoundingClientRect();
    createMegaFart(marioRect.left + marioRect.width / 2, marioRect.top + marioRect.height / 2);
  }
});
warioBtn.addEventListener('click', () => {
  if (!weaponsAreFrozen) {
    summonWarioApparition();
  }
});
sansBtn.addEventListener('click', activateHardMode);
ksiBtn.addEventListener('click', playKSISong);
document.addEventListener('mousedown', startDragging);
document.addEventListener('mousemove', e => {
  mouseX = e.clientX;
  mouseY = e.clientY;
});
document.addEventListener('mouseup', stopDragging);
document.addEventListener('mouseleave', stopDragging);
chatInput.addEventListener('keypress', e => {
  if (e.key === 'Enter') {
    sendMessage();
  }
});
document.addEventListener('click', function initAudio() {
  if (!hasAudioPermission) {
    try {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      hasAudioPermission = true;
      document.getElementById('audio-notice').style.display = 'none';
    } catch (e) {
      console.error('Could not initialize audio context:', e);
    }
  }
  castleTheme.play().catch(console.error);
  document.removeEventListener('click', initAudio);
}, {
  once: true
});
mario.addEventListener('click', () => {
  if (mario.classList.contains('star')) {
    damagePlayer(100);
    createSpeechBubble("STAR POWER!");
    return;
  }
  hitMario(1, 'poke');
  painLevel = Math.min(painLevel + 1, 100);
  updatePainMeter();
});
updatePainMeter();</script>
</body></html>
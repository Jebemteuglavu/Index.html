<style>
    body {
        font-family: 'Comic Sans MS', cursive, sans-serif;
        background-color: #FFF0F5;
        margin: 0;
        padding: 0;
        min-height: 100vh;
    }

    .header {
        background-color: #FFB6C1;
        padding: 20px;
        text-align: center;
        position: relative;
    }

    .online-users {
        position: fixed;
        left: 10px;
        top: 10px;
        background: rgba(255, 182, 193, 0.9);
        padding: 10px;
        border-radius: 10px;
        max-width: 200px;
        z-index: 1000;
    }

    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin: 5px;
        border: 2px solid #FF69B4;
    }

    .angy-meter {
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        width: 200px;
        height: 30px;
        background: #fff;
        border-radius: 15px;
        border: 2px solid #FF69B4;
        overflow: hidden;
    }

    .angy-level {
        height: 100%;
        width: 50%;
        background: #FF69B4;
        transition: width 0.3s ease;
    }

    .pin-board {
        background: #8B4513;
        margin: 20px auto;
        padding: 20px;
        max-width: 1200px;
        min-height: 600px;
        border: 15px solid #654321;
        border-radius: 10px;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
        position: relative;
    }

    .pin {
        background: white;
        padding: 10px;
        box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        transform: rotate(var(--rotation));
        transition: transform 0.3s ease;
        position: relative;
        cursor: pointer;
    }

    .pin-author {
        position: absolute;
        bottom: -20px;
        left: 50%;
        transform: translateX(-50%);
        background: #FF69B4;
        padding: 2px 8px;
        border-radius: 10px;
        color: white;
        font-size: 0.8em;
    }

    .pin::before {
        content: '';
        position: absolute;
        top: -10px;
        left: 50%;
        transform: translateX(-50%);
        width: 10px;
        height: 10px;
        background: #FF0000;
        border-radius: 50%;
        box-shadow: 0 2px 2px rgba(0,0,0,0.2);
    }

    .pin img {
        width: 100%;
        height: auto;
        display: block;
    }

    .pin:hover {
        transform: scale(1.1) rotate(var(--rotation));
        z-index: 100;
    }

    .upload-area {
        text-align: center;
        padding: 20px;
        background: rgba(255,255,255,0.8);
        border-radius: 10px;
        margin: 20px auto;
        max-width: 400px;
    }

    .upload-btn {
        background: #FF69B4;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1.1em;
    }

    .upload-btn:hover {
        background: #FF1493;
    }

    .angy-kitty {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 100px;
        height: 100px;
        transition: transform 0.3s ease;
    }

    @keyframes shake {
        0% { transform: translate(0, 0) rotate(0deg); }
        25% { transform: translate(5px, 5px) rotate(5deg); }
        50% { transform: translate(0, 0) rotate(0deg); }
        75% { transform: translate(-5px, 5px) rotate(-5deg); }
        100% { transform: translate(0, 0) rotate(0deg); }
    }

    .shake {
        animation: shake 0.5s ease infinite;
    }
</style>
</head>
<body>
    <div class="online-users" id="onlineUsers">
        <h3>Online Pinners</h3>
        <!-- Users will be added here dynamically -->
    </div>

    <div class="header">
        <h1>Angy Kitty's Multiplayer Pin Board</h1>
        <div class="angy-meter">
            <div class="angy-level" id="angyLevel"></div>
        </div>
    </div>

    <div class="upload-area">
        <input type="file" id="imageUpload" accept="image/*" style="display: none">
        <button class="upload-btn" onclick="document.getElementById('imageUpload').click()">Add New Pin</button>
    </div>

    <div class="pin-board" id="pinBoard">
        <!-- Pins will be added here dynamically -->
    </div>

    <svg class="angy-kitty" viewBox="0 0 100 100" id="angyKitty">
        <circle cx="50" cy="50" r="45" fill="#808080"/>
        <circle cx="35" cy="40" r="8" fill="yellow"/>
        <circle cx="65" cy="40" r="8" fill="yellow"/>
        <circle cx="35" cy="40" r="4" fill="black"/>
        <circle cx="65" cy="40" r="4" fill="black"/>
        <path d="M 40 60 Q 50 70 60 60" stroke="black" fill="none" stroke-width="3"/>
    </svg>

<script>
const room = new WebsimSocket();
let angyLevel = 50;

const triggerImages = {
    'dog': 80,
    'cucumber': 100,
    'water': 90,
    'bath': 95,
    'vacuum': 85
};

// Initialize the store with default angy level
room.store.update({
    id: 'angyLevel',
    dependencies: { angyLevel },
    updateFunction: (currentLevel) => currentLevel || angyLevel
});

// Initialize pins store
room.store.update({
    id: 'pins',
    dependencies: {},
    updateFunction: (currentPins) => currentPins || []
});

// Update online users when peers change
room.onPeersChanged = (peers) => {
    const usersContainer = document.getElementById('onlineUsers');
    usersContainer.innerHTML = '<h3>Online Pinners</h3>';
    
    Object.entries(peers).forEach(([clientId, {avatarUrl, username}]) => {
        const userElement = document.createElement('div');
        userElement.style.display = 'flex';
        userElement.style.alignItems = 'center';
        userElement.style.marginBottom = '5px';
        
        const avatar = document.createElement('img');
        avatar.src = avatarUrl;
        avatar.className = 'user-avatar';
        
        const name = document.createElement('span');
        name.textContent = username;
        name.style.marginLeft = '10px';
        
        userElement.appendChild(avatar);
        userElement.appendChild(name);
        usersContainer.appendChild(userElement);
    });
};

// Handle incoming messages
room.onmessage = (event) => {
    const data = event.data;
    if (data.type === 'newPin') {
        addNewPin(data.imageUrl, data.username, false);
    } else if (data.type === 'updateAngy') {
        updateAngyLevel(data.level, false);
    }
};

// Handle store changes
room.onRecordChanged = async (id) => {
    if (id === 'pins') {
        const store = await room.store.getAll();
        renderPins(store.pins);
    } else if (id === 'angyLevel') {
        const store = await room.store.getAll();
        updateAngyLevel(store.angyLevel, false);
    }
};

document.getElementById('imageUpload').addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (!file) return;

    try {
        // Upload file and get URL
        const imageUrl = await websim.upload(file);
        
        // Add pin to store
        room.store.update({
            id: 'pins',
            dependencies: { 
                imageUrl, 
                username: room.party.client.username 
            },
            updateFunction: (pins) => {
                if (!pins) pins = [];
                return [...pins, { imageUrl, username, rotation: Math.random() * 30 - 15 }];
            }
        });

        // Broadcast new pin
        room.send({
            type: 'newPin',
            imageUrl,
            username: room.party.client.username
        });

        // Check for trigger words
        const filename = file.name.toLowerCase();
        for (const [trigger, level] of Object.entries(triggerImages)) {
            if (filename.includes(trigger)) {
                updateAngyLevel(level, true);
                break;
            }
        }
    } catch (error) {
        console.error('Error uploading image:', error);
        alert('Failed to upload image!');
    }
});

function addNewPin(imageUrl, username, shouldUpdateStore = true) {
    if (shouldUpdateStore) {
        room.store.update({
            id: 'pins',
            dependencies: { imageUrl, username },
            updateFunction: (pins) => {
                if (!pins) pins = [];
                return [...pins, { imageUrl, username, rotation: Math.random() * 30 - 15 }];
            }
        });
    }

    const pinBoard = document.getElementById('pinBoard');
    const pin = document.createElement('div');
    pin.className = 'pin';
    pin.style.setProperty('--rotation', `${(Math.random() * 30 - 15)}deg`);

    const img = document.createElement('img');
    img.src = imageUrl;
    img.alt = 'Pinned image';
    
    const author = document.createElement('div');
    author.className = 'pin-author';
    author.textContent = username;
    
    pin.appendChild(img);
    pin.appendChild(author);
    pinBoard.appendChild(pin);

    makeDraggable(pin);
}

function renderPins(pins) {
    const pinBoard = document.getElementById('pinBoard');
    pinBoard.innerHTML = '';
    pins.forEach(pin => {
        addNewPin(pin.imageUrl, pin.username, false);
    });
}

function updateAngyLevel(level, shouldBroadcast = true) {
    if (shouldBroadcast) {
        room.store.update({
            id: 'angyLevel',
            dependencies: { level },
            updateFunction: () => level
        });

        room.send({
            type: 'updateAngy',
            level
        });
    }

    const angyLevelElement = document.getElementById('angyLevel');
    const angyKitty = document.getElementById('angyKitty');
    
    angyLevelElement.style.width = `${level}%`;
    
    if (level >= 80) {
        angyKitty.classList.add('shake');
        angyKitty.querySelector('circle').setAttribute('fill', `rgb(255, ${255 - level * 2}, ${255 - level * 2})`);
    } else {
        angyKitty.classList.remove('shake');
        angyKitty.querySelector('circle').setAttribute('fill', '#808080');
    }
}

function makeDraggable(pin) {
    let isDragging = false;
    let currentX;
    let currentY;
    let initialX;
    let initialY;
    let xOffset = 0;
    let yOffset = 0;

    pin.addEventListener('mousedown', dragStart);
    document.addEventListener('mousemove', drag);
    document.addEventListener('mouseup', dragEnd);

    function dragStart(e) {
        initialX = e.clientX - xOffset;
        initialY = e.clientY - yOffset;
        
        if (e.target === pin || pin.contains(e.target)) {
            isDragging = true;
            pin.style.zIndex = '1000';
        }
    }

    function drag(e) {
        if (isDragging) {
            e.preventDefault();
            currentX = e.clientX - initialX;
            currentY = e.clientY - initialY;

            xOffset = currentX;
            yOffset = currentY;

            setTranslate(currentX, currentY, pin);
        }
    }

    function setTranslate(xPos, yPos, el) {
        el.style.transform = `translate3d(${xPos}px, ${yPos}px, 0) rotate(var(--rotation))`;
    }

    function dragEnd() {
        if (isDragging) {
            initialX = currentX;
            initialY = currentY;
            isDragging = false;
            pin.style.zIndex = '1';
        }
    }
}

// Initial setup
async function initialize() {
    const store = await room.store.getAll();
    if (store.pins) {
        renderPins(store.pins);
    }
    if (store.angyLevel) {
        updateAngyLevel(store.angyLevel, false);
    }
}

initialize();
</script>
</body>
</html>
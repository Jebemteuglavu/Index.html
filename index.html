<title>Magicook</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600&display=swap');

* { box-sizing: border-box; }
body {
    font-family: 'Quicksand', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 20px;
    background: linear-gradient(135deg, #1a1c3d 0%, #2a1f54 100%);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    color: #e0e0ff;
}

/* Add this CSS for the dictionary sidebar */
.dictionary-sidebar {
    position: fixed;
    right: -300px; /* Start collapsed */
    top: 0;
    width: 300px;
    height: 100vh;
    background: rgba(26, 28, 61, 0.95);
    box-shadow: -5px 0 15px rgba(0,0,0,0.3);
    transition: right 0.3s ease;
    z-index: 900;
    overflow-y: auto;
    border-left: 1px solid rgba(255,255,255,0.1);
}

.dictionary-sidebar.open {
    right: 0;
}

.dictionary-toggle {
    position: fixed;
    right: 20px;
    top: 20px;
    background: rgba(26, 28, 61, 0.95);
    color: #ffd700;
    padding: 10px 20px;
    border-radius: 20px;
    cursor: pointer;
    z-index: 901;
    border: 1px solid rgba(255,255,255,0.1);
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
    transition: transform 0.2s;
    font-weight: 500;
    font-size: 1.1em;
}

.dictionary-toggle:hover {
    transform: scale(1.05);
}

.dictionary-content {
    padding: 20px;
}

.dictionary-header {
    color: #ffd700;
    text-align: center;
    margin-bottom: 20px;
    padding-top: 20px;
}

.ingredient-entry {
    background: rgba(255,255,255,0.05);
    border-radius: 10px;
    margin-bottom: 15px;
    padding: 15px;
    border: 1px solid rgba(255,255,255,0.1);
    transition: transform 0.2s;
}

.ingredient-entry:hover {
    transform: scale(1.02);
}

.ingredient-image {
    width: 80px;
    height: 80px;
    border-radius: 10px;
    margin-right: 15px;
    object-fit: cover;
}

.ingredient-info {
    display: flex;
    align-items: center;
}

.ingredient-name {
    color: #ffffff;
    font-size: 1.2em;
    margin-left: 10px;
    font-weight: 500;
    text-shadow: 0 0 10px rgba(0,0,0,0.3);
}

.game-container {
    background: rgba(255, 255, 255, 0.1);
    padding: 30px;
    border-radius: 20px;
    box-shadow: 0 0 30px rgba(0,0,0,0.3), 
                inset 0 0 20px rgba(255,255,255,0.1);
    max-width: 1000px;
    width: 100%;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.1);
}

h1 {
    text-align: center;
    color: #ffd700;
    text-shadow: 0 0 10px rgba(255,215,0,0.5);
    font-size: 2.5em;
    margin-bottom: 20px;
    font-family: 'Quicksand', sans-serif;
    font-weight: 600;
}

h2 {
    color: #ffd700;
    text-shadow: 0 0 10px rgba(255,215,0,0.3);
    font-size: 1.8em;
    margin-bottom: 15px;
    font-family: 'Quicksand', sans-serif;
    font-weight: 600;
}

p {
    text-align: center;
    color: #ffffff;
    font-style: italic;
    font-size: 1.1em;
    line-height: 1.6;
    text-shadow: 0 0 10px rgba(0,0,0,0.3);
    font-weight: 500;
}

.kitchen {
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin-bottom: 20px;
}

.cooking-area {
    position: relative;
    min-height: 300px;
    background: rgba(0,0,0,0.3);
    border-radius: 20px;
    padding: 20px;
    border: 1px solid rgba(255,255,255,0.1);
}

.pot {
    width: 200px;
    height: 150px;
    background: linear-gradient(45deg, #2c2c2c, #444);
    border-radius: 0 0 100px 100px;
    margin: 50px auto;
    position: relative;
    cursor: pointer;
    transition: transform 0.3s, box-shadow 0.3s;
    box-shadow: 0 10px 20px rgba(0,0,0,0.3);
}

.pot:before {
    content: '';
    position: absolute;
    top: -20px;
    left: -20px;
    right: -20px;
    height: 20px;
    background: linear-gradient(45deg, #3a3a3a, #555);
    border-radius: 10px;
}

.pot.active {
    transform: scale(1.05);
    box-shadow: 0 0 30px rgba(255,215,0,0.3);
}

.ingredient-controls {
    width: 100%;
    position: relative; /* Add this to contain the absolutely positioned trashcan */
}

.ingredients-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr); /* Changed from 10 to 5 */
    gap: 6px;
    background: rgba(255,255,255,0.05);
    padding: 20px;
    border-radius: 15px;
    margin-top: 20px;
    border: 1px solid rgba(255,255,255,0.1);
}

.grid-cell {
    aspect-ratio: 1;
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8em;
    cursor: move;
    transition: all 0.3s;
    padding: 4px;
    min-height: 80px; /* Increased from 50px to 80px */
}

.grid-cell img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    filter: drop-shadow(0 0 5px rgba(255,255,255,0.3));
}

.grid-cell:hover {
    transform: scale(1.05);
    box-shadow: 0 0 15px rgba(255,215,0,0.3);
    background: rgba(255,255,255,0.2);
}

.grid-cell.selected {
    transform: scale(1.05);
    box-shadow: 0 0 15px rgba(255,215,0,0.5);
    background: rgba(255,215,0,0.2);
    outline: 2px solid #ffd700;
}

.ingredient-bag {
    background: linear-gradient(45deg, #8b4513, #a0522d);
    width: 120px;
    height: 140px;
    margin: 20px auto;
    border-radius: 20px;
    position: relative;
    cursor: pointer;
    transition: transform 0.3s;
    box-shadow: 0 10px 20px rgba(0,0,0,0.3);
}

.ingredient-bag:before {
    content: '';
    position: absolute;
    top: -20px;
    left: 25px;
    right: 25px;
    height: 40px;
    background: linear-gradient(45deg, #8b4513, #a0522d);
    border-radius: 12px;
}

.ingredient-bag:hover {
    transform: scale(1.05);
    box-shadow: 0 0 30px rgba(139,69,19,0.5);
}

.discovered-recipes {
    margin-top: 30px;
    padding: 20px;
    background: rgba(0,0,0,0.2);
    border-radius: 15px;
    border: 1px solid rgba(255,255,255,0.1);
}

.recipe {
    padding: 15px;
    background: rgba(255,255,255,0.1);
    margin: 10px 0;
    border-radius: 10px;
    opacity: 0;
    transform: translateY(20px);
    animation: recipeReveal 0.5s forwards;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid rgba(255,255,255,0.1);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    font-weight: 500;
    text-shadow: 0 0 10px rgba(0,0,0,0.3);
}

.recipe:not(.discovered) {
    opacity: 0.8;
    background: rgba(255,255,255,0.05);
}

.recipe:not(.discovered) span {
    color: #cccccc;
}

.recipe-category {
    background: linear-gradient(45deg, #4CAF50, #45a049);
    color: white;
    padding: 5px 12px;
    border-radius: 15px;
    font-size: 0.9em;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    font-weight: 500;
    letter-spacing: 0.5px;
}

@keyframes recipeReveal {
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.grid-cell.dragging {
    opacity: 0.3;
}

.steam {
    position: absolute;
    top: 30px;
    left: 50%;
    transform: translateX(-50%);
    opacity: 0;
    transition: opacity 0.3s;
    filter: drop-shadow(0 0 5px rgba(255,255,255,0.5));
}

.steam.active {
    opacity: 0.7;
}

.failure-message {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255, 0, 0, 0.2);
    color: #ffffff;
    padding: 10px 20px;
    border-radius: 10px;
    animation: fadeInOut 2s ease-in-out;
    text-align: center;
    pointer-events: none;
    white-space: nowrap;
    border: 1px solid rgba(255, 0, 0, 0.3);
    box-shadow: 0 0 20px rgba(255, 0, 0, 0.2);
    font-weight: 500;
    text-shadow: 0 0 10px rgba(255,0,0,0.4);
}

@keyframes fadeInOut {
    0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
    10% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    90% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
}

.story-panel {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.95);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.panel-content {
    max-width: 800px;
    background: rgba(255, 255, 255, 0.1);
    padding: 30px;
    border-radius: 20px;
    box-shadow: 0 0 30px rgba(255,215,0,0.2);
    text-align: center;
    position: relative;
    border: 1px solid rgba(255,255,255,0.1);
    animation: panelFadeIn 0.5s ease-out;
}

.panel-image {
    width: 200px;
    height: 200px;
    margin: 20px auto;
    border-radius: 50%;
    overflow: hidden;
    background: rgba(255,255,255,0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 0 20px rgba(255,215,0,0.2);
}

.panel-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
    box-shadow: 0 0 20px rgba(255,215,0,0.2);
}

.panel-text {
    font-size: 1.2em;
    line-height: 1.8;
    margin: 20px 0;
    color: #ffffff;
    text-shadow: 0 0 10px rgba(0,0,0,0.3);
    font-weight: 500;
}

.next-button {
    background: linear-gradient(45deg, #ffd700, #ffa500);
    border: none;
    padding: 10px 30px;
    border-radius: 25px;
    color: #1a1c3d;
    font-size: 1.1em;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    margin-top: 20px;
}

.next-button:hover {
    transform: scale(1.05);
    box-shadow: 0 0 15px rgba(255,215,0,0.4);
}

@keyframes panelFadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.character {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    background: #ffd700;
    position: relative;
    overflow: hidden;
}

.character-ears {
    position: absolute;
    top: -20px;
    left: 50%;
    transform: translateX(-50%);
    width: 100px;
    height: 60px;
}

.ear {
    position: absolute;
    width: 40px;
    height: 40px;
    background: #ffd700;
    border-radius: 50%;
}

.ear.left {
    left: 0;
    transform: rotate(-30deg);
}

.ear.right {
    right: 0;
    transform: rotate(30deg);
}

.character-face {
    position: absolute;
    top: 40px;
    left: 50%;
    transform: translateX(-50%);
    width: 100px;
    height: 60px;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.eyes {
    display: flex;
    gap: 20px;
}

.eye {
    width: 20px;
    height: 20px;
    background: #1a1c3d;
    border-radius: 50%;
}

.smile {
    width: 40px;
    height: 20px;
    border-bottom: 4px solid #1a1c3d;
    border-radius: 0 0 20px 20px;
    margin-top: 10px;
}

.bag-glow {
    animation: glowPulse 2s infinite;
}

@keyframes glowPulse {
    0% { box-shadow: 0 0 20px rgba(255,215,0,0.2); }
    50% { box-shadow: 0 0 40px rgba(255,215,0,0.6); }
    100% { box-shadow: 0 0 20px rgba(255,215,0,0.2); }
}

.disclaimer-footer {
    margin-top: 40px;
    padding: 20px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 15px;
    text-align: center;
    font-size: 0.9em;
    color: #cccccc;
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    max-width: 1000px;
    width: 100%;
}

.disclaimer-footer p {
    margin: 5px 0;
    color: #cccccc;
    font-style: normal;
    text-shadow: none;
}

.disclaimer-footer .beta-tag {
    display: inline-block;
    background: rgba(255, 215, 0, 0.2);
    color: #ffd700;
    padding: 2px 8px;
    border-radius: 10px;
    margin: 0 5px;
    font-size: 0.9em;
}

.trashcan {
    width: 50px;
    height: 50px;
    position: absolute;
    right: -60px; /* Position it to the right of the bag */
    top: 50%;
    transform: translateY(-50%);
    cursor: pointer;
    transition: transform 0.3s;
}

.trashcan svg {
    width: 100%;
    height: 100%;
    filter: drop-shadow(0 0 3px rgba(255,255,255,0.3));
}

.trashcan:hover {
    transform: scale(1.1);
}

.trashcan.active {
    transform: scale(1.2);
    filter: drop-shadow(0 0 10px rgba(255,215,0,0.5));
}

/* Add this CSS for Fidwick's Thoughts panel */
.thoughts-panel {
    position: fixed;
    left: -300px; /* Start collapsed */
    top: 20px;
    width: 300px;
    background: rgba(26, 28, 61, 0.95);
    padding: 20px;
    border-radius: 0 20px 20px 0;
    box-shadow: 5px 0 15px rgba(0,0,0,0.3);
    transition: left 0.3s ease;
    z-index: 900;
}

.thoughts-panel.open {
    left: 0;
}

.thoughts-toggle {
    position: fixed;
    left: 20px;
    top: 20px;
    background: rgba(26, 28, 61, 0.95);
    color: #ffd700;
    padding: 10px 20px;
    border-radius: 20px;
    cursor: pointer;
    z-index: 901;
    border: 1px solid rgba(255,255,255,0.1);
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
    transition: transform 0.2s;
    font-weight: 500;
    font-size: 1.1em;
}

.thoughts-toggle:hover {
    transform: scale(1.05);
}

.hint-button {
    background: linear-gradient(45deg, #ffd700, #ffa500);
    border: none;
    padding: 10px 20px;
    border-radius: 15px;
    color: #1a1c3d;
    font-size: 1em;
    cursor: pointer;
    transition: transform 0.2s;
    width: 100%;
    margin-top: 10px;
}

.hint-button:hover {
    transform: scale(1.05);
}

.speech-bubble {
    position: relative;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 15px;
    padding: 15px;
    margin-top: 20px;
    border: 1px solid rgba(255,255,255,0.1);
    color: #ffffff;
    font-weight: 500;
    line-height: 1.6;
    text-shadow: 0 0 10px rgba(0,0,0,0.3);
    display: none;
    animation: bubbleFadeIn 0.3s ease-out;
}

.speech-bubble:before {
    content: '';
    position: absolute;
    top: -10px;
    left: 20px;
    border-bottom: 10px solid rgba(255, 255, 255, 0.1);
    border-left: 10px solid transparent;
    border-right: 10px solid transparent;
}

@keyframes bubbleFadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Add CSS for the Storybook panel */
.storybook-toggle {
    position: fixed;
    right: 20px;
    top: 80px; /* Position it below the Dictionary toggle */
    background: rgba(26, 28, 61, 0.95);
    color: #ffd700;
    padding: 10px 20px;
    border-radius: 20px;
    cursor: pointer;
    z-index: 901;
    border: 1px solid rgba(255,255,255,0.1);
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
    transition: transform 0.2s;
    font-weight: 500;
    font-size: 1.1em;
}

.storybook-toggle:hover {
    transform: scale(1.05);
}

.storybook-panel {
    position: fixed;
    right: -300px;
    top: 80px;
    width: 300px;
    background: rgba(26, 28, 61, 0.95);
    padding: 20px;
    border-radius: 0 0 0 20px;
    box-shadow: 5px 0 15px rgba(0,0,0,0.3);
    transition: right 0.3s ease;
    z-index: 899;
    border-left: 1px solid rgba(255,255,255,0.1);
}

.storybook-panel.open {
    right: 0;
}

.story-chapter {
    background: rgba(255,255,255,0.05);
    border-radius: 10px;
    margin-bottom: 15px;
    padding: 15px;
    border: 1px solid rgba(255,255,255,0.1);
    cursor: pointer;
    transition: transform 0.2s;
}

.story-chapter:hover {
    transform: scale(1.02);
    background: rgba(255,255,255,0.1);
}

.story-chapter.locked {
    opacity: 0.5;
    cursor: not-allowed;
}

.story-chapter-title {
    color: #ffd700;
    font-weight: 500;
    margin-bottom: 5px;
}

.story-chapter-description {
    color: #e0e0ff;
    font-size: 0.9em;
}
</style>
</head>
<body>
<div class="thoughts-toggle">💭 Fidwick's Thoughts</div>
<div class="thoughts-panel">
    <h2>Fidwick's Thoughts</h2>
    <button class="hint-button">Give me a Hint!</button>
    <div class="speech-bubble"></div>
</div>
<div class="dictionary-toggle">📖 Dictionary</div>
<div class="dictionary-sidebar">
    <div class="dictionary-content">
        <h2 class="dictionary-header">📚 Ingredient Dictionary</h2>
        <div id="ingredientList">
            <!-- Ingredients will be populated here -->
        </div>
    </div>
</div>
<div class="storybook-toggle">📚 Storybook</div>
<div class="storybook-panel">
    <div class="dictionary-content">
        <h2 class="dictionary-header">📚 Storybook</h2>
        <div id="storyChapters">
            <!-- Chapters will be populated here -->
        </div>
    </div>
</div>
<div class="game-container">
    <h1>✨ Magicook ✨</h1>
    <p>🌟 Use the Wishing Bag to conjure ingredients, then combine them in your magical cooking pot! Clean up with the trusty trashcan if needed. 🌟</p>
    
    <div class="kitchen">
        <div class="cooking-area" id="cookingArea">
            <div class="pot" id="pot">
                <svg class="steam" width="100" height="100" viewBox="0 0 100 100">
                    <path d="M30,90 Q50,40 70,90" fill="none" stroke="rgba(255,255,255,0.6)" stroke-width="3">
                        <animate attributeName="d" 
                                dur="3s" 
                                repeatCount="indefinite"
                                values="M30,90 Q50,40 70,90;
                                        M30,90 Q50,20 70,90;
                                        M30,90 Q50,40 70,90"/>
                    </path>
                </svg>
            </div>
            <div class="current-ingredients empty" id="currentIngredients"></div>
        </div>
        <div class="ingredient-controls">
            <div class="ingredient-bag" id="ingredientBag"></div>
            <div class="trashcan" id="trashcan">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 6h18" stroke="#e0e0ff"/>
                    <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2" stroke="#e0e0ff"/>
                    <path d="M10 11v6M14 11v6" stroke="#e0e0ff"/>
                </svg>
            </div>
            <div class="ingredients-grid" id="ingredientsGrid">
                <!-- 5x5 grid will be generated here -->
            </div>
        </div>
    </div>
    
    <div class="discovered-recipes" id="discoveredRecipes">
        <h2>📖 Recipe Book</h2>
    </div>

    <div class="disclaimer-footer">
        <p><span class="beta-tag">BETA</span> This game is currently in early development</p>
        <p>Many core features and mechanics are still being implemented. Stay tuned for future updates!</p>
    </div>
</div>

<script>
const ingredients = [
    {name: 'Smogthorn Coral', image: '/Smogthorn Coral Lv1.jpeg'},
    {name: 'Amethyst Reed', image: '/Amethyst Reed Lv1.jpeg'},
    {name: 'Ashmore Tulip', image: '/Ashmore Tulip Lv1.jpeg'},
    {name: 'Starstruck Mushroom', image: '/Starstruck Mushroom Lv1.jpeg'},
    {name: 'Mintmoss', image: '/Mintmoss Lv1.jpeg'},
    {name: 'Vaporwhiff Berries', image: '/Vaporwhiff Berries Lv1.jpeg'},
    {name: 'Liquid Mana', image: '/Liquid Mana Lv1.jpeg'},
    {name: 'Sunray Broth', image: '/Sunray Broth Lv1.jpeg'},
    {name: 'Pureblessed Flour', image: '/Pureblessed Flour Lv1.jpeg'},
    {name: 'Firecracker Beans', image: '/Firecracker Beans Lv1.jpeg'},
    {name: 'Solarweave Petals', image: '/Solarweave Petals.jpeg'},
    {name: 'Obsidian Cinder', image: '/Obsidian Cinder.jpeg'},
    {name: 'Dewfyre Thistle', image: '/Dewfyre Thistle.jpeg'},
    {name: 'Luminroot', image: '/Luminroot.jpeg'},
    {name: 'Aurora Fern', image: '/Aurora Fern.jpeg'},
    {name: 'Ironwood Toadstool', image: '/Ironwood Toadstool.jpeg'},
    {name: 'Zephyrvine', image: '/Zephyrvine.jpeg'},
    {name: 'Gravestone Lilac', image: '/Gravestone Lilac.jpeg'},
    {name: 'Dragonvine Bramble', image: '/Dragonvine Bramble.jpeg'},
    {name: 'Ebonfeather Moss', image: '/Ebonfeather Moss.jpeg'},
    {name: 'Shardling Ivy', image: '/Shardling Ivy.jpeg'},
    {name: 'Amberglow Sap', image: '/Amberglow Sap.jpeg'},
    {name: 'Chimeric Nectar', image: '/Chimeric Nectar.jpeg'},
    {name: 'Echoleaf', image: '/Echoleaf.jpeg'}
];

const recipes = {
    'main': {
        'Firecracker Beans': {type: 'Coffees', code: 'A'},
        'Liquid Mana': {type: 'Smoothies', code: 'B'},
        'Sunray Broth': {type: 'Stews', code: 'C'},
        'Pureblessed Flour': {type: 'Pies', code: 'D'}
    },
    'secondary': {
        'Mintmoss': '1',
        'Vaporwhiff Berries': '2',
        'Starstruck Mushroom': '3',
        'Amethyst Reed': '4',
        'Smogthorn Coral': '5',
        'Ashmore Tulip': '6',
        'Solarweave Petals': '7',
        'Obsidian Cinder': '8',
        'Dewfyre Thistle': '9',
        'Luminroot': '10',
        'Aurora Fern': '11',
        'Ironwood Toadstool': '12',
        'Zephyrvine': '13',
        'Gravestone Lilac': '14',
        'Dragonvine Bramble': '15',
        'Ebonfeather Moss': '16',
        'Shardling Ivy': '17',
        'Amberglow Sap': '18',
        'Chimeric Nectar': '19',
        'Echoleaf': '20'
    },
    'combinations': {
        'Coffees': {
            '1A': '☕ Stonespear Cappuccino',
            '6A': '🔥 The Devil\'s Brew',
            '7A': '☀️ Wakeup Call',
            '14A': '📚 Necronomicup',
            '20A': '🎵 Lo-fi Tea'
        },
        'Smoothies': {
            '2B': '🫧 Misty Bubble Tea',
            '10B': '⚡ Gigawatt Shake',
            '11B': '💃 Dancer\'s Delight',
            '13B': '👅 Tongue Twister',
            '18B': '🦕 Fossilized Milkshake'
        },
        'Stews': {
            '3C': '🌒 Cream of Eclipse Soup',
            '5C': '🌊 Ocean\'s Potluck',
            '8C': '🕳️ The Deep End',
            '12C': '⚔️ The Warrior\'s Special',
            '16C': '🌟 Cream of the Crop'
        },
        'Pies': {
            '4D': '💎 Crystalized Pie',
            '9D': '❄️ Chilly Cheesecake',
            '15D': '🐉 Dragon Scale Surprise',
            '17D': '✨ Shimmering Icecream Cake',
            '19D': '🍯 Ever-changing Honey Pie'
        }
    }
};

const finalStoryChapters = {
    chapter3: [
        {
            text: "Fifi Fiddlemin always had a weird reaction to strangers. Amelie could swear that strangers always looked at her weirdly when talking to Fifi, as if Amelie was talking to herself.",
            image: "/Fifi Fiddlemin.jpeg"
        },
        {
            text: "Amelie didn't care. After all, As long as she had Fifi, her life would be fulfilled and the worries would always go away. Right?",
            image: "/Fifi Fiddlemin.jpeg"
        }
    ],
    chapter4: [
        {
            text: "Amelie began to wonder if this was worth the effort. What if Fifi rejects her? What if she never works up the courage to ask. What if there was...",
            image: "/Amelie Fidwick Tanuki.jpeg"
        },
        {
            text: "Amelie remembers why she might not be able to ask her out. Regardless, she prepares for the last few recipes. It's almost time to come to terms with the truth.",
            image: "/Amelie Fidwick Tanuki.jpeg"
        }
    ],
    chapter5: [
        {
            text: "Amelie, after completing the recipe book, went to where her friend Fifi was residing. She walked by stone after stone until she found it.",
            image: "/Gravestone Lilac.jpeg"
        },
        {
            text: "Fifi Fiddlemin... 199X to 20XX. She laid the recipe book on the dirt below the grave and gave one final tear.",
            image: "/Fifi Fiddlemin.jpeg"
        },
        {
            text: "If this didn't let Fifi know about Amelie's true feelings... Then she'd have to wait until Amelie joins her in the sky. THE END.",
            image: "/Fifi Fiddlemin.jpeg"
        }
    ]
};

let currentIngredients = [];
let discoveredRecipes = new Set();
let selectedCell = null;

const storyPanels = [
    {
        text: "Meet Amelie 'Fidwick' Tanuki, a passionate cook who dreams of creating the most delicious food in the world to impress her dear friend.",
        image: "/Amelie Fidwick Tanuki.jpeg"
    },
    {
        text: "She searched far and wide for special ingredients, but her quest seemed hopeless... until she found a mysterious bag.",
        image: "/Wishing Bag.jpeg"
    },
    {
        text: "'I wish I could just find these ingredients,' she sighed. Suddenly, the bag began to shimmer with magical light!",
        image: "/Wishing Bag.jpeg"
    },
    {
        text: "To her amazement, when she reached into the bag... WAZAM! The very ingredients she desired appeared! She had discovered a magical WISHING bag!",
        image: "/Wishing Bag.jpeg"
    },
    {
        text: "Excited by her discovery, Amelie rushed home to her trusty cooking pot, ready to create magical recipes never seen before!",
        image: "/Wishing Bag.jpeg"
    }
];

const fifiStoryPanels = [
    {
        text: "With each successful recipe, Amelie's heart fluttered thinking of showing her creations to Fifi Fiddlemin, the traveling photographer who unknowingly held her heart.",
        image: "/Fifi Fiddlemin.jpeg"
    },
    {
        text: "Fifi would breeze into town like a cheerful cardinal, bringing tales of magical ingredients and recipes from far-off lands. Her stories sparked Amelie's imagination... and something more.",
        image: "/Fifi Fiddlemin.jpeg"
    },
    {
        text: "While Fifi remained charmingly oblivious, eagerly sampling Amelie's cooking and sharing stories, Amelie's feelings grew stronger with each shared moment.",
        image: "/Fifi Fiddlemin.jpeg"
    },
    {
        text: "Perhaps, Amelie thought, with these magical recipes, she could finally find the courage to tell Fifi how special she truly was...",
        image: "/Fifi Fiddlemin.jpeg"
    }
];

function showStoryPanel(index) {
    if (index >= storyPanels.length) {
        return;
    }

    const panel = document.createElement('div');
    panel.className = 'story-panel';
    
    const content = document.createElement('div');
    content.className = 'panel-content';
    
    const imageContainer = document.createElement('div');
    imageContainer.className = 'panel-image';
    
    // Create and add the image
    const img = document.createElement('img');
    img.src = storyPanels[index].image;
    img.style.width = '100%';
    img.style.height = '100%';
    img.style.objectFit = 'cover';
    img.style.borderRadius = '50%';
    imageContainer.appendChild(img);
    
    const text = document.createElement('p');
    text.className = 'panel-text';
    text.textContent = storyPanels[index].text;
    
    const button = document.createElement('button');
    button.className = 'next-button';
    button.textContent = index === storyPanels.length - 1 ? 'Start Cooking!' : 'Next';
    
    button.addEventListener('click', () => {
        panel.remove();
        if (index < storyPanels.length - 1) {
            showStoryPanel(index + 1);
        }
    });
    
    content.appendChild(imageContainer);
    content.appendChild(text);
    content.appendChild(button);
    panel.appendChild(content);
    document.body.appendChild(panel);
}

function isMainIngredient(ingredient) {
    return ingredient in recipes.main;
}

function getRecipeCategory(mainIngredient) {
    return recipes.main[mainIngredient].type;
}

function canMakeCombination(mainIngredient, secondaryIngredient) {
    const mainCode = recipes.main[mainIngredient].code;
    const secondaryCode = recipes.secondary[secondaryIngredient];
    
    // Create the recipe code by combining secondary + main
    const recipeCode = secondaryCode + mainCode;
    const recipeCategory = recipes.main[mainIngredient].type;
    
    return recipes.combinations[recipeCategory]?.[recipeCode];
}

function updateCurrentIngredientsDisplay() {
    const display = document.getElementById('currentIngredients');
    if (currentIngredients.length === 0) {
        display.innerHTML = '';
        display.classList.add('empty');
    } else {
        display.classList.remove('empty');
        display.innerHTML = currentIngredients
            .map(ingredient => `<span>${ingredient}</span>`)
            .join(' + ');
    }
}

function initGrid() {
    const grid = document.getElementById('ingredientsGrid');
    for (let i = 0; i < 25; i++) { // Changed from 100 to 25 for 5x5 grid
        const cell = document.createElement('div');
        cell.className = 'grid-cell';
        cell.draggable = true;
        
        // Add click handler for mobile/touch support
        cell.addEventListener('click', () => {
            if (cell.dataset.ingredient) {
                selectIngredient(cell);
            }
        });
        
        cell.addEventListener('dragstart', (e) => {
            if (cell.dataset.ingredient) {
                cell.classList.add('dragging');
                e.dataTransfer.setData('text/plain', cell.dataset.ingredient);
            } else {
                e.preventDefault();
            }
        });
        
        cell.addEventListener('dragend', () => {
            cell.classList.remove('dragging');
        });
        
        grid.appendChild(cell);
    }
    initTrashcan(); // Initialize trashcan here
}

function initTrashcan() {
    const trashcan = document.getElementById('trashcan');
    // Move the trashcan element to be a sibling of the ingredient bag
    document.querySelector('.ingredient-controls').appendChild(trashcan);
    
    // Rest of the trashcan initialization code remains the same...
    const cookingArea = document.getElementById('cookingArea');

    trashcan.addEventListener('click', () => {
        if (selectedCell && selectedCell.dataset.ingredient) {
            selectedCell.innerHTML = '';
            selectedCell.dataset.ingredient = '';
            selectedCell.draggable = false;
            selectedCell.classList.remove('selected');
            selectedCell = null;
            updateCurrentIngredientsDisplay(); // Add this line
        }
    });

    // Add drag and drop support
    trashcan.addEventListener('dragover', (e) => {
        e.preventDefault();
        trashcan.classList.add('active');
    });

    trashcan.addEventListener('dragleave', () => {
        trashcan.classList.remove('active');
    });

    trashcan.addEventListener('drop', (e) => {
        e.preventDefault();
        trashcan.classList.remove('active');
        
        const draggedCell = document.querySelector('.grid-cell.dragging');
        if (draggedCell) {
            draggedCell.innerHTML = '';
            draggedCell.dataset.ingredient = '';
            draggedCell.draggable = false;
            updateCurrentIngredientsDisplay(); // Add this line
        }
    });
}

function selectIngredient(cell) {
    // Deselect if already selected
    if (selectedCell === cell) {
        selectedCell.classList.remove('selected');
        selectedCell = null;
        return;
    }
    
    // Remove previous selection
    if (selectedCell) {
        selectedCell.classList.remove('selected');
    }
    
    // Select new cell
    selectedCell = cell;
    cell.classList.add('selected');
}

function initPot() {
    const pot = document.getElementById('pot');
    const cookingArea = document.getElementById('cookingArea');
    
    pot.addEventListener('click', () => {
        if (selectedCell && selectedCell.dataset.ingredient) {
            // Remove any existing progress bar when starting fresh
            const existingProgress = document.querySelector('.cooking-progress');
            if (existingProgress) {
                existingProgress.remove();
            }
            
            const ingredient = selectedCell.dataset.ingredient;
            addIngredient(ingredient);
            
            selectedCell.innerHTML = '';
            selectedCell.dataset.ingredient = '';
            selectedCell.draggable = false;
            selectedCell.classList.remove('selected');
            selectedCell = null;
        }
    });
    
    cookingArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        pot.classList.add('active');
    });
    
    cookingArea.addEventListener('dragleave', () => {
        pot.classList.remove('active');
    });
    
    cookingArea.addEventListener('drop', (e) => {
        e.preventDefault();
        pot.classList.remove('active');
        
        const ingredient = e.dataTransfer.getData('text/plain');
        if (ingredient) {
            const draggedCell = document.querySelector('.grid-cell.dragging');
            if (draggedCell) {
                draggedCell.innerHTML = '';
                draggedCell.dataset.ingredient = '';
                draggedCell.draggable = false;
            }
            addIngredient(ingredient);
        }
    });
}

function startCookingProgress() {
    // Create progress bar if it doesn't exist
    let progressContainer = document.querySelector('.cooking-progress');
    if (!progressContainer) {
        progressContainer = document.createElement('div');
        progressContainer.className = 'cooking-progress';
        progressContainer.innerHTML = `
            <div class="progress-bar"></div>
            <div class="progress-text">Cooking...</div>
        `;
        document.getElementById('cookingArea').appendChild(progressContainer);
    }

    // Show and animate progress bar
    setTimeout(() => {
        progressContainer.classList.add('active');
        const progressBar = progressContainer.querySelector('.progress-bar');
        progressBar.style.width = '100%';
    }, 100);

    // After animation completes, check recipe and clean up
    setTimeout(() => {
        progressContainer.classList.remove('active');
        setTimeout(() => {
            progressContainer.remove();
            checkRecipe();
        }, 300);
    }, 2100);
}

function addIngredient(ingredient) {
    if (currentIngredients.length < 2) {
        currentIngredients.push(ingredient);
        
        const steam = document.querySelector('.steam');
        steam.classList.add('active');
        setTimeout(() => steam.classList.remove('active'), 1000);
        
        updateCurrentIngredientsDisplay();
        
        if (currentIngredients.length === 2) {
            startCookingProgress();
        }
    }
}

function checkRecipe() {
    const mainIngredientIndex = currentIngredients.findIndex(isMainIngredient);
    
    if (mainIngredientIndex === -1) {
        // No primary ingredient found
        showFailureMessage("Missing primary ingredient! (Beans, Flour, Broth, or Mana)");
        currentIngredients = [];
        updateCurrentIngredientsDisplay(); // Add this line
        return;
    }
    
    const mainIngredient = currentIngredients[mainIngredientIndex];
    const secondaryIngredient = currentIngredients[1 - mainIngredientIndex];
    
    // Get the codes for both ingredients
    const mainCode = recipes.main[mainIngredient].code;
    const secondaryCode = recipes.secondary[secondaryIngredient];
    
    // Create the recipe code by combining secondary + main (e.g. "1A")
    const recipeCode = secondaryCode + mainCode;
    const recipeCategory = recipes.main[mainIngredient].type;
    
    // Look up the recipe by its code
    const recipeName = recipes.combinations[recipeCategory]?.[recipeCode];
    
    if (recipeName && !discoveredRecipes.has(recipeName)) {
        discoverRecipe({
            name: recipeName,
            category: recipeCategory
        });
        
        // Check if 5 recipes are discovered (changed from all recipes)
        if (discoveredRecipes.size === 5) {
            setTimeout(() => {
                showFifiStory(0);
            }, 1000);
        }
    } else {
        showFailureMessage("These ingredients don't work together!");
    }
    
    currentIngredients = [];
    updateCurrentIngredientsDisplay(); // Add this line
}

function showFifiStory(index) {
    if (index >= fifiStoryPanels.length) {
        return;
    }

    const panel = document.createElement('div');
    panel.className = 'story-panel';
    
    const content = document.createElement('div');
    content.className = 'panel-content';
    
    const imageContainer = document.createElement('div');
    imageContainer.className = 'panel-image';
    
    const img = document.createElement('img');
    img.src = fifiStoryPanels[index].image;
    img.style.width = '100%';
    img.style.height = '100%';
    img.style.objectFit = 'cover';
    img.style.borderRadius = '50%';
    imageContainer.appendChild(img);
    
    const text = document.createElement('p');
    text.className = 'panel-text';
    text.textContent = fifiStoryPanels[index].text;
    
    const button = document.createElement('button');
    button.className = 'next-button';
    button.textContent = index === fifiStoryPanels.length - 1 ? 'Continue Cooking' : 'Next';
    
    button.addEventListener('click', () => {
        panel.remove();
        if (index < fifiStoryPanels.length - 1) {
            showFifiStory(index + 1);
        }
    });
    
    content.appendChild(imageContainer);
    content.appendChild(text);
    content.appendChild(button);
    panel.appendChild(content);
    document.body.appendChild(panel);
}

function discoverRecipe(recipe) {
    discoveredRecipes.add(recipe.name);
    const recipeElement = document.getElementById(`recipe-${recipe.name}`);
    if (recipeElement) {
        recipeElement.innerHTML = `
            <span>${recipe.name}</span>
            <span class="recipe-category">${recipe.category}</span>
        `;
        
        recipeElement.style.animation = 'none';
        recipeElement.offsetHeight; // Trigger reflow
        recipeElement.style.animation = 'recipeReveal 0.5s forwards';
    }

    // Check recipe count and trigger appropriate story
    const recipeCount = discoveredRecipes.size;
    if (recipeCount === 10) {
        setTimeout(() => showStoryChapter(finalStoryChapters.chapter3), 1000);
    } else if (recipeCount === 15) {
        setTimeout(() => showStoryChapter(finalStoryChapters.chapter4), 1000);
    } else if (recipeCount === 20) {
        setTimeout(() => showStoryChapter(finalStoryChapters.chapter5), 1000);
    }
}

// Add new function to show story chapters
function showStoryChapter(chapterPanels, index = 0) {
    if (index >= chapterPanels.length) {
        return;
    }

    const panel = document.createElement('div');
    panel.className = 'story-panel';
    
    const content = document.createElement('div');
    content.className = 'panel-content';
    
    const imageContainer = document.createElement('div');
    imageContainer.className = 'panel-image';
    
    const img = document.createElement('img');
    img.src = chapterPanels[index].image;
    img.style.width = '100%';
    img.style.height = '100%';
    img.style.objectFit = 'cover';
    img.style.borderRadius = '50%';
    imageContainer.appendChild(img);
    
    const text = document.createElement('p');
    text.className = 'panel-text';
    text.textContent = chapterPanels[index].text;
    
    const button = document.createElement('button');
    button.className = 'next-button';
    button.textContent = index === chapterPanels.length - 1 ? 'Continue' : 'Next';
    
    button.addEventListener('click', () => {
        panel.remove();
        if (index < chapterPanels.length - 1) {
            showStoryChapter(chapterPanels, index + 1);
        }
    });
    
    content.appendChild(imageContainer);
    content.appendChild(text);
    content.appendChild(button);
    panel.appendChild(content);
    document.body.appendChild(panel);
}

function initRecipeBook() {
    const container = document.getElementById('discoveredRecipes');
    container.innerHTML = '<h2>📖 Recipe Book</h2>';

    // Create an array of all possible recipes
    const allRecipes = [
        { name: '☕ Stonespear Cappuccino', category: 'Coffees', discovered: false },
        { name: '🔥 The Devil\'s Brew', category: 'Coffees', discovered: false },
        { name: '☀️ Wakeup Call', category: 'Coffees', discovered: false },
        { name: '📚 Necronomicup', category: 'Coffees', discovered: false },
        { name: '🎵 Lo-fi Tea', category: 'Coffees', discovered: false },
        { name: '🫧 Misty Bubble Tea', category: 'Smoothies', discovered: false },
        { name: '⚡ Gigawatt Shake', category: 'Smoothies', discovered: false },
        { name: '💃 Dancer\'s Delight', category: 'Smoothies', discovered: false },
        { name: '👅 Tongue Twister', category: 'Smoothies', discovered: false },
        { name: '🦕 Fossilized Milkshake', category: 'Smoothies', discovered: false },
        { name: '🌒 Cream of Eclipse Soup', category: 'Stews', discovered: false },
        { name: '🌊 Ocean\'s Potluck', category: 'Stews', discovered: false },
        { name: '🕳️ The Deep End', category: 'Stews', discovered: false },
        { name: '⚔️ The Warrior\'s Special', category: 'Stews', discovered: false },
        { name: '🌟 Cream of the Crop', category: 'Stews', discovered: false },
        { name: '💎 Crystalized Pie', category: 'Pies', discovered: false },
        { name: '❄️ Chilly Cheesecake', category: 'Pies', discovered: false },
        { name: '🐉 Dragon Scale Surprise', category: 'Pies', discovered: false },
        { name: '✨ Shimmering Icecream Cake', category: 'Pies', discovered: false },
        { name: '🍯 Ever-changing Honey Pie', category: 'Pies', discovered: false }
    ];

    // Add each recipe to the book
    allRecipes.forEach(recipe => {
        const div = document.createElement('div');
        div.className = 'recipe';
        div.id = `recipe-${recipe.name}`;
        div.innerHTML = `
            <span>${recipe.discovered ? recipe.name : '??? Unknown Recipe ???'}</span>
            <span class="recipe-category">${recipe.discovered ? recipe.category : '???'}</span>
        `;
        container.appendChild(div);
    });
}

function showFailureMessage(message) {
    const cookingArea = document.getElementById('cookingArea');
    const failureMsg = document.createElement('div');
    failureMsg.className = 'failure-message';
    failureMsg.textContent = message;
    cookingArea.appendChild(failureMsg);
    
    setTimeout(() => failureMsg.remove(), 2000);
}

function initIngredientBag() {
    const bag = document.getElementById('ingredientBag');
    const grid = document.getElementById('ingredientsGrid');
    
    bag.addEventListener('click', () => {
        // Find an empty cell
        const cells = Array.from(grid.children);
        const emptyCell = cells.find(cell => !cell.dataset.ingredient);
        
        if (emptyCell) {
            // Select random ingredient
            const randomIngredient = ingredients[Math.floor(Math.random() * ingredients.length)];
            
            // Add to cell
            emptyCell.innerHTML = `<img src="${randomIngredient.image}" alt="${randomIngredient.name}">`;
            emptyCell.dataset.ingredient = randomIngredient.name;
            emptyCell.draggable = true;
            
            // Add magical effect
            bag.classList.add('bag-glow');
            setTimeout(() => bag.classList.remove('bag-glow'), 1000);
        }
    });
    
    // Add initial glow to draw attention to the bag
    setTimeout(() => {
        bag.classList.add('bag-glow');
        setTimeout(() => bag.classList.remove('bag-glow'), 2000);
    }, 1000);
}

function initDictionary() {
    const toggle = document.querySelector('.dictionary-toggle');
    const sidebar = document.querySelector('.dictionary-sidebar');
    const ingredientList = document.getElementById('ingredientList');
    
    toggle.addEventListener('click', () => {
        sidebar.classList.toggle('open');
        toggle.textContent = sidebar.classList.contains('open') ? '❌ Close' : '📖 Dictionary';
    });
    
    ingredients.forEach(ingredient => {
        const entry = document.createElement('div');
        entry.className = 'ingredient-entry';
        entry.innerHTML = `
            <div class="ingredient-info">
                <img src="${ingredient.image}" alt="${ingredient.name}" class="ingredient-image">
                <span class="ingredient-name">${ingredient.name}</span>
            </div>
        `;
        ingredientList.appendChild(entry);
    });
}

// Add this function after the initDictionary function
function initThoughtsPanel() {
    const toggle = document.querySelector('.thoughts-toggle');
    const panel = document.querySelector('.thoughts-panel');
    const hintButton = panel.querySelector('.hint-button');
    const speechBubble = panel.querySelector('.speech-bubble');

    // Array of possible hints
    const hints = [
        "I think I recall hearing about a sweet drink that makes you feel like you're floating high above the clouds... I bet Fifi would love something that reminds her of home!",
        "Fifi always loved taking photos of the sunset! I heard rumors that a certain stew that tastes of that feeling of seeing the stars slowly appearing in the night sky..."
    ];

    toggle.addEventListener('click', () => {
        panel.classList.toggle('open');
        toggle.textContent = panel.classList.contains('open') ? '❌ Close' : '💭 Fidwick\'s Thoughts';
    });

    hintButton.addEventListener('click', () => {
        // Hide any existing speech bubble
        speechBubble.style.display = 'none';
        
        // Select a random hint
        const randomHint = hints[Math.floor(Math.random() * hints.length)];
        
        // Update and show the speech bubble
        speechBubble.textContent = randomHint;
        speechBubble.style.display = 'block';
        
        // Trigger reflow to restart animation
        speechBubble.style.animation = 'none';
        speechBubble.offsetHeight;
        speechBubble.style.animation = 'bubbleFadeIn 0.3s ease-out';
    });
}

function initStorybook() {
    const toggle = document.querySelector('.storybook-toggle');
    const panel = document.querySelector('.storybook-panel');
    const chaptersContainer = document.getElementById('storyChapters');
    
    // Track which stories have been seen
    const seenStories = {
        intro: true, // Always available
        fifi: false,  // Unlocked after 5 recipes
        chapter3: false, // Unlocked after 10 recipes
        chapter4: false, // Unlocked after 15 recipes
        chapter5: false  // Unlocked after 20 recipes
    };
    
    toggle.addEventListener('click', () => {
        panel.classList.toggle('open');
        toggle.textContent = panel.classList.contains('open') ? '❌ Close' : '📚 Storybook';
    });
    
    const chapters = [
        {
            id: 'intro',
            title: "Amelie's Discovery",
            description: "The story of how Amelie found her magical Wishing Bag",
            panels: storyPanels
        },
        {
            id: 'fifi',
            title: "The Traveling Photographer",
            description: "The story of Fifi Fiddlemin and Amelie's growing feelings",
            panels: fifiStoryPanels
        },
        {
            id: 'chapter3',
            title: "Talking to a Mirror",
            description: "Strange reactions from strangers when Amelie talks to Fifi",
            panels: finalStoryChapters.chapter3
        },
        {
            id: 'chapter4',
            title: "Pieced Together",
            description: "Amelie's doubts and realizations",
            panels: finalStoryChapters.chapter4
        },
        {
            id: 'chapter5',
            title: "Amelie's Last Goodbye",
            description: "The final farewell",
            panels: finalStoryChapters.chapter5
        }
    ];
    
    function updateChapters() {
        chaptersContainer.innerHTML = '';
        chapters.forEach(chapter => {
            // Set the fifi story to be available after 5 recipes
            if (chapter.id === 'fifi' && discoveredRecipes.size >= 5) {
                seenStories.fifi = true;
            }
            
            const chapterElement = document.createElement('div');
            chapterElement.className = `story-chapter ${seenStories[chapter.id] ? '' : 'locked'}`;
            
            chapterElement.innerHTML = `
                <div class="story-chapter-title">${chapter.title}</div>
                <div class="story-chapter-description">
                    ${seenStories[chapter.id] ? chapter.description : '🔒 Complete more recipes to unlock this story!'}
                </div>
            `;
            
            if (seenStories[chapter.id]) {
                chapterElement.addEventListener('click', () => {
                    panel.classList.remove('open');
                    if (chapter.id === 'intro') {
                        showStoryPanel(0);
                    } else if (chapter.id === 'fifi') {
                        showFifiStory(0);
                    } else {
                        showStoryChapter(chapter.panels);
                    }
                });
            }
            
            chaptersContainer.appendChild(chapterElement);
        });
    }
    
    // Update seenStories when all recipes are discovered
    const originalShowFifiStory = window.showFifiStory;
    window.showFifiStory = function(index) {
        seenStories.fifi = true;
        updateChapters();
        originalShowFifiStory(index);
    };
    
    // Update seenStories when specific chapter conditions are met
    function discoverRecipe(recipe) {
        discoveredRecipes.add(recipe.name);
        const recipeElement = document.getElementById(`recipe-${recipe.name}`);
        if (recipeElement) {
            recipeElement.innerHTML = `
                <span>${recipe.name}</span>
                <span class="recipe-category">${recipe.category}</span>
            `;
            
            recipeElement.style.animation = 'none';
            recipeElement.offsetHeight; // Trigger reflow
            recipeElement.style.animation = 'recipeReveal 0.5s forwards';
        }
    
        // Check recipe count and trigger appropriate story
        const recipeCount = discoveredRecipes.size;
        if (recipeCount === 10) {
            seenStories.chapter3 = true;
            updateChapters();
            setTimeout(() => showStoryChapter(finalStoryChapters.chapter3), 1000);
        } else if (recipeCount === 15) {
            seenStories.chapter4 = true;
            updateChapters();
            setTimeout(() => showStoryChapter(finalStoryChapters.chapter4), 1000);
        } else if (recipeCount === 20) {
            seenStories.chapter5 = true;
            updateChapters();
            setTimeout(() => showStoryChapter(finalStoryChapters.chapter5), 1000);
        }
    }
    
    updateChapters();
}

window.addEventListener('DOMContentLoaded', () => {
    initGrid();
    initIngredientBag();
    initPot();
    initRecipeBook();
    initDictionary();
    initThoughtsPanel(); // Add this line
    initStorybook(); // Add this line
    updateCurrentIngredientsDisplay();
    showStoryPanel(0);
});
</script>
</body></html>
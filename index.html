<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Physics Playground</title>
  <link rel="stylesheet" href="style.css">
  <!-- Add Matter.js script first -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
  <!-- Then add our modules -->
  <script type="module" src="js/main.js"></script>
</head>
<body>
  <!-- Add audio element for menu music with preload -->
  <audio id="menuMusic" loop preload="auto">
    <source src="MENU OST  MELON PLAYGROUND 24.5.mp3" type="audio/mpeg">
  </audio>

  <div id="main-menu" class="main-menu">
    <div class="grid-background"></div>
    <div class="menu-options">
      <div class="menu-item" data-action="play">play</div>
      <div class="menu-item" data-action="settings">settings</div>
      <div class="menu-item" data-action="mods">mods</div>
      <div class="menu-item" data-action="legacy">legacy version</div>
      <div class="menu-item" data-action="changelog">changelog</div>
    </div>
    <div class="game-logo">
      Physics Playground <span class="remake-tag">[remake]</span>
      <div class="version-number">v164</div>
    </div>
  </div>

  <!-- Add changelog menu -->
  <div class="changelog-menu">
    <div class="changelog-content">
      <div class="changelog-header">
        <h2>Changelog</h2>
        <button class="close-changelog">×</button>
      </div>
      <div class="changelog-entries">
        <div class="changelog-entry">
          <div class="version">v164</div>
          <ul>
            <li>Added advanced console debugger for better error tracking</li>
            <li>Improved pause menu with People Playground style</li>
            <li>Added animated grid background to main menu</li>
            <li>Fixed music autoplay issues</li>
            <li>Added detailed map previews</li>
            <li>Fixed various game initialization errors</li>
            <li>Enhanced map environment effects</li>
            <li>Improved game stability and performance</li>
          </ul>
        </div>
        <div class="changelog-entry">
          <div class="version">v1.41</div>
          <ul>
            <li>Added playable maps</li>
            <li>Enabled City Streets environment with working traffic systems</li>
            <li>Added Laboratory map with experimental equipment</li>
            <li>Added Factory map with working machines</li>
            <li>Added Space Station map with zero gravity</li>
            <li>Added Ancient Ruins map with interactive mechanisms</li>
            <li>Added Underwater Lab with fluid dynamics</li>
            <li>Added Desert Ruins with dynamic sand physics</li>
          </ul>
        </div>
        <div class="changelog-entry">
          <div class="version">v1.40</div>
          <ul>
            <li>Added new detailed maps</li>
            <li>Added Factory map with working machinery</li>
            <li>Added Space Station map with zero gravity</li>
            <li>Added Underwater Lab map with fluid physics</li>
            <li>Added Desert Ruins map with sand physics</li>
            <li>Improved map selection interface</li>
          </ul>
        </div>
        <div class="changelog-entry">
          <div class="version">v1.38</div>
          <ul>
            <li>Added version number display</li>
            <li>Updated changelog system</li>
            <li>Fixed version numbering</li>
          </ul>
        </div>
        <div class="changelog-entry">
          <div class="version">v1.37</div>
          <ul>
            <li>Added menu music</li>
            <li>Added changelog feature</li>
            <li>Added mods system beta notification</li>
          </ul>
        </div>
        <div class="changelog-entry">
          <div class="version">v1.36</div>
          <ul>
            <li>Added new spring rope with wave animation</li>
            <li>Improved magic wire effects with rainbow colors</li>
            <li>Added collision remover rope feature</li>
            <li>Enhanced motor connections with magic wires</li>
            <li>Added new objects and tools</li>
          </ul>
        </div>
        <div class="changelog-entry">
          <div class="version">v0.01</div>
          <ul>
            <li>Initial release</li>
            <li>Basic physics playground functionality</li>
            <li>Object creation and manipulation</li>
            <li>Ragdoll physics system</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <div class="settings-menu">
    <div class="settings-header">
      <div class="settings-title">settings</div>
      <button class="close-settings">×</button>
    </div>
    <div class="settings-content">
      <div class="setting-item">
        <label>slow motion</label>
        <label class="toggle-switch">
          <input type="checkbox" data-setting="slowMotion">
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="setting-item">
        <label>physics iterations</label>
        <input type="range" min="1" max="10" data-setting="physicsIterations">
      </div>
      <div class="setting-item">
        <label>auto-save</label>
        <select data-setting="autoSave">
          <option value="never">never</option>
          <option value="5">5 minutes</option>
          <option value="10">10 minutes</option>
        </select>
      </div>
      <div class="setting-item">
        <label>gore level</label>
        <select data-setting="goreLevel">
          <option value="low">low</option>
          <option value="medium">medium</option>
          <option value="high">high</option>
        </select>
      </div>
      <div class="setting-item">
        <label>blood effects</label>
        <label class="toggle-switch">
          <input type="checkbox" data-setting="bloodEffects">
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="setting-item">
        <label>master volume</label>
        <input type="range" min="0" max="100" data-setting="masterVolume">
      </div>
      <div class="setting-item">
        <label>effects volume</label>
        <input type="range" min="0" max="100" data-setting="sfxVolume">
      </div>
      <div class="setting-item">
        <label>music</label>
        <label class="toggle-switch">
          <input type="checkbox" data-setting="musicEnabled">
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="setting-item">
        <label>graphics quality</label>
        <select data-setting="graphicsQuality">
          <option value="low">low</option>
          <option value="medium">medium</option>
          <option value="high">high</option>
        </select>
      </div>
      <div class="setting-item">
        <label>lighting</label>
        <label class="toggle-switch">
          <input type="checkbox" data-setting="lightingEffects">
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="setting-item">
        <label>particles</label>
        <input type="range" min="0" max="100" data-setting="particleEffects">
      </div>
      <div class="setting-item">
        <label>fps limit</label>
        <input type="range" min="30" max="240" step="30" data-setting="fpsCap">
      </div>
      <div class="setting-item">
        <label>resolution scale</label>
        <input type="range" min="50" max="100" data-setting="resolutionScale">
      </div>
      <div class="setting-item">
        <label>vsync</label>
        <label class="toggle-switch">
          <input type="checkbox" data-setting="vsync">
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="setting-item">
        <label>weather</label>
        <label class="toggle-switch">
          <input type="checkbox" data-setting="weatherEffects">
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="setting-item">
        <label>gravity</label>
        <input type="range" min="0" max="2" step="0.1" data-setting="gravity">
      </div>
    </div>
    <button class="reset-button">reset to defaults</button>
  </div>

  <div id="game-view" class="game-view hidden">
    <div class="grid-background"></div>
    
    <!-- Left panel for object selection -->
    <div class="object-panel">
      <div class="search-container">
        <input type="text" id="filter" placeholder="Search objects...">
      </div>
      <div class="categories">
        <div class="category">
          <h3>Characters</h3>
          <div class="object-list">
            <div class="object-item" data-type="human">
              <img src="icons/human.svg" class="object-icon" alt="Human">
              <span class="object-label">Human</span>
            </div>
            <div class="object-item" data-type="android">
              <img src="icons/android.svg" class="object-icon" alt="Android">
              <span class="object-label">Android</span>
            </div>
          </div>
        </div>
        <div class="category">
          <h3>Basic Shapes</h3>
          <div class="object-list">
            <div class="object-item" data-type="box">
              <img src="icons/box.svg" class="object-icon" alt="Box">
              <span class="object-label">Box</span>
            </div>
            <div class="object-item" data-type="ball">
              <img src="icons/ball.svg" class="object-icon" alt="Ball">
              <span class="object-label">Ball</span>
            </div>
            <div class="object-item" data-type="triangle">
              <img src="icons/triangle.svg" class="object-icon" alt="Triangle">
              <span class="object-label">Triangle</span>
            </div>
            <div class="object-item" data-type="hexagon">
              <img src="icons/hexagon.svg" class="object-icon" alt="Hexagon">
              <span class="object-label">Hexagon</span>
            </div>
            <div class="object-item" data-type="star">
              <img src="icons/star.svg" class="object-icon" alt="Star">
              <span class="object-label">Star</span>
            </div>
          </div>
        </div>
        <div class="category">
          <h3>Building</h3>
          <div class="object-list">
            <div class="object-item" data-type="plank">
              <img src="icons/plank.svg" class="object-icon" alt="Plank">
              <span class="object-label">Plank</span>
            </div>
            <div class="object-item" data-type="platform">
              <img src="icons/platform.svg" class="object-icon" alt="Platform">
              <span class="object-label">Platform</span>
            </div>
            <div class="object-item" data-type="wall">
              <img src="icons/wall.svg" class="object-icon" alt="Wall">
              <span class="object-label">Wall</span>
            </div>
          </div>
        </div>
        <div class="category">
          <h3>Mechanisms</h3>
          <div class="object-list">
            <div class="object-item" data-type="wheel">
              <img src="icons/wheel.svg" class="object-icon" alt="Wheel">
              <span class="object-label">Wheel</span>
            </div>
            <div class="object-item" data-type="spring">
              <img src="icons/spring.svg" class="object-icon" alt="Spring">
              <span class="object-label">Spring</span>
            </div>
            <div class="object-item" data-type="fan">
              <img src="icons/fan.svg" class="object-icon" alt="Fan">
              <span class="object-label">Fan</span>
            </div>
          </div>
        </div>
        <div class="category">
          <h3>Constraints</h3>
          <div class="object-list">
            <div class="object-item" data-type="chain">
              <img src="icons/chain.svg" class="object-icon" alt="Chain">
              <span class="object-label">Chain</span>
            </div>
            <div class="object-item" data-type="pendulum">
              <img src="icons/pendulum.svg" class="object-icon" alt="Pendulum">
              <span class="object-label">Pendulum</span>
            </div>
          </div>
        </div>
        <div class="category">
          <h3>Weapons</h3>
          <div class="object-list">
            <div class="object-item" data-type="gun">
              <img src="icons/gun.svg" class="object-icon" alt="Gun">
              <span class="object-label">Gun</span>
            </div>
            <div class="object-item" data-type="explosive">
              <img src="icons/explosive.svg" class="object-icon" alt="Explosive">
              <span class="object-label">Explosive</span>
            </div>
            <div class="object-item" data-type="mine">
              <img src="icons/mine.svg" class="object-icon" alt="Mine">
              <span class="object-label">Mine</span>
            </div>
          </div>
        </div>
        <div class="category">
          <h3>Machines</h3>
          <div class="object-list">
            <div class="object-item" data-type="motor">
              <img src="icons/motor.svg" class="object-icon" alt="Motor">
              <span class="object-label">Motor</span>
            </div>
            <div class="object-item" data-type="generator">
              <img src="icons/generator.svg" class="object-icon" alt="Generator">
              <span class="object-label">Generator</span>
            </div>
            <div class="object-item" data-type="gear">
              <img src="icons/gear.svg" class="object-icon" alt="Gear">
              <span class="object-label">Gear</span>
            </div>
          </div>
        </div>
        <div class="category">
          <h3>Interactive</h3>
          <div class="object-list">
            <div class="object-item" data-type="button">
              <img src="icons/button.svg" class="object-icon" alt="Button">
              <span class="object-label">Button</span>
            </div>
            <div class="object-item" data-type="slider">
              <img src="icons/slider.svg" class="object-icon" alt="Slider">
              <span class="object-label">Slider</span>
            </div>
            <div class="object-item" data-type="lever">
              <img src="icons/lever.svg" class="object-icon" alt="Lever">
              <span class="object-label">Lever</span>
            </div>
          </div>
        </div>
      </div>
      <div class="clear-controls">
        <button class="clear-btn" data-clear="fire">Clear Fire</button>
        <button class="clear-btn" data-clear="debris">Clear Debris</button>
        <button class="clear-btn" data-clear="dead">Clear Dead</button>
        <button class="clear-btn" data-clear="living">Clear Living</button>
        <button class="clear-btn" data-clear="all">Clear Everything</button>
      </div>
    </div>

    <!-- Main canvas workspace -->
    <canvas id="sandbox"></canvas>

    <!-- Right toolbar -->
    <div class="toolbar">
      <div class="tool" data-tool="select">Select</div>
      <div class="tool" data-tool="connect">Connect</div>
      <div class="tool" data-tool="destroy">Destroy</div>
      <div class="tool" data-tool="laser">Laser</div>
      <div class="tool" data-tool="explosion">Explosion</div>
    </div>

    <!-- Pause button -->
    <button class="pause-button">Pause</button>

    <!-- Performance stats -->
    <div class="performance-stats">
      <span id="fps">FPS: 60</span>
      <span id="objects">Objects: 0</span>
    </div>
    <div class="selected-object">
      <span id="selected-object-label"></span>
      <span class="key-hint">[E]</span>
    </div>
  </div>

  <!-- Update pause menu -->
  <div id="pauseMenu" class="pause-menu">
    <div class="pause-menu-content">
      <h2>Paused</h2>
      <button id="resumeButton">Resume Game</button>
      <div class="menu-separator"></div>
      <button id="restartButton">Restart Map</button>
      <button id="settingsButton">Settings</button>
      <div class="menu-separator"></div>
      <button id="mainMenuButton">Return to Menu</button>
      <button id="quitButton">Quit Game</button>
    </div>
  </div>

  <button id="fullscreenButton" class="fullscreen-button">
    <svg viewBox="0 0 24 24" width="24" height="24">
      <path fill="currentColor" d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
    </svg>
  </button>

  <script>
    function spawnRandomObjects() {
      const menu = document.getElementById('main-menu');
      if (!menu) return;

      const menuRect = menu.getBoundingClientRect();
      const objects = [];
      const objectTypes = ['box', 'ball'];

      function spawnObject() {
        const type = objectTypes[Math.floor(Math.random() * objectTypes.length)];
        const x = Math.random() * (menuRect.width - 40) + menuRect.left + 20;
        const y = -50;

        const object = document.createElement('div'); 
        object.style.position = 'absolute';
        object.style.left = x + 'px';
        object.style.top = y + 'px';
        object.className = `menu-object ${type}`;

        menu.appendChild(object);
        objects.push({
          element: object,
          x,
          y,
          velY: 0,
          type
        });
      }

      function update() {
        const gravity = 0.5;
        const groundY = menuRect.bottom - 40;

        for (let i = objects.length - 1; i >= 0; i--) {
          const obj = objects[i];
          obj.velY += gravity;
          obj.y += obj.velY;

          if (obj.y > groundY) {
            // Create explosion effect
            const explosion = document.createElement('div');
            explosion.className = 'explosion';
            explosion.style.left = obj.x + 'px';
            explosion.style.top = groundY + 'px';
            menu.appendChild(explosion);

            // Remove original object
            obj.element.remove();
            objects.splice(i, 1);

            setTimeout(() => {
              explosion.remove();
            }, 500);

            continue;
          }

          obj.element.style.top = obj.y + 'px';
          
          // Add slight rotation based on velocity
          const rotation = Math.min(30, Math.abs(obj.velY) * 5);
          obj.element.style.transform = `rotate(${rotation}deg)`;
        }

        requestAnimationFrame(update);
      }

      // Spawn new object every 2 seconds
      setInterval(spawnObject, 2000);
      
      // Start animation
      update();
    }

    // Initialize menu music and animations with better audio handling
    document.addEventListener('DOMContentLoaded', () => {
      spawnRandomObjects();
      
      // Initialize audio with better autoplay handling
      const menuMusic = document.getElementById('menuMusic');
      if (menuMusic) {
        menuMusic.volume = 0.5;
        
        // Create AudioContext for more reliable autoplay
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioContext = new AudioContext();
        
        // Create media element source
        const source = audioContext.createMediaElementSource(menuMusic);
        source.connect(audioContext.destination);

        // Function to handle playback
        const startPlayback = async () => {
          try {
            await audioContext.resume();
            await menuMusic.play();
          } catch (error) {
            console.log("Audio playback initiated via user interaction");
          }
        };

        // Start playback immediately
        startPlayback();

        // Backup play attempt on window load
        window.addEventListener('load', startPlayback);
        
        // Additional backup play attempts
        document.addEventListener('click', startPlayback, { once: true });
        document.addEventListener('keydown', startPlayback, { once: true });
      }
    });

    // Stop music when leaving menu
    document.querySelector('[data-action="play"]').addEventListener('click', () => {
      const menuMusic = document.getElementById('menuMusic');
      if (menuMusic) {
        menuMusic.pause();
      }
    });

    // Resume music when returning to menu 
    document.querySelector('[data-action="mainMenu"]')?.addEventListener('click', () => {
      const menuMusic = document.getElementById('menuMusic');
      if (menuMusic && menuMusic.paused) {
        menuMusic.play().catch(console.log);
      }
    });
  </script>
</body>
</html>